/**********************************\*\*\*\*********************************** \*

-   ADOBE CONFIDENTIAL
-   ***
-
-   Copyright 2015-2021 Adobe Systems Incorporated
-   All Rights Reserved.
-
-   NOTICE: All information contained herein is, and remains
-   the property of Adobe Systems Incorporated and its suppliers,
-   if any. The intellectual and technical concepts contained
-   herein are proprietary to Adobe Systems Incorporated and its
-   suppliers and are protected by trade secret or copyright law.
-   Dissemination of this information or reproduction of this material
-   is strictly forbidden unless prior written permission is obtained
-   from Adobe Systems Incorporated.
    ************************************\*\*************************************/

!function(t){var e={};function a(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,a),r.l=!0,r.exports}a.m=t,a.c=e,a.d=function(t,e,s){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(a.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)a.d(s,r,function(e){return t[e]}.bind(null,r));return s},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="",a(a.s=40)}([function(t,e,a){"use strict";a.r(e);var s=a(9),r=a(26),i=a(23),o=a(5);function n(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}const c=new class{constructor(){n(this,"config",{ENVIRONMENT:"production",ACTIVE_VERSIONS:["V1","V2","V2_5","V2_8","V3_0","V3_1","V4_0"],SUPPORTED_ACTIVE_VERSIONS:5,SETTINGS_FILE:"settings.json",SETTINGS_FILE_VERSION:3,LOOKUP_MAP_FILE:"map.json",ASSETS_DIRNAME:"assets",CC_SETTINGS_FILE:"C3Config.xml",CONSOLE_LOGGING:!1,SCOPES:"openid,AdobeID",SYNC_INITIAL_RETRY:24e4,KILLED_BEFORE_RESPONSE_INITIAL_RETRY:1e3,MAX_LOG_SIZE:5242880,PROXY_REQUEST_TIMEOUT:2e3,CLIENT_REQUEST_TIMEOUT:9e5,USER_ANALYTICS__REQUEST_TIMEOUT:2e3,GET_NOTIFICATION_DATA_TIMEOUT:2e3,NETWORK_STATUS_INTERVAL:1e3,NETWORK_MAX_LATENCY:3e3,NETWORK_MAX_SOCKETS:1,NETWORK_MAX_LATENCY_RETRIES:20,NETWORK_MINIMUM_PARTIAL_SIZE:524288,STOP_SYNCING_BEYOND:6048e5,HEALTH_POLL_INTERVAL:864e5,CPU_POLL_DURATION:6e4,DEFAULT_MEMOIZE_TIMEOUT:6e4,MAX_BACK_OFF:18e5,RETRYABLE_ERRORS:["ECONNRESET","ETIMEDOUT","ECONNREFUSED","LOCAL_RETRY","ERR_SSL_DECRYPTION_FAILED_OR_BAD_RECORD_MAC"],EMBARGO_BACK_OFF:20736e5,RETRYABLE_DEFAULT_ATTEMPTS:8,AVATAR:{LOG_PREFIX:"Avatar"},GLOBAL_BACKOFF_SYNC_THROTTLE:1e4,ONLINE_SYNC_THROTTLE:1e4,LEARN_DEFAULT_EXPIRATION:2592e5,ASSET_DEFAULT_EXPIRATION:2592e5,KILLSWITCH_MEMOIZE_TIMEOUT:864e5,TEMP_KILL_SWITCH_REGISTRY_KEY:"\\SOFTWARE\\Policies\\Adobe\\CCXProcess",TEMP_KILL_SWITCH_PLIST_PATH:"/Library/Preferences/com.adobe.CCXProcess.plist",TEMP_DEFAULT_TEMPLATES_DOWNLOADED:100,TEMP_STOCK_TEMPLATE_DOWNLOAD_LIMIT_REGISTRY_SETTING:"TempStockDownloadLimit",TEMP_CCD_CONTENT_DOWNLOAD_REGISTRY_SETTING:"TempCCDContentDownloadDisabled",TEMP_CCD_CONTENT_DOWNLOAD_DISABLED:!1,TEMP_SENSEI_MODELS_CONTENT_DOWNLOAD_REGISTRY_SETTING:"TempSenseiModelContentDownloadDisabled",TEMP_SENSEI_MODELS_CONTENT_DOWNLOAD_DISABLED:!1,TEMP_NETWORK_STATUS_REGISTRY_SETTING:"TempNetworkStatusDisabled",TEMP_NETWORK_STATUS_DISABLED:!1,LAUNCH_AGENT:`${process.env.HOME}/Library/LaunchAgents/com.adobe.ccxprocess.plist`,LAUNCH_DIRECTORY:`${process.env.HOME}/Library/LaunchAgents/`,NGL_INITIALIZE_TIMEOUT:3e5,TIER_1_LOCALES:["en_US","fr_FR","de_DE","ja_JP","ko_KR"],SUPPORTED_LOCALES:["cs_CZ","da_DK","de_DE","en_US","en_AE","en_GB","en_IL","es_ES","es_MX","fi_FI","fr_FR","fr_CA","fr_MA","hu_HU","it_IT","ja_JP","ko_KR","nb_NO","nl_NL","pl_PL","pt_BR","ru_RU","sv_SE","tr_TR","uk_UA","zh_CN","zh_TW"],DOWNLOAD_ASSET_TIMEOUT:6e4,DNS_CACHE_DURATION:24e4,MAX_EPERM_RENAMES:10,NUM_CONCURRENT_REQUESTS:10,MIN_RANDOMIZED_TIME:1e3,MAX_RANDOMIZED_TIME:9e5,MAX_RANDOMIZED_TIME_SHORT:3e4,TIME_FOR_SHORT_RANDOMIZE:36e5,MAX_TIMEOUT:Math.pow(2,31)-1,MIN_TIMEOUT:36e6,TRIAL_DAYS:7,PRODUCT_ALIASES:{PHSP:"PHXS",PHSPPR:"PHXS",PHSPBETA:"PHXS",PPROBETA:"PPRO",AEFTBETA:"AEFT",IDSNBETA:"IDSN",IDSNPR:"IDSN",FLPRBETA:"FLPR",FLPRPR:"FLPR",SPRKDV:"SPRK",SPRKPR:"SPRK",KCCC:"ACCC",ILSTBETA:"ILST",ILSTPR:"ILST"},PRODUCT_LIST:["PHXS","IDSN","PPRO","ILST","AEFT","MUSE","DRWV","FLPR","SPRK"],IGNORED_FILES_REGEXP:"\\bassets\\b",NODE_AID_RESPONSE_SCHEMA:{id:"NODE_AID_RESPONSE",type:"object",properties:{ProductsInfo:{type:"object",properties:{ProductInfo:{type:"array",items:{type:"object",properties:{SAPCode:{type:"array",items:{type:"string"}},CodexVersion:{type:"array",items:{type:"string"}},Platform:{type:"array",items:{type:"string"}},InstallerType:{type:"array",items:{type:"string"}},IsUWPProduct:{type:"array",items:{type:"string"}},InstallLanguage:{type:"array",items:{type:"string"}},DisplayName:{type:"array",items:{type:"string"}},BuildVersion:{type:"array",items:{type:"string"}},LaunchString:{type:"array",items:{type:"string"}}}}}}}}},MAP_DATA_SCHEMA:{id:"MAP_DATA",type:"object",properties:{versionInfo:{type:"object"},metadata:{type:"object"},assetMetadata:{type:"object"},version:{type:"number"}},required:["versionInfo","metadata","assetMetadata","version"]},CARDS_CONTROL_SCHEMA:{id:"/CARDS_CONTROL",type:"object",properties:{modeID:{type:["string","null"]},cardOrder:{type:["array","null"],items:{type:"number"}}},required:["modeID","cardOrder"]},FIRST_MILE_RESPONSE_SCHEMA:{id:"/SOPHIA_RESPONSE",type:"object",properties:{analyticsData:{type:"object",properties:{responseGUID:{type:"string"}}},surfaces:{type:"object",additionalProperties:{type:"object",properties:{containers:{type:"array",items:{type:"object",properties:{data:{type:"string",dataType:"string"},containerAnalyticsData:{type:"object"}}}},surfaceAnalyticsData:{type:"object",properties:{surfaceId:{type:"string"}}}}}},expirationDTS:{type:"string"}},required:["expirationDTS"]},CARDS_DATA_SCHEMA:{V1:{id:"CARDS_DATA",type:"object",properties:{cards:{type:"array"},expirationDTS:{type:"string"},cardControl:{type:"array",items:{$ref:"/CARDS_CONTROL"}},version:{type:"number"}},required:["expirationDTS","cards","cardControl"]},V2:{id:"CARDS_DATA",type:"object",properties:{cards:{type:"array"},expirationDTS:{type:"string"},cardControl:{type:"array",items:{$ref:"/CARDS_CONTROL"}},version:{type:"number"}},required:["expirationDTS","cards","cardControl"]},V2_5:{id:"CARDS_DATA",type:"object",properties:{cards:{type:"array"},expirationDTS:{type:"string"},cardControl:{type:"array",items:{$ref:"/CARDS_CONTROL"}},version:{type:"number"}},required:["expirationDTS","cards","cardControl"]},V2_8:{id:"/SOPHIA_RESPONSE",type:"object",properties:{surfaces:{type:"object"},expirationDTS:{type:"string"},version:{type:"number"}},required:["expirationDTS","surfaces"]},V3_0:{id:"/SOPHIA_RESPONSE",type:"object",properties:{surfaces:{type:"object"},expirationDTS:{type:"string"},version:{type:"number"}},required:["expirationDTS","surfaces"]},V3_1:{id:"/SOPHIA_RESPONSE",type:"object",properties:{surfaces:{type:"object"},expirationDTS:{type:"string"},version:{type:"number"}},required:["expirationDTS","surfaces"]},V4_0:{id:"/SOPHIA_RESPONSE",type:"object",properties:{surfaces:{type:"object"},expirationDTS:{type:"string"},version:{type:"number"}},required:["expirationDTS","surfaces"]}},STOCK_TEMPLATES_DATA_SCHEMA:{id:"STOCK_TEMPLATES_DATA",type:"object",properties:{templates:{type:"array"},expirationDTS:{type:"string"},nb_results:{type:"number"}},required:["expirationDTS"]},VULCAN_PREFIX:"vulcan.SuiteMessage.",VULCAN_STARTUP_MESSAGE:"ccxprocess.Initialized",VULCAN_PING_REQUEST:"ccxprocess.in.request.app.ping",VULCAN_PING_RESPONSE:"ccxprocess.out.response.app.ping",VULCAN_PSDK_FEED_REQUEST:"ccxprocess.PSDKFeedRequest",VULCAN_PSDK_FEED_RESPONSE:"ccxprocess.PSDKFeedResponse",VULCAN_PSDK_FEED_BROADCAST:"ccxprocess.PSDKFeedBroadcast",VULCAN_LEARN_REQUEST:"ccxprocess.LearnRequest",VULCAN_LEARN_RESPONSE:"ccxprocess.LearnResponse",VULCAN_LEARN_USAGE_MARKER:"ccxprocess.LearnUsageMarker",VULCAN_LEARN_BROADCAST:"ccxprocess.LearnBroadcast",VULCAN_GET_USER_REQUEST:"ccxprocess.GetUserRequest",VULCAN_GET_USER_RESPONSE:"ccxprocess.GetUserResponse",VULCAN_START_SETTINGS_REQUEST:"ccxprocess.StartSettingsRequest",VULCAN_START_SETTINGS_GET_REQUEST:"ccxprocess.StartSettingsGetRequest",VULCAN_START_SETTINGS_GET_RESPONSE:"ccxprocess.StartSettingsGetResponse",VULCAN_START_SETTINGS_PATCH_UPDATE:"ccxprocess.StartSettingsPatchUpdate",VULCAN_STOCK_REQUEST:"ccxprocess.StockTemplateRequest",VULCAN_STOCK_RESPONSE:"ccxprocess.StockTemplateResponse",VULCAN_CC_PHOTO_DOWNLOAD_REQUEST:"ccxprocess.CCPhotoDownloadRequest",VULCAN_CC_PHOTO_DOWNLOAD_RESPONSE:"ccxprocess.CCPhotoDownloadResponse",VULCAN_CC_PHOTO_DOWNLOAD_PROGRESS:"ccxprocess.CCPhotoDownloadProgress",VULCAN_CC_PHOTO_DOWNLOAD_ERROR:"ccxprocess.CCPhotoDownloadError",VULCAN_AVATAR_REQUEST:"ccxprocess.UserAvatarRequest",VULCAN_AVATAR_RESPONSE:"ccxprocess.UserAvatarResponse",SKIP_LOGGING_MESSAGE_LIST:["ccxprocess.in.request.app.ping","ccxprocess.out.response.app.ping"],SKIP_LOGGING_MESSAGE_CONTENT:["ccxprocess.in.request.app.ping","ccxprocess.out.response.app.ping","adbproduct.app.UserContextDataResponse","accc.app.ProxySettingsResponse","any.accc.app.UserContextData"],NOTIFICATION_REQUEST:"accc.notifications",NOTIFICATION_PSDK_RESPONSE:"ccxprocess.notification.psdk",NOTIFICATION_STOCK_RESPONSE:"ccxprocess.notification.stock",NOTIFICATION_FORCE_REFRESH_RESPONSE:"ccxprocess.notification.force-refresh",NOTIFICATION_PSDK_QUERY_DATA_BY_ID_RESPONSE:"ccxprocess.notification.psdk.byID.data",NOTIFICATION_STOCK_QUERY_DATA_BY_ID_RESPONSE:"ccxprocess.notification.stock.byID.data",NOTIFICATION_PSDK_QUERY_DATA_BY_TIME_RESPONSE:"ccxprocess.notification.psdk.byTime.data",NOTIFICATION_STOCK_QUERY_DATA_BY_TIME_RESPONSE:"ccxprocess.notification.stock.byTime.data",NOTIFICATION_FORCE_REFRESH_QUERY_DATA_BY_TIME_RESPONSE:"ccxprocess.notification.force-refresh.byTime.data",ANS_PSDK_NOTIFICATION_TYPE:"com.adobe.psdk.v1",ANS_PSDK_NOTIFICATION_SUB_TYPE:"operational.profile.updated",ANS_STOCK_NOTIFICATION_TYPE:"com.adobe.stock",ANS_STOCK_NOTIFICATION_SUB_TYPE:"templates.update",ANS_FORCE_REFRESH_NOTIFICATION_TYPE:"com.adobe.accc.generic.v1",ANS_FORCE_REFRESH_NOTIFICATION_SUB_TYPE:"esdk.force.refresh",ANS_NUJ_REFRESH_NOTIFICATION_TYPE:"com.adobe.dunamis",ANS_NUJ_REFRESH_NOTIFICATION_SUB_TYPE:"profile.state.change",USER_ANALYTICS_ENABLED:!1,ANALYTICS_INGEST_PATH:"/ingest",ANALYTICS_X_PRODUCT:"CCXStart/2.5",ANALYTICS_PROJECT:"ccx-process-service",ANALYTICS_INGEST_TYPE:"dunamis",ANALYTICS_API_KEY:"ccx-process-service",ANALYTICS_MAX_QUEUED_EVENTS:600,ANALYTICS_DEBOUNCE:1e4,ALLOW_NO_TOKEN:!0,ANALYTICS_HEARTBEAT_INTERVAL:9e5,UNSUPPORTED_WINDOWS_UXP_APPS:["PHXS","ILST","SPRK","IDSN","PPRO","AEFT"],EARLIEST_SUPPORTED_WINDOWS_VERSION_UXP:"6.2",SUPPORTED_LEARN_THIRD_PARTY_START_MIN_VERSION:"2.7",LEARN_DATA_SCHEMA:{id:"/LEARN_CARD_DATA",type:"object",properties:{tutorials:{type:"array",items:{type:"object",properties:{metadata:{type:"object",properties:{images:{type:"object",properties:{hero:{type:"string"},thumbnail:{type:"string"}}}}}}}}}},CARD_DATA_SCHEMA:{v2:{id:"/CARD_DATA",type:"object",properties:{cardType:{type:"string"},cardName:{type:"string"},displayTemplate:{type:"string"},backgroundImage:{type:["string","null"]},backgroundImageLocalPath:{type:["string","null"]},backgroundFillColor:{type:["string","null"]},startDTS:{type:["string","null"]},endDTS:{type:["string","null"]},overlayTintColor:{type:["string","null"]}},required:["cardType"]},openDoc:{},firstrun:{},footer:{},learn:{},discover:{},trial:{},welcome:{}},PRODUCT_PRIORITY:{PHXS:9,ILST:8,IDSN:7,PPRO:6,AEFT:5,SPRK:4,DRWV:3,FLPR:2,MUSE:1},DEFAULT:{LOOKUP_MAP_FILE_VERSION:2,URL_STAGING:"https://p13n-stage.adobe.io/psdk/v2/content",URL_PRODUCTION:"https://p13n.adobe.io/psdk/v2/content",SUPPORTED_PRODUCTS:{},LOOKUP_COLLECTION_FILE_VERSION:1,PRIORITY_CHANNEL:o.PriorityChannels.Unknown},OZ:{LOG_PREFIX:"Oz"},V1:{VERSION_LESS_THAN:"2.0",START_VERSION:"1.0",FIRST_MILE_PREFETCH_CLIENTS:{AEFT:"15.0",DRWV:"18.0",IDSN:"13.0",ILST:"22.0",MUSE:"2018.0",PHXS:"19.0",PPRO:"12.0"},FIRST_MILE_SURFACE_ID:["welcome","openDoc"],FIRST_MILE_SURFACE_MODE_MAP:{openDoc:"openDoc",welcome:"welcome"}},V2:{VERSION_LESS_THAN:"2.4",START_VERSION:"2.2.1.120",FIRST_MILE_PREFETCH_CLIENTS:{AEFT:"16.0",DRWV:"19.0",IDSN:"14.0",ILST:"23.0",MUSE:"2019.0",PHXS:"20.0",PPRO:"13.0"},FIRST_MILE_SURFACE_ID:["CCX_Start_2.0_FirstRun","CCX_Start_2.0_Footer","CCX_Start_2.0_Learn","CCX_Start_2.0_Discover","CCX_Start_2.0_Trial"],FIRST_MILE_SURFACE_MODE_MAP:{"CCX_Start_2.0_FirstRun":"firstrun","CCX_Start_2.0_Footer":"footer","CCX_Start_2.0_Learn":"learn","CCX_Start_2.0_Discover":"discover","CCX_Start_2.0_Trial":"trial"}},V2_4:{VERSION_LESS_THAN:"2.5",START_VERSION:"2.4.0.11",FIRST_MILE_SURFACE_ID:["CCX_TUTORIAL_2.5","CCX_Start_2.5_Learn","CCX_Start_2.5_Toast","CCX_Start_2.5_Home"],FIRST_MILE_SURFACE_MODE_MAP:{"CCX_TUTORIAL_2.5":"CCX_TUTORIAL_2.5","CCX_Start_2.5_Learn":"CCX_Start_2.5_Learn","CCX_Start_2.5_Home":"CCX_Start_2.5_Home","CCX_Start_2.5_Toast":"CCX_Start_2.5_Toast"},FIRST_MILE_PREFETCH_CLIENTS:{AEFT:"16.0",DRWV:"19.0",IDSN:"14.0",ILST:"23.0",MUSE:"2019.0",PHXS:"20.0",PPRO:"13.0"},HOME_SURFACE_ID:"CCX_Start_2.5_Home",LEARN_SURFACE_ID:"CCX_TUTORIAL_2.5"},V2_5:{VERSION_LESS_THAN:"2.8",START_VERSION:"2.7.2.14",FIRST_MILE_PREFETCH_CLIENTS:{AEFT:"16.99",DRWV:"99.99",IDSN:"14.99",ILST:"23.99",MUSE:"2019.99",PHXS:"20.99",PPRO:"13.99"},FIRST_MILE_SURFACE_ID:["CCX_Start_2.5_Learn","CCX_Start_2.5_Toast","CCX_Start_2.5_Home"],FIRST_MILE_SURFACE_MODE_MAP:{"CCX_TUTORIAL_2.5":"CCX_TUTORIAL_2.5","CCX_Start_2.5_Learn":"CCX_Start_2.5_Learn","CCX_Start_2.5_Home":"CCX_Start_2.5_Home","CCX_Start_2.5_Toast":"CCX_Start_2.5_Toast"},HOME_SURFACE_ID:"CCX_Start_2.5_Home",LEARN_SURFACE_ID:"CCX_TUTORIAL_2.5"},V2_8:{VERSION_LESS_THAN:"3.0",START_VERSION:"2.16.0.8",FIRST_MILE_PREFETCH_CLIENTS:{AEFT:"18.0",IDSN:"15.99",ILST:"24.0",MUSE:"2099.0",PHXS:"21.0",PPRO:"14.4"},FIRST_MILE_SURFACE_ID:["CCX_Start_3.1_Learn","CCX_Start_3.1_Toast","CCX_Start_3.1_Home","CCX_Start_3.1_Whats_New"],FIRST_MILE_SURFACE_MODE_MAP:{"CCX_Start_3.1_Tutorials":"CCX_Start_3.1_Tutorials","CCX_Start_3.1_Learn":"CCX_Start_3.1_Learn","CCX_Start_3.1_Home":"CCX_Start_3.1_Home","CCX_Start_3.1_Toast":"CCX_Start_3.1_Toast","CCX_Start_3.1_Whats_New":"CCX_Start_3.1_Whats_New"},HOME_SURFACE_ID:"CCX_Start_3.1_Home",LEARN_SURFACE_ID:"CCX_Start_3.1_Tutorials"},V3_0:{VERSION_LESS_THAN:"3.1",START_VERSION:"3.0.4",FIRST_MILE_PREFETCH_CLIENTS:{FLPR:"20.0",ILST:"24.0",PHXS:"21.0"},FIRST_MILE_SURFACE_ID:["CCX_Start_3.0_Learn","CCX_Start_3.0_Toast","CCX_Start_3.0_Home"],FIRST_MILE_SURFACE_MODE_MAP:{"CCX_Start_3.0_Tutorials":"CCX_Start_3.0_Tutorials","CCX_Start_3.0_Learn":"CCX_Start_3.0_Learn","CCX_Start_3.0_Home":"CCX_Start_3.0_Home","CCX_Start_3.0_Toast":"CCX_Start_3.0_Toast"},HOME_SURFACE_ID:"CCX_Start_3.0_Home",LEARN_SURFACE_ID:"CCX_Start_3.0_Tutorials"},V3_1:{VERSION_LESS_THAN:"4.0",START_VERSION:"3.8.0.28",FIRST_MILE_PREFETCH_CLIENTS:{FLPR:"21.0.3",PHXS:"22.2",ILST:"25.2",SPRK:"38.0",IDSN:"16.1",PPRO:"14.9"},FIRST_MILE_SURFACE_ID:["CCX_Start_3.1_Learn","CCX_Start_3.1_Toast","CCX_Start_3.1_Home","CCX_Start_3.1_Whats_New"],FIRST_MILE_SURFACE_MODE_MAP:{"CCX_Start_3.1_Tutorials":"CCX_Start_3.1_Tutorials","CCX_Start_3.1_Learn":"CCX_Start_3.1_Learn","CCX_Start_3.1_Home":"CCX_Start_3.1_Home","CCX_Start_3.1_Toast":"CCX_Start_3.1_Toast","CCX_Start_3.1_Whats_New":"CCX_Start_3.1_Whats_New"},HOME_SURFACE_ID:"CCX_Start_3.1_Home",LEARN_SURFACE_ID:"CCX_Start_3.1_Tutorials"},V4_0:{VERSION_LESS_THAN:"99.9",START_VERSION:"4.2.0.21",FIRST_MILE_PREFETCH_CLIENTS:{FLPR:"99.0",ILST:"99.0",PHXS:"99.0",SPRK:"99.0",PPRO:"99.0",IDSN:"99.0",AEFT:"99.0"},FIRST_MILE_SURFACE_ID:["CCX_Start_4.0_Toast","CCX_Start_4.0_Home","CCX_Start_4.0_Whats_New"],FIRST_MILE_SURFACE_MODE_MAP:{"CCX_Start_3.1_Tutorials":"CCX_Start_3.1_Tutorials","CCX_Start_4.0_Home":"CCX_Start_4.0_Home","CCX_Start_4.0_Toast":"CCX_Start_4.0_Toast","CCX_Start_4.0_Whats_New":"CCX_Start_4.0_Whats_New"},HOME_SURFACE_ID:"CCX_Start_4.0_Home",LEARN_SURFACE_ID:"CCX_Start_3.1_Tutorials"},ANALYTICS:{w_CCX_PROCESS:"CCX Process",w_NOTIFICATION:"Notification",w_INTERNAL:"Internal",c_DESKTOP:"DESKTOP",SOPHIA_CARDS:"Sophia Cards",UTUTS:"Ututs",sc_CUSTOM_HOOK:"CustomHook.ts",sc_PROCESS:"Process",sc_SOPHIA:"Sophia",sc_STOCK:"Stock",sc_LEARN:"Learn",sc_CCX_START:"CCX Start",sc_CC_PHOTO:"CC Photo",sc_LR_CONTENT:"Lightroom Content",sc_CC_SEARCH:"CC Search",sc_OZ:"Oz",sc_CC_SEARCH_STORAGE:"CC Storage",sc_UTUTS:"Ututs",sc_LCM:"LCM",sc_AUTH:"Auth",sc_AVATAR:"Avatar",sc_FORCE_REFRESH:"Force Refresh",sc_CCX_FILE_DOWNLOAD:"CCX Start File Download",sc_PULSE:"Pulse",t_INSTALL:"install",t_UNINSTALL:"uninstall",t_UPDATE:"update",t_INIT:"init",t_START:"start",t_REQUEST:"request",t_RESPONSE:"response",t_SIGNOUT:"signout",t_SIGNIN:"signin",t_FETCH:"fetch",t_CLEAR:"clear",t_PERFORMANCE:"performance",t_APP:"app",st_PROCESS:"process",st_API:"api",st_ANS:"ans",st_CC_PHOTOS:"cc photos",st_NETWORK:"network",st_CLIENT:"client",st_TOKEN:"token",st_RECEIVED:"received",st_FINISHED:"finished",st_RUNNING:"running",ERROR:"error",NO_ERROR:null,PARAM_VALIDATION_ERR:"Param Validation Error",PAYLOAD_PARSE_FAIL:"Fail to parse payload",UNEXPECTED_ANS_MSG:"Received unexpected ANS message",PARSE_MSG_FAIL:"Fail to parse message",GET_NOTIFICATION_DATA:"Get Notification Data By ID",DATA_VALIDATION_ERR:"Data Validation Error",GC_ERROR:"GC Error",NETWORK_ERR:"Network Error",IO_ERR:"I/O Error",LR_PHOTO_DOWNLOAD_ERR:"Lightroom Photo Download Error",NO_DATA:"No data to save",NO_STOCK_PARAMS:"No Stock Params",MISSING_DATA:"Missing Data",SIGNED_OUT:"User Signed Out",OFFLINE_ERROR:"Offline",INVALID_JSON:"Invalid JSON"},ON_DEMAND_REQUEST_SCHEMA:{id:"/ON_DEMAND_REQUEST_SCHEMA",type:"object",properties:{params:{type:"object"},requestId:{type:"string"},version:{type:"integer",maximum:1,minimum:1},force:{type:"object",properties:{type:{type:"string",pattern:"stale|always|none"},depth:{type:"integer",minimum:0,maximum:2}}},analytics:{type:"object"},required:["version","params","requestId"]}},ON_DEMAND_LIST_REQUEST_SCHEMA:{id:"/ON_DEMAND_LIST_REQUEST_SCHEMA",type:"object",properties:{params:{type:"object"},requestId:{type:"string"},version:{type:"integer",maximum:1,minimum:1},required:["version","params","requestId"]}},SERVICE_REQUEST_SCHEMA:{id:"/SERVICE_REQUEST_SCHEMA",type:"object",properties:{params:{type:"object"},requestId:{type:"string"},version:{type:"integer",maximum:1,minimum:1},displayed:{type:"string"},urgent:{type:"boolean"},updateLastUseTime:{type:"boolean"},force:{type:"object",properties:{type:{type:"string",pattern:"stale|always|none"},depth:{type:"integer",minimum:0,maximum:2}}},analytics:{type:"object"},required:["version","params","requestId"]}},FORCE_REFRESH_SCHEMA:{id:"/FORCE_REFRESH_SCHEMA",type:"object",properties:{expire:{type:"object",properties:{FIRST_MILE:{type:["boolean","array"]},STOCK:{type:["boolean","array"]},LEARN:{type:["boolean","array"]},CCD:{type:["boolean","array"]}}},force:{type:"object",properties:{type:{type:"string",pattern:"stale|always|none"},depth:{type:"integer",minimum:0,maximum:2}}}}},CC_DIR:"",ROOT_DIR:"",LOG_DIR:"",DOWNLOAD_TMP_EXTENSION:"",PROGRESS_THROTTLE_INTERVAL:0,TMP_PHOTOS_DOWNLOAD_DIRECTORY:"",STOCK_API_PATH:"",STOCK_API_ROOT:"",CC_SEARCH_IDENTIFIER:"ccsearch-component-service",CC_TOUT_DOWNLOAD_IDENTIFIER:"ccxstart-download-file"}),n(this,"environments",{staging:{LABEL:"Staging",CLIENT_NAME:"CCXProcess1",CLIENT_ID:"CCXInAppWelcomeProcess3",CLIENT_SECRET:"83a83b87-bf88-42fa-a863-c124d241faef",IMS:"ims-na1-stg1.adobelogin.com",UTUTS_SERVICE:"https://utut-service.stage.adobe.com/api/ututs",PROFILE_URL:"https://ab-stg.adobe-identity.com/api/avatars/50"},production:{LABEL:"Production",CLIENT_NAME:"CCXProcess1",CLIENT_ID:"CCXInAppWelcomeProcess3",CLIENT_SECRET:"b2127a37-dcff-4d4e-8817-c755a4eff119",IMS:"ims-na1.adobelogin.com",UTUTS_SERVICE:"https://utut-service.adobe.com/api/ututs",PROFILE_URL:"https://ab.adobe-identity.com/api/avatars/50"}}),n(this,"settings",{SETTINGS_FILE_VERSION:this.config.SETTINGS_FILE_VERSION}),n(this,"currentDiskState",void 0),n(this,"analytics",this.get("ANALYTICS")),this.init()}init(){if(this.isPlatformWindows()){const t=process.env.USERPROFILE.replace(/\\/g,"/");this.config.ROOT_DIR=`${t}/AppData/Roaming/`,this.config.LOG_DIR=`${process.env.TEMP.replace(/\\/g,"/")}/CreativeCloud/CCX Welcome/`;const e=`${this.isArm()?process.env.ProgramFiles:process.env["ProgramFiles(x86)"]}`.replace(/\\/g,"/");this.config.CC_DIR=`${e}/Adobe/Adobe Creative Cloud/`}else this.config.ROOT_DIR=`${process.env.HOME}/Library/Caches/`,this.config.LOG_DIR=`${process.env.HOME}/Library/Logs/CreativeCloud/CCX Welcome/`,this.config.CC_DIR="/Applications/Utilities/Adobe Creative Cloud/";let t=!1;this.isStagingRedirectInEffect()&&(this.config.ENVIRONMENT="staging",t=!0),this.config.ROOT_DIR+="Adobe/CCX Welcome/"+(t?"stage/":""),this.config.LOG_DIR+=t?"stage/":"",this.config.STOCK_API_ROOT=`/Rest/Media/${this.config.STOCK_API_VERSION}`,this.config.STOCK_API_PATH=`${this.config.STOCK_API_ROOT}/Search/Templates`,this.config.TMP_PHOTOS_DOWNLOAD_DIRECTORY="com.adobe.ccx.start.lrphotos/",this.config.PROGRESS_THROTTLE_INTERVAL=250,this.config.DOWNLOAD_TMP_EXTENSION=".tmp",["openDoc","firstrun","footer","learn","discover","trial","welcome"].forEach(t=>{this.config.CARD_DATA_SCHEMA[t]=this.config.CARD_DATA_SCHEMA.v2}),this.loadSettings(),process.argv.forEach(t=>{"--debug"===t&&(this.config.CONSOLE_LOGGING=!0)}),this.config.CONSOLE_LOGGING||global.test||(console.log(`Outputting logs to: ${this.config.LOG_DIR}`),console.log("To view log messages on the console, use the --debug argument"))}isPlatformWindows(){return 0===process.platform.indexOf("win")}isArm(){return 0===process.arch.indexOf("arm")}get(t,e){return e?this.settings[e]&&void 0!==this.settings[e][t]?this.settings[e][t]:this.config[e]&&this.config[e][t]:void 0!==this.settings[t]?this.settings[t]:this.config[t]}set(t,e,a){return a?(this.settings[a]=this.settings[a]||{},this.settings[a][t]=e):this.settings[t]=e,this.saveSettings()}default(t){const e=t.LABEL.toLowerCase().replace(/^\w/,t=>t.toUpperCase());return t.ANALYTICS_SUBCATEGORY=t.ANALYTICS_SUBCATEGORY||e,t.LOG_PREFIX=t.LOG_PREFIX||e,t.DIR=t.DIR||e.toLowerCase()+"/",t.VULCAN_TYPE=t.VULCAN_TYPE||e,t}patch(t,e){this.config[t]=this.config[t]||{};const a=Object.assign({},this.config[t]);Object.assign(this.config[t],this.config.DEFAULT,a,e),this.default(this.config[t])}getEnvironment(){const t=this.get("ENVIRONMENT");return this.environments[t]||this.environments[this.config.ENVIRONMENT]}isStagingRedirectInEffect(){let t=!1;try{const e=r.readFileSync(this.config.CC_DIR+this.config.CC_SETTINGS_FILE,"utf8");new i.Parser({async:!1}).parseString(e,(e,a)=>{e||a.C3Config.config[0].namespace.forEach(e=>{e&&e.$&&e.$.name&&"accc.container"===e.$.name&&e.property.forEach(e=>{e&&e.$&&e.$.name&&"IMS_ENV"===e.$.name&&"STG"===e._&&(t=!0)})})})}catch(t){}return t}loadSettings(){try{const t="readFileSync";this.currentDiskState=r[t](this.config.ROOT_DIR+this.config.SETTINGS_FILE,"utf8");const e=JSON.parse(this.currentDiskState);this.settings.SETTINGS_FILE_VERSION===e.SETTINGS_FILE_VERSION&&(this.settings=e)}catch(t){}}saveSettings(){const t=JSON.stringify(this.settings,void 0,2);if(t===this.currentDiskState)return!1;try{const e=`${this.config.SETTINGS_FILE}.TEMP_${s.v4()}`;r.writeFileSync(this.config.ROOT_DIR+e,t),r.renameSync(this.config.ROOT_DIR+e,this.config.ROOT_DIR+this.config.SETTINGS_FILE),this.currentDiskState=t}catch(t){}return!0}};e.default=c},function(t,e,a){"use strict";a.r(e);var s=a(28),r=a(6),i=a(3),o=a(11),n=a(23),c=a(0),d=a(33),l=a(2);function u(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}const p=new class{constructor(){u(this,"memoize",(t,{resolver:e,refresher:a,wrapper:s,timeout:r=c.default.get("DEFAULT_MEMOIZE_TIMEOUT"),destructor:i=(()=>!0)}={})=>{const o=this,n=function(){const c=arguments,d=e?e.apply(this,c):c[0],l=n.cacheTimeout.get(d);if(l&&clearTimeout(l),r>0&&n.cacheTimeout.set(d,setTimeout(function t(){n.cache.get(d)&&(i(d,n.cache.get(d))?n.cache.delete(d):n.cacheTimeout.set(d,setTimeout(t,r)))},r)),n.cache.has(d)){const t=n.cache.get(d);if(!a||!a(t))return s?s(c,t,!0):t}const u=t.apply(this,c);return u instanceof Promise&&o.enablePromiseStateAccess(u),n.cache.set(d,u),s?s(c,u,!1):u};return n.cache=new Map,n.cacheTimeout=new Map,n}),u(this,"throttle",(t,e=250)=>{let a,s;return function(){const r=this,i=(new Date).getTime(),o=arguments;a&&i<a+e?(clearTimeout(s),s=setTimeout(()=>{a=i,t.apply(r,o)},e)):(a=i,t.apply(r,o))}}),u(this,"setTimeoutAsync",t=>new Promise(e=>setTimeout(e,t)))}getTimeToExpiry(t){if(!t)return 0;const e=(new Date).valueOf(),a=new Date(t).valueOf()-e;return isNaN(a)?0:Math.max(0,a)}enablePromiseStateAccess(t){t.state="pending",t.then(e=>{t.state="resolved",t.value=e},e=>{t.state="rejected",t.value=e})}isDateExpired(t){return 0===this.getTimeToExpiry(t)}getHumanReadableTime(t){const e=t/36e5,a=t/6e4%60,s=t/1e3%60;return e>1?e.toFixed(2)+" hr":a>1?a.toFixed(2)+" min":s>1?s.toFixed(2)+" s":t+" ms"}getRandomizedTime(t=!1){const e=c.default.get("MIN_RANDOMIZED_TIME"),a=t?c.default.get("MAX_RANDOMIZED_TIME_SHORT"):c.default.get("MAX_RANDOMIZED_TIME");return Math.floor(Math.random()*(a-e))+e}validateDataFields(t,e,a=null){const s=new d.Validator;a&&a.forEach(t=>{s.addSchema(t,t.id)});const r=s.validate(t,e);return 0===r.errors.length?null:r.errors}async parseXml(t){return await new Promise(async(e,a)=>{n.parseString(t,(t,s)=>{t?a(t):e(s)})})}getProductAlias(t){const e=c.default.get("PRODUCT_ALIASES");return e&&e[t]||t}getProcessVersion(){return`${s.version}-1`}isWindows(){return"win32"===process.platform}getOsVersion(){return o.release()}getOsPlatform(){let t=this.isWindows()?"win":"mac";return"arm64"===o.arch()||!p.isWindows()&&a(45).isRosetta?t+="arm64":t+="64",t}getClientContentVersion(t,e){return c.default.get("ACTIVE_VERSIONS",e).find(a=>{const s=c.default.get(a,e).PREFETCH_CLIENTS[t.productCode];return 1===p.compareMajorMinorVersions(t.productVersion,s)})||"V1"}ccxVersionToString(t={ccxVersion:""}){let e=t.ccxVersion;return t.ccxVersion?c.default.get("ACTIVE_VERSIONS").find(t=>{const a=c.default.get("VERSION_LESS_THAN",t);return-1===this.compareMajorMinorVersions(a,e)})||"V1":(e=c.default.get("ACTIVE_VERSIONS").filter(e=>{if(!t.productCode||!t.productVersion)return!1;const a=c.default.get("FIRST_MILE_PREFETCH_CLIENTS",e)[t.productCode];return!(!a||1===this.compareMajorMinorVersions(a,t.productVersion))})[0])||"V1"}retryLocalErrors(t,e=c.default.get("RETRYABLE_DEFAULT_ATTEMPTS")){return async function(a){let s=0,r=null,i=null;do{r=null,i=await t(a).catch(t=>{if(!c.default.get("RETRYABLE_ERRORS").includes(null==t?void 0:t.code))throw t;r=t,this.log.disk(`Retry-able error present. Retrying ${s+1}. Underlying error ${t}`)})}while(++s<e&&r);if(r)throw new l.default("LOCAL_NETWORK_ERROR_RETRY_FAILED",r);return i}}sanitizeLocale(t="",e=c.default.get("SUPPORTED_LOCALES")){if(e.includes(t))return t;const a=t.slice(0,2);return e.find(t=>t.slice(0,2)===a)||"en_US"}compareMajorMinorVersions(t,e){if(!t)return 1;if(!e)return-1;let a,s,r,i;try{a=parseInt(t.split(".")[0],10),r=parseInt(t.split(".")[1]||"0",10)}catch(t){return 1}try{s=parseInt(e.split(".")[0],10),i=parseInt(e.split(".")[1]||"0",10)}catch(t){return-1}return a===s&&r===i?0:a<s||a===s&&r<i?1:-1}getClientsThatNeedRefresh(t){const e={};c.default.get("ACTIVE_VERSIONS").forEach(t=>{e[t]={}});const a=t.getCachedRequestData();Object.keys(a).forEach(t=>{Object.keys(a[t]).forEach(s=>{a[t][s].forEach(a=>{const r=this.ccxVersionToString(a),i=c.default.get("FIRST_MILE_PREFETCH_CLIENTS",r)[t];if(!i)return;if(-1!==this.compareMajorMinorVersions(i,s))return;const o=[t,s,a.productLanguage,a.countryCode].join("-");e[r][o]||(e[r][o]=a)})})});const s={};return Object.keys(e).map(t=>{s[t]=Object.values(e[t])}),s}hasBeenUsedRecently(t){if(!t)return!1;const e=new Date(t);return!isNaN(e)&&(e.setMilliseconds(c.default.get("STOP_SYNCING_BEYOND")),e>new Date)}async getDiskSize(t=c.default.get("ROOT_DIR")){const e=await r.readdir(t);return(await p.waitAll(e.map(async e=>{e=i.join(t,e);const a=await r.stat(e).catch(t=>({isFile:()=>!1,size:0,isDirectory:()=>!1}));return a.isFile()?a.size:a.isDirectory()?await this.getDiskSize(e):0}))).reduce((t,e)=>t+e,0)}async deleteTempFiles(t,e=864e5){const a=new Date,s=await r.readdir(t);await p.waitAll(s.map(async s=>{const o=i.join(t,s),n=await r.stat(o);if(!(Number(a)-Number(n.mtime)<e))return await r.unlink(o),`Deleted ${o}`}).map(t=>t.catch(t=>`Error deleting temp file: ${t}`)))}scrubStack(t){return t?(t=t.toString()).replace(/[A-Z]?\:?(\\|\/).*\1/g,"<redacted>").trim():t}async getLocks(t,e,a){return new Promise((s,r)=>{let i=void 0,o=void 0;const n=()=>{t(()=>new Promise(t=>{i=t}))},c=()=>{e(()=>new Promise(t=>{o=t}))},d=()=>{i&&o?a().then(s).catch(r).finally(()=>{i(),o()}):i?(i(),i=void 0,setTimeout(n,10),setTimeout(d,30)):o?(o(),o=void 0,setTimeout(c,10),setTimeout(d,30)):setTimeout(d,20)};setTimeout(d,20),n(),c()})}async waitAll(t){let e=null;const a=await Promise.all(t.map(t=>t.catch(t=>e=e||t)));if(e)throw e;return a}};e.default=p},function(t,e,a){"use strict";a.r(e),a.d(e,"default",function(){return o});var s=a(1),r=a(11);function i(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}class o extends Error{constructor(t,e,a){super(t||"Unknown"),i(this,"underlyingError",void 0),i(this,"error_code",void 0),i(this,"silent",!1),i(this,"context",""),i(this,"headers",void 0),i(this,"payload",{}),e&&(e instanceof o?(this.silent=e.isSilent,this.underlyingError=e,Object.assign(this.payload,e.ingestPayload)):this.underlyingError=e),this.error_code=a||this.underlyingError&&"string"!=typeof this.underlyingError&&this.underlyingError.code||"Unknown"}get code(){return this.error_code}get short(){return this.message+(this.context||"")}get description(){let t=this.context+r.EOL;return this.stack&&(t+=s.default.scrubStack(this.stack)+r.EOL),this.underlyingError&&(t+=" VIA ",this.underlyingError instanceof o?t+=this.underlyingError.message+" "+this.underlyingError.code+r.EOL+this.underlyingError.description+r.EOL:this.underlyingError instanceof Error?t+=this.underlyingError.message+this.underlyingError.code+(this.underlyingError.stack?r.EOL+s.default.scrubStack(this.underlyingError.stack):"")+r.EOL:t+=this.underlyingError),t}get responseHeaders(){return this.headers}get ingestPayload(){return this.payload}setPayload(t){return Object.assign(this.payload,t),this}setResponseHeaders(t){return this.headers=t,this}setContext(t){return this.context+=t,this}toString(){return this.message+this.description}toJSON(){return{desc:this.context,message:this.message,code:this.code}}toSnapshot(){const t=`${this.message}(${this.code}) `;return this.underlyingError instanceof o?t+this.underlyingError.toSnapshot():this.underlyingError instanceof Error?t+this.underlyingError.message+this.underlyingError.code:t+this.underlyingError}silence(){return this.silent=!0,this}get isSilent(){return this.silent}}},function(t,e){t.exports=require("path")},function(t,e,a){"use strict";a.r(e);var s=a(0),r=a(12),i=a(1),o=a(7),n=a(17),c=a(10),d=a(2),l=a(11);function u(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}const p=a(46),_=a(28),f=1e4,h=s.default.getEnvironment(),g=315;e.default=new class extends n.EventEmitter{constructor(){super(),u(this,"log",void 0),u(this,"init",i.default.memoize(()=>new Promise((t,e)=>{const a=setTimeout(()=>{this.log.error(new d.default("NGL initialization timed out")),t()},s.default.get("NGL_INITIALIZE_TIMEOUT")),{userProfile:r}=p.InitializeProfileUpdates(this.nglConfig,(e,r)=>{e&&(403===e?this.log.info("Ignoring 403 from NGL Library"):this.log.error(new d.default("Error from NGL Library "+e)));const i=this.getUserId();this.setUserProfile(r);const n=this.getUserId();this.isInitialized?i&&!n?(this.log.disk("Received Sign out event."),this.log.context({authenticationDisabled:!1}).info(s.default.analytics.t_SIGNOUT),c.default.flush(!0,()=>{this.log.disk("Flushed logs due to user sign out event"),this.reset(),this.emit("SIGN_OUT")})):n!=i&&(o.default.updateBackOff({clear:!0,type:o.BackOffType.AUTH}),this.log.context({authenticationDisabled:!1}).info(s.default.analytics.t_SIGNIN),this.emit("SIGN_IN")):(this.isInitialized=!0,clearTimeout(a),t())});this.setUserProfile(r)}),{timeout:-1})),u(this,"isInitialized",!1),u(this,"userProfile",void 0),u(this,"getDeviceID",i.default.memoize(()=>Object.values(l.networkInterfaces()).map(t=>t[0].mac).find(t=>"00:00:00:00:00:00"!=t))),u(this,"getAccessTokenExpiry",i.default.memoize(t=>{try{const e=JSON.parse(Buffer.from(t.split(".")[1],"base64").toString("utf-8"));return new Date(parseInt(e.created_at)+parseInt(e.expires_in)-f)}catch(e){return t&&this.log.error(e,"Failed parsing access token"),-1}})),u(this,"getAccessToken",i.default.memoize(()=>new Promise(async(t,e)=>{await this.init();const a=this.getUserId();a?o.default.isWaitingForBackOff(o.BackOffType.AUTH)?e(new d.default(`Access Token awaiting global back-off ${o.default.backOffCause(o.BackOffType.AUTH)}`).silence()):(this.log.disk("Started NGL.GetImsAccessToken."),p.GetImsAccessToken(this.nglConfig,(r,i)=>{if(this.log.disk("Finished NGL.GetImsAccessToken."),this.getUserId()!=a)return void e(new d.default("User changed").silence());if(r===g){const t=new Error("Services not provisioned");return this.log.error(t),o.default.updateBackOff({cause:t.message,type:o.BackOffType.AUTH}),e(t)}if(r){const t=`Error from NGL fetching access token: ${r.toString()}`;return this.log.error(new d.default(t,r instanceof Error?r:r.toString())),o.default.updateBackOff({cause:t,type:o.BackOffType.AUTH}),e(new Error(t))}let n={};try{n=JSON.parse(i)}catch(t){const a=new d.default("Cannot parse NGL access token response"+t);return this.log.error(a),o.default.updateBackOff({cause:a.message,type:o.BackOffType.AUTH}),e(a)}if(!n.access_token)return this.log.error(new d.default("No Access Token")),o.default.updateBackOff({cause:"No access token",type:o.BackOffType.AUTH}),e(new d.default("No access token"));this.log.context({authenticationDisabled:!1}).info(s.default.analytics.t_FETCH,"Successfully obtained access token"),o.default.updateBackOff({clear:!0,type:o.BackOffType.AUTH}),t(n.access_token)})):e(new d.default("Not Logged in").silence())}),{refresher:this.checkAccessTokenNeedsRefresh.bind(this),timeout:864e5})),this.log=new r.default({prefix:"IMS > ",payload:{"event.subcategory":s.default.analytics.sc_AUTH,"event.subtype":s.default.analytics.st_TOKEN},authenticationDisabled:!0})}get nglConfig(){const[t,e]=_.version.split(".");return{clientName:h.CLIENT_NAME,clientId:h.CLIENT_ID,clientSecret:h.CLIENT_SECRET,clientScope:s.default.get("SCOPES"),clientVersion:`${t}.${e}`,clientLocale:"en_US",isStage:"Staging"===h.LABEL}}setUserProfile(t){try{const a=this.getUserId();var e;this.userProfile=JSON.parse(t),a!==this.getUserId()&&this.log.disk(`Default User: ${null===(e=this.getUserInfo())||void 0===e?void 0:e.userId}`)}catch(e){this.log.error(new d.default("Unable to parse user profile from NGL"+JSON.stringify(t,(t,e)=>{if("enigmaData"!=t)return"UserProfile"==t?{accountType:e.accountType,countryCode:e.countryCode,userId:e.userId}:e},2)))}}checkAccessTokenNeedsRefresh(t){const e=t.state,a=t.value;return"pending"!==e&&("resolved"!==e||!a||this.getAccessTokenExpiry(a)<new Date)}getUserInfo(){var t;return null===(t=this.userProfile)||void 0===t?void 0:t.UserProfile}getUserId(){var t;return null===(t=this.getUserInfo())||void 0===t?void 0:t.userId}reset(){this.log.info(s.default.analytics.t_CLEAR),this.getAccessToken.cache&&this.getAccessToken.cache.clear()}}},function(t,e,a){"use strict";function s(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}let r,i;a.r(e),a.d(e,"PriorityChannels",function(){return r}),a.d(e,"PriorityLevels",function(){return i}),a.d(e,"Priority",function(){return o}),a.d(e,"default",function(){return c}),function(t){t[t.Unknown=0]="Unknown",t[t.Deprecated=1]="Deprecated",t[t.SenseiModels=2]="SenseiModels",t[t.Stock=3]="Stock",t[t.DiscoverPanel=4]="DiscoverPanel",t[t.FirstMileOld=5]="FirstMileOld",t[t.Lcm=6]="Lcm",t[t.Avatar=7]="Avatar",t[t.Learn=8]="Learn",t[t.CcdQuarternary=9]="CcdQuarternary",t[t.CcdTertiary=10]="CcdTertiary",t[t.CcdSecondary=11]="CcdSecondary",t[t.CcdPrimary=12]="CcdPrimary",t[t.FirstMileLatest=13]="FirstMileLatest"}(r||(r={})),function(t){t[t.Regular=0]="Regular",t[t.BackgroundRequest=1]="BackgroundRequest",t[t.Installation=2]="Installation",t[t.UrgentRequest=3]="UrgentRequest"}(i||(i={}));class o{constructor({key:t="",value:e=0,channel:a=r.Unknown,level:o=i.Regular}={}){s(this,"key",void 0),s(this,"value",void 0),s(this,"channel",void 0),s(this,"level",void 0),this.key=t,this.value=e,this.channel=a,this.level=o}toString(){return 1e3*this.queue+this.value}get queue(){return this.channel+100*this.level}}const n=r.Unknown+100*i.Regular;class c{constructor(t=1,e=108e5){this.maxLocks=t,this.defaultTimeout=e,s(this,"hasWriteLock",!1),s(this,"readsInProgress",[]),s(this,"pendingReads",[]),s(this,"pendingWrites",[]),s(this,"priorityOverrides",{}),s(this,"prioritize",t=>{let{key:e}=t;e&&(this.priorityOverrides[e]=t,c.noTimeout()||setTimeout(()=>{e&&delete this.priorityOverrides[e]},1e4),this.pendingReads.forEach(a=>{a.priority.key===e&&this.applyOverride(t,a.priority)}),this.check())})}async call(t){const e=setTimeout(()=>{t.reject(new Error("Lock Timed out"))},t.timeout);await t.callback().then(a=>{t.resolve(a),clearTimeout(e)}).catch(a=>{t.reject(a),clearTimeout(e)})}async checkReads(){const t=[];if(!this.hasWriteLock&&this.pendingReads.length>0){let e;for(;e=this.nextReadLock();){const a=e,s=this.call(a).then(()=>{this.readsInProgress.splice(this.readsInProgress.indexOf(a),1),this.check()});t.push(s)}}return await Promise.all(t),t.length}nextReadLock(){if(0===this.pendingReads.length)return;const t=this.readsInProgress.length>0&&this.readsInProgress.reduce((t,e)=>t.priority.queue>e.priority.queue?t:e),e=t?t.priority.queue:n,a=this.pendingReads.reduce((t,e)=>t.priority.queue>e.priority.queue?t:e).priority.queue;if(a<e)return;if(a===e){if(this.readsInProgress.filter(t=>t.priority.queue===e).length>=this.maxLocks)return}const s=this.pendingReads.filter(t=>t.priority.queue===a);if(0===s.length)return;const r=s.reduce((t,e)=>e.priority.value>t.priority.value?e:t);return this.pendingReads.splice(this.pendingReads.indexOf(r),1),this.readsInProgress.push(r),r}async check(){for(;0!==await this.checkReads(););if(0===this.readsInProgress.length&&!this.hasWriteLock){const t=this.pendingWrites.shift();t&&(this.hasWriteLock=!0,await this.call(t),this.hasWriteLock=!1,this.check())}}async read(t,e=new o({}),a=this.defaultTimeout){return e.channel=e.channel||r.Unknown,e.level=e.level||i.Regular,e.value=e.value||0,e.key&&this.priorityOverrides[e.key]&&this.applyOverride(this.priorityOverrides[e.key],e),new Promise((s,r)=>{this.pendingReads.push({callback:t,resolve:s,reject:r,priority:e,timeout:a}),this.check()})}async write(t,e=this.defaultTimeout){return new Promise((a,s)=>{this.pendingWrites.push({callback:t,resolve:a,reject:s,timeout:e}),this.check()})}static noTimeout(){return!1}applyOverride(t,e){e.level=Math.max(e.level,t.level)}}},function(t,e){t.exports=require("fs-extra")},function(t,e,a){"use strict";a.r(e),a.d(e,"BackOffType",function(){return n});var s,r=a(17),i=a(0);function o(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}let n;!function(t){t.SYNC="SYNC"}(s||(s={})),function(t){t.AUTH="BackoffAuthentication",t.NETWORK="BackOffNetwork"}(n||(n={}));const c=new class extends r.EventEmitter{constructor(...t){super(...t),o(this,"SYNC",s.SYNC),o(this,"_syncRetryTimeout",null)}isWaitingForBackOff(t){const e=i.default.get("BACK_OFF_EXPIRY",t);return!!(e&&new Date(e)>new Date)}backOffCause(t){return i.default.get("BACK_OFF_CAUSE",t)}backOffWaitTime(t){return i.default.get("BACK_OFF",t)}backOffExpiry(t){return i.default.get("BACK_OFF_EXPIRY",t)}updateBackOff(t={clear:!1,sync:!0,cause:"Unknown",type:n.NETWORK}){const{clear:e=!1,cause:a="Unknown",type:s,sync:r=!0}=t;let o=this.backOffWaitTime(s);if(e)return o&&(i.default.set("BACK_OFF_EXPIRY",void 0,s),i.default.set("BACK_OFF",void 0,s),i.default.set("BACK_OFF_CAUSE",void 0,s)),void(r&&o&&(clearTimeout(this._syncRetryTimeout),this.emit(this.SYNC)));if(!this.isWaitingForBackOff(s)){o?o*=2:o=i.default.get("SYNC_INITIAL_RETRY"),o=Math.min(o,i.default.get("MAX_BACK_OFF")),i.default.set("BACK_OFF",o,s);const t=new Date;t.setMilliseconds(t.getMilliseconds()+o),i.default.set("BACK_OFF_EXPIRY",t.toISOString(),s),i.default.set("BACK_OFF_CAUSE",`${a} for ${o/1e3}s expiring ${t.toISOString()}`,s),clearTimeout(this._syncRetryTimeout),this._syncRetryTimeout=setTimeout(()=>{this.emit(this.SYNC)},this.backOffWaitTime(s))}}};e.default=c},function(t,e,a){"use strict";a.r(e);var s=a(0),r=a(17),i=a(12),o=a(1),n=a(10),c=a(2),d=a(20);function l(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function u(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?l(Object(a),!0).forEach(function(e){p(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function p(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}const _=a(53),f=t=>Object.keys(t).reduce((e,a)=>u(u({},e),{},{[a]:t[a][0]}),{});const h=new class extends r{constructor(){super(),p(this,"log",new i.default({prefix:"VulcanWrapper > "})),p(this,"vulcan",void 0),p(this,"installedApps",{}),p(this,"aidFetched",!1),p(this,"getInstalledApps",o.default.memoize(async()=>{try{if(this.aidFetched)return this.installedApps;const t=await new Promise(async(t,e)=>_.getAllInstalledApps(!1,(a,s)=>{a?e(a):t(s)})),e=await o.default.parseXml(t);if(o.default.validateDataFields(e,s.default.get("NODE_AID_RESPONSE_SCHEMA")))throw new c.default(n.default.DATA_VALIDATION_ERR,`Invalid data: ${JSON.stringify(e)}`);const a=e.ProductsInfo.ProductInfo;return this.installedApps=a.reduce((t,e)=>{const a=f(e);return a.SAPCode=o.default.getProductAlias(a.SAPCode),u(u({},t),{},{[a.SAPCode]:u(u({},t[a.SAPCode]),{},{[a.CodexVersion]:a})})},{}),this.aidFetched=!0,this.installedApps}catch(t){return this.log.error(t),{}}})),p(this,"getAppLanguage",async(t,e)=>{const a=d.getOSLocale(),s=await this.getKeyForApp("InstallLanguage",t,e);if(s&&"mul"!==s){if(s.includes(",")){const t=s.split(",");return t.includes(a)?a:t.includes("en_US")?"en_US":void 0}return s}}),this.log.disk("Loading Vulcan Library...");const t=a(29);this.log.disk("Vulcan Library Successfully Loaded."),this.vulcan=t.createMessageAdapter("CCXP","1.0.0"),this.vulcan.addMessageListener((t,e,a,r)=>{t=t.replace(s.default.get("VULCAN_PREFIX"),""),0!==this.listenerCount(t)&&(this.shouldLogMessage(t)&&this.log.disk(`<- ${a} ${r}: ${t} \n ${this.shouldLogContent(t)?e:""}`.trim()),this.emit(t,e,a,r))})}clearInstalledAppsCache(){this.aidFetched=!1,this.getInstalledApps.cache.clear()}shouldLogMessage(t){const e=s.default.get("SKIP_LOGGING_MESSAGE_LIST");return!e||!e.includes(t)||s.default.get("CONSOLE_LOGGING")}shouldLogContent(t){const e=s.default.get("SKIP_LOGGING_MESSAGE_CONTENT");return!e||!e.includes(t)}sendMessage(t,e="",a="",s=""){const r=a?`${a} ${s||"*"}`:"BROADCAST";"string"!=typeof e&&(e=JSON.stringify(e)),this.shouldLogMessage(t)&&this.log.disk(`-> ${r}: ${t} \n ${this.shouldLogContent(t)?e:""}`.trim()),this.vulcan.sendMessage(t,e,a,s)}async getKeyForApp(t,e,a){var s;return((null===(s=(await this.getInstalledApps())[e])||void 0===s?void 0:s[a])||{})[t]}async getSpecifiers(){return await this.getInstalledApps()}};h.setMaxListeners(20),e.default=h},function(t,e){t.exports=require("uuid")},function(t,e,a){"use strict";a.r(e);var s=a(9),r=a(11),i=a(0),o=a(27),n=a(15),c=a(22),d=a(1),l=a(4),u=a(20),p=a(2);function _(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}global.fetch=a(49);let f=!1;const h=a(50),g={ENVIRONMENT:"Staging"===i.default.getEnvironment().LABEL?"stage":"prod",ANALYTICS_API_KEY:i.default.get("ANALYTICS_API_KEY"),ANALYTICS_X_PRODUCT:i.default.get("ANALYTICS_X_PRODUCT"),ANALYTICS_PROJECT:i.default.get("ANALYTICS_PROJECT"),ANALYTICS_INGEST_TYPE:i.default.get("ANALYTICS_INGEST_TYPE"),ANALYTICS_MAX_QUEUED_EVENTS:i.default.get("ANALYTICS_MAX_QUEUED_EVENTS"),ANALYTICS_DEBOUNCE:i.default.get("ANALYTICS_DEBOUNCE"),ALLOW_NO_TOKEN:i.default.get("ALLOW_NO_TOKEN")};class E{constructor(){_(this,"getAccessToken",t=>{if(f)return t();l.default.getAccessToken().then(e=>t(null,e)).catch(e=>t(null,e))}),_(this,"log",t=>{o.a.log(t)}),_(this,"getAgent",(t,e)=>{const a=c.a.stripPathFromURL(t);u.getNodeTunnelOptionsForURL(a).then(t=>{delete t.agent,e(null,t)},t=>{e(t)})})}}let y=new h(new E,g),m=new h(new E,g);e.default=Object.assign(new class{constructor(){_(this,"NO_PARAMS",null),_(this,"session_guid",s.v4()),_(this,"_status",!1),_(this,"checkIMS",(t,e)=>(e["user.service_code"]="creative_cloud",e)),_(this,"getIpAddress",d.default.memoize(()=>{var t=r.networkInterfaces();const e=Object.keys(t).map(e=>t[e].filter(t=>"IPv4"===t.family&&!t.internal)[0]).filter(t=>t);return e.length>0?e[0].address:""})),_(this,"cleanPSDKParameters",(t,e)=>(e&&(t["event.language"]=e.productLanguage,t["source.client_id"]=i.default.getEnvironment().CLIENT_ID,t["source.name"]=e.productCode,t["source.version"]=e.productVersion,t["source.platform"]=r.platform(),t["source.device"]="Desktop",t["source.os_version"]=r.release(),t["consumer.name"]="CCX Start",t["consumer.platform"]=r.platform(),t["consumer.os_version"]=r.release(),t["consumer.version"]=e.ccxVersion),t)),_(this,"createPayload",async(t,e,a,r=!1)=>{if(!r){const e=l.default.getUserId();t["event.user_guid"]=e,t=this.checkIMS(e||"",t)}return t["event.guid"]=s.v4(),t["event.session_guid"]=this.session_guid,t["event.coll_dts"]=(new Date).toISOString(),t["event.dts_start"]=t["event.dts_start"]||(new Date).toISOString(),t["event.dts_end"]=t["event.dts_end"]||(new Date).toISOString(),t["event.workflow"]=t["event.workflow"]||i.default.analytics.w_CCX_PROCESS,t["event.category"]=i.default.analytics.c_DESKTOP,t["event.offline"]=n.default.status===n.default.OFFLINE,t["event.ip"]=this.getIpAddress(),t["event.language"]=t["event.language"]||u.getOSLocale(),t["event.device_guid"]=l.default.getDeviceID(),t["env.com.name"]=i.default.analytics.w_CCX_PROCESS,t["env.com.version"]=d.default.getProcessVersion(),e&&(t=this.cleanPSDKParameters(t,e)),a&&this.addSurfaceAnalytics(t,a),t}),_(this,"reset",t=>(t&&(y=new h(new E,t)),y)),_(this,"resetOperational",t=>(t&&(m=new h(new E,t)),m)),_(this,"logProcessEvent",async(t,e,a,s,r,i)=>{t=await this.createPayload(t,e,a,r),s&&(s instanceof p.default||(s=new p.default(s)),t["event.error_desc"]=this.limitMessageSize(s.description),t["event.error_type"]=s.message,t["event.error_code"]=s.code),r?(f=!0,this.postEvent(t,i),this.flush(!0,()=>{f=!1})):this.postEvent(t,i)}),_(this,"logPollingEvent",async(t,e,a)=>{t=await this.createPayload(t),e?(f=!0,this.operationalPostEvent(t,a),this.operationalFlush(!0,()=>{f=!1})):this.operationalPostEvent(t,a)}),_(this,"operationalPostEvent",(t,e=(()=>{}))=>{m.postEvent(t,e)}),_(this,"operationalFlush",(t,e=(()=>{}))=>{m.flush(t,e)}),_(this,"flush",(t,e=(()=>{}))=>{y.flush(t,e)}),_(this,"postEvent",(t,e=(()=>{}))=>{y.postEvent(t,e)}),_(this,"enable",t=>{this._status=t,y.enable(t),m.enable(!0)}),_(this,"limitMessageSize",t=>t.substring(0,1024)),n.default.on(n.default.ONLINE,()=>{this.getIpAddress.cache.clear()})}addSurfaceAnalytics(t,e){const a=(e,a)=>{a&&(t[e]=t[e]||"",t[e].toString().includes(a)||(t[e]+=(t[e].toString().length>0?", ":"")+a))};if(e)for(const t of e)t.surface&&a("exp.surface_id",t.surface),t.campaignId&&a("exp.campaign_id",""+t.campaignId),t.variationId&&a("exp.variation_id",t.variationId),t.treatmentId&&a("exp.treatment_id",t.treatmentId),t.controlGroupId&&a("exp.control_group_id",t.controlGroupId),t.actionBlockId&&a("exp.action_block_id",t.actionBlockId);return t}},i.default.analytics)},function(t,e){t.exports=require("os")},function(t,e,a){"use strict";a.r(e),a.d(e,"LogBuilder",function(){return p}),a.d(e,"default",function(){return _});var s=a(24),r=a(9),i=a(0),o=a(27),n=a(2);function c(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function d(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?c(Object(a),!0).forEach(function(e){l(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):c(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function l(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}let u;class p{constructor(t={},e,...a){l(this,"options",void 0),l(this,"level",void 0),l(this,"args",void 0),l(this,"logArgs",[]),l(this,"error",void 0),l(this,"params",void 0),l(this,"payload",void 0),l(this,"surfaceAnalytics",void 0),this.options=t,this.level=e,this.args=a,this.logArgs=[],this.payload=Object.assign({},this.options.payload),this.options.params&&this.setParams(this.options.params),this.options.surfaceAnalytics&&this.addSurfaceAnalytics(this.options.surfaceAnalytics)}stringifyWithCycles(t){return"string"==typeof t?t:(t instanceof Error&&t.stack&&(t.stack=t.stack.replace(/[A-Z]?:?(\\|\/).*\1/g," ")),s.inspect(t))}convertArgsToString(...t){return t.map(this.stringifyWithCycles).join(" ")}post(){return this.error&&this.error instanceof n.default&&this.error.isSilent?this:(this.options.skipDiskLog||o.a.log(this.options.prefix+`[${this.level.toUpperCase()}] `+this.convertArgsToString(...this.args,...this.logArgs)),(this.options.forceSilentError||!1!==this.options.analytics)&&u.logProcessEvent(this.payload,this.params,this.surfaceAnalytics,this.error,this.options.authenticationDisabled),this)}addSurfaceAnalytics(t){this.surfaceAnalytics=this.surfaceAnalytics||[],this.surfaceAnalytics.push(...t)}addDiskLog(...t){return this.args=this.args.concat(...t),this}appendPayload(t={}){return Object.assign(this.payload,t),this}setError(t=new n.default("No error object passed")){return t instanceof Error||(t=new n.default(""+t)),this.appendPayload({"event.type":i.default.analytics.ERROR}),t instanceof n.default&&this.appendPayload(t.ingestPayload),this.args.push(t),this.error=t,this}setParams(t={}){return t.productCode&&this.logArgs.push(` for product ${t.productCode}[${t.productVersion}]`),this.params=t,this}}class _{static init(){u=a(10).default}constructor(t){l(this,"options",{}),this.options=t}context(t){return new _(d(d(d({},this.options),t),{},{payload:d(d({},this.options.payload),t.payload),surfaceAnalytics:[...this.options.surfaceAnalytics||[],...t.surfaceAnalytics||[]]}))}disk(...t){return new p(d({analytics:!1},this.options),"DISK",...t).post()}error(t,...e){return new p(this.options,"error",...e).setError(t).post()}info(t,...e){return new p(this.options,"info",t,...e).appendPayload({"event.type":t}).post()}async time(t){const e=Date.now(),a=new p(d(d({},this.options),{},{skipDiskLog:!0}),"Perf"),s=await t(a);return a.appendPayload({"event.dts_start":new Date(e).toISOString(),"event.dts_end":(new Date).toISOString(),"event.type":i.default.analytics.t_PERFORMANCE,"event.value":a.payload&&a.payload["event.value"]||Date.now()-e}).post(),s}async request(t){const e=this.options.payload&&this.options.payload["event.context_guid"]||r.v4(),a=Date.now();new p(this.options,"INFO").appendPayload({"event.type":i.default.analytics.t_REQUEST,"event.context_guid":e}).addDiskLog("Request Received").post();const s=new p(d(d({},this.options),{},{forceSilentError:!0}),"INFO");return await t(s).then(t=>(s.appendPayload({"event.type":i.default.analytics.t_RESPONSE,"event.context_guid":e,"event.value":Date.now()-a}).addDiskLog(`Response sent in ${Date.now()-a}ms`).post(),t)).catch(t=>{throw s.appendPayload({"event.context_guid":e}).setError(t).post(),t})}console(...t){console.log(...t)}}l(_,"Builder",void 0),_.Builder=p},function(t,e,a){"use strict";a.r(e),a.d(e,"default",function(){return _});var s=a(6),r=a(3),i=a(35),o=a(9),n=a(0),c=a(24),d=a(11),l=a(36),u=a(1);const p=c.promisify(i.flock);class _{static async writeJsonAtomic(t,e,a,r=!1){t.endsWith("/")||(t+="/");const i=t+e,n=`${i}_${o.v4()}.json`;return await s.ensureDir(t),await s.writeJson(n,a,{spaces:2,EOL:d.EOL}),await _.rename(n,i,r)}static async unzip(t,e){return l(t,e)}static async rename(t,e,a=!1){let r=Date.now(),i=0;return await s.rename(t,e).catch(async function o(n){if(i<100&&(i+=10),n&&("EACCES"===n.code||"EPERM"===n.code||"ENOENT"===n.code)&&Date.now()-r<6e4){if(await u.default.setTimeoutAsync(i),a&&(e=await _.removeOrRename(e)),await s.pathExists(e))throw n;return await s.rename(t,e).catch(o),e}throw n}),e}static async writeAtomic({response:t,target:e,progress:a=(()=>{}),renameOnError:i=!1}){let o=e+n.default.get("DOWNLOAD_TMP_EXTENSION");const c=u.default.throttle(a,n.default.get("PROGRESS_THROTTLE_INTERVAL"));return await s.ensureDir(r.dirname(e)),i&&(o=await _.removeOrRename(o)),t.emitter.on("progress",t=>{c(t.done,t.total,o)}),await t.file(o),t.emitter.removeAllListeners(),await _.rename(o,e,i),e}static async removeOrRename(t){for(await s.remove(t).catch(()=>{});await s.access(t).then(()=>!0).catch(t=>"ENOENT"!==t.code);){const e=t;if((t=_.renameFile(t))===e)return t;await s.remove(t).catch(()=>{})}return t}static renameFile(t,e=n.default.get("MAX_EPERM_RENAMES")){const a=r.extname(t),s=r.basename(t,a),i=s.substr(-3),o=/^\-(\d\d)$/.exec(i);let c=o&&o[1]?parseInt(o[1],10):0,d=s.substr(0,s.length-3);return 0===c&&(d=s),++c>e?t:(c<10&&(c="0"+c),r.join(r.dirname(t),d+"-"+c+a))}static async cleanupFolder(t,e={},a=/^$/){await s.ensureDir(t);const r=await s.readdir(t),i=[],o=[],n=[];return r.forEach(async r=>{e[r]||a.test(r)?i.push(r):n.push(s.remove(t+r).then(()=>{o.push(r)}).catch(()=>{i.push(r)}))}),await u.default.waitAll(n),{left:i.sort(),removed:o.sort()}}static async obtainProcessLock(t){const e=n.default.get("ROOT_DIR");await s.ensureDir(e);const a=`${e}.${t}`,r=await s.open(a,"w");await p(r,"exnb")}}},function(t,e){t.exports=require("url")},function(t,e,a){"use strict";a.r(e);var s=a(17),r=a(34),i=a(0),o=a(12),n=a(14);function c(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}const d=a(1).default,l=a(7).default,u=a(7).BackOffType;var p;!function(t){t.ONLINE="ONLINE",t.OFFLINE="OFFLINE"}(p||(p={}));const _=new class extends s.EventEmitter{constructor(){super(),c(this,"ONLINE",p.ONLINE),c(this,"OFFLINE",p.OFFLINE),c(this,"status",p.ONLINE),c(this,"lastKnownError",void 0),c(this,"log",void 0),c(this,"check",d.memoize(this.checkInternal,{refresher:t=>"pending"!==t.state,destructor:(t,e)=>"pending"!==e.state})),this.on(this.OFFLINE,()=>{l.updateBackOff({type:u.NETWORK,cause:"Offline[DNS]"}),setTimeout(this.check.bind(this),i.default.get("NETWORK_STATUS_INTERVAL"))}),this.log=new o.default({prefix:"NetworkStatus >",payload:{"event.subcategory":i.default.analytics.sc_PROCESS,"event.subtype":i.default.analytics.st_PROCESS}})}async checkInternal(){return new Promise(async t=>{if(i.default.get("TEMP_NETWORK_STATUS_DISABLED"))return this.status=this.ONLINE,this.emit(this.status),void t();const e=i.default.getEnvironment(),a=new n.URL(i.default.get(`URL_${e.LABEL.toUpperCase()}`,"FIRST_MILE")).host;r.resolve(a,e=>{e?(this.lastKnownError&&this.lastKnownError.code===e.code||(this.log.error(e,"Network Error"),this.lastKnownError=e),this.status=this.OFFLINE):this.status=this.ONLINE,this.emit(this.status),t()})})}};e.default=_},function(t,e,a){"use strict";a.r(e),a.d(e,"default",function(){return E});var s=a(9),r=a(0),i=a(12),o=a(5),n=a(20),c=a(4),d=a(15),l=a(25),u=a.n(l),p=a(14),_=a(2),f=a(7),h=a(1);function g(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}class E{constructor(t){g(this,"type",void 0),g(this,"_requestLock",void 0),g(this,"prioritize",void 0),g(this,"log",void 0),g(this,"downloadCollectionData",void 0),this.type=t,E.requestLock=E.requestLock||new o.default(r.default.get("NUM_CONCURRENT_REQUESTS")),this._requestLock=E.requestLock,this.prioritize=this._requestLock.prioritize,this.log=new i.default({prefix:`${r.default.get("LOG_PREFIX",t)}DownloadManager > `,payload:{"event.subtype":r.default.analytics.st_API}}),this.downloadCollectionData=h.default.retryLocalErrors(this.downloadCollectionDataRaw.bind(this))}async url(t){const e=r.default.getEnvironment(),a=new p.URL(r.default.get(`URL_${e.LABEL.toUpperCase()}`,this.type));return(t.verbose||r.default.get("SOPHIA_VERBOSE_FLAG_ENABLED",this.type))&&(t.verbose=r.default.get("SOPHIA_VERBOSE_FLAG_ENABLED",this.type)),this.appendUrlSearchParams(a.searchParams,t),a.toString()}additionalAnalytics(t){return{}}applyResponseAnalytics(t,e,a){if(t.appendPayload({"exp.response_guid":e.analyticsData&&e.analyticsData.responseGUID}),e.surfaces)for(let a in e.surfaces)t.addSurfaceAnalytics([{surface:a}]),Array.isArray(e.surfaces[a].containers)&&t.addSurfaceAnalytics(e.surfaces[a].containers.map(t=>t.containerAnalyticsData))}async downloadCollectionDataRaw({params:t,priority:e,id:a=s.v4(),skipAuth:i}){const o=await this.url(t),n=await this.log.context({params:t}).time(async t=>{let{response:s,time:n}=await this.get({url:o,options:{method:"GET",headers:{"content-type":"application/json","x-gw-ims-user-id":c.default.getUserId(),"X-API-Key":r.default.getEnvironment().CLIENT_ID}},priority:e,auth:!i&&!!await c.default.getAccessToken().catch(t=>!1),id:a});t.appendPayload({"event.value":n,"event.url":o,"env.svc.name":r.default.get("ANALYTICS_SUBCATEGORY",this.type)});const d=Date.now(),l=await this.getResponseJson(s,o);return n+=Date.now()-d,l});return n.analyticsData&&(n.analyticsData.requestId=a),n}async load(t){return await Object(l.load)(t)}async resume(t,e={}){const{url:a,priority:r,id:i=s.v4()}=e;if(f.default.isWaitingForBackOff(f.BackOffType.NETWORK))throw new Error(`Waiting for global back-off ${f.default.backOffCause(f.BackOffType.NETWORK)}`);if(d.default.status===d.default.OFFLINE)throw new Error(`Cannot get ${a} - Offline`);return await this._requestLock.read(async()=>{this.log.disk(`[${i}] Resuming ${a} - Priority(${r&&r.toString()||0})`);const s=Date.now(),o=new p.URL(a||t.url).origin;let c=e.options||{};c.agent=(await n.getNodeTunnelOptionsForURL(o)).agent,await t.resume(a,c);const d=Date.now()-s;return this.log.disk(`[${i}] Finished.`),d},r)}async get(t={url:""}){const{url:e,options:a={},auth:i=!1,id:o=s.v4(),priority:l}=t;if(f.default.isWaitingForBackOff(f.BackOffType.NETWORK))throw new Error(`Waiting for global back-off ${f.default.backOffCause(f.BackOffType.NETWORK)}`);if(d.default.status===d.default.OFFLINE)throw new Error(`Cannot get ${e} - Offline`);return a.headers=a.headers||{},a.headers["X-Request-Id"]=o,a.headers["user-agent"]=`Adobe CCXProcess-${h.default.getProcessVersion()}/${process.platform}-${h.default.getOsVersion()}-${process.arch}`,a.parallel=Object.assign({minimumPartialSize:r.default.get("NETWORK_MINIMUM_PARTIAL_SIZE"),maxSockets:r.default.get("NETWORK_MAX_SOCKETS"),maxLatency:r.default.get("NETWORK_MAX_LATENCY"),maxLatencyRetries:r.default.get("NETWORK_MAX_LATENCY_RETRIES"),exitOnLatency:!1},a.parallel||{}),await this._requestLock.read(async()=>{this.log.disk(`[${o}] Requesting ${i?"with Auth Headers":"without Auth Headers"} ${e} - Priority(${l&&l.toString()||0})`);const t=Date.now(),s=new p.URL(e).origin;if(i){if(f.default.isWaitingForBackOff(f.BackOffType.AUTH))throw new Error(`Waiting for global back-off ${f.default.backOffCause(f.BackOffType.AUTH)}`);const t=await c.default.getAccessToken();a.headers.Authorization=`Bearer ${t}`}a.headers.Connection="keep-alive",a.agent=(await n.getNodeTunnelOptionsForURL(s)).agent;const h=await u()(e,a).catch(t=>{if("system"===t.type&&("ENOTFOUND"===t.code||"EADDRNOTAVAIL"===t.code))throw d.default.check(),f.default.updateBackOff({cause:"Offline[Network-"+t.code+"]",type:f.BackOffType.NETWORK}),new _.default(r.default.analytics.OFFLINE_ERROR).setPayload({"event.url":e});throw"system"===t.type&&"PROXY"===t.code&&f.default.updateBackOff({cause:t.message,type:f.BackOffType.NETWORK}),t});if(!h.ok&&304!==h.status){const t=await h.text();let a=0;429===h.status&&f.default.updateBackOff({cause:`Server Error[${h.status}]`,type:f.BackOffType.NETWORK}),401===h.status&&f.default.updateBackOff({cause:`Server Error[${h.status}]`,type:f.BackOffType.AUTH});try{var g;const e=JSON.parse(t);a=null!==(g=null==e?void 0:e.error_code)&&void 0!==g?g:0}catch{}const s=new _.default(r.default.analytics.st_NETWORK,`Failed to get ${e} with status code ${h.status} - ${t}`,0!=a?a:h.status).setPayload({"event.url":e});throw s.setResponseHeaders(h.headers),s}f.default.updateBackOff({clear:!0,type:f.BackOffType.NETWORK});const E=Date.now()-t;return this.log.disk(`[${o}] Finished ${E}ms`),{response:h,time:E}},l).catch(t=>{throw this.log.disk(`[${o}] Failed - ${t}`),t})}async getResponseJson(t,e){return await t.json().catch(t=>{throw new _.default(r.default.analytics.INVALID_JSON,t).setPayload({"event.url":e})})}appendUrlSearchParams(t,e={}){const a=e;for(const e in a)Array.isArray(a[e])?a[e].forEach(a=>{t.append(e,a||"")}):t.append(e,a[e]||"")}}g(E,"requestLock",void 0)},function(t,e){t.exports=require("events")},function(t,e,a){"use strict";a.d(e,"a",function(){return R});var s=a(0),r=a(1),i=a(5),o=a(2),n=a(3),c=a(14),d=a(15),l=a(7),u=a(9),p=a(6),_=a(37),f=a(4),h=a(13),g=a(12),E=a(22),y=a(10),m=a(17),T=a(38),O=a.n(T),S=a(25);function A(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function I(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?A(Object(a),!0).forEach(function(e){C(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):A(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function C(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}const N=a(20);class R extends m{constructor(t){super(),C(this,"_data",void 0),C(this,"_type",void 0),C(this,"_path",void 0),C(this,"_fileName",void 0),C(this,"_downloadManager",void 0),C(this,"_diskLock",void 0),C(this,"_syncLock",void 0),C(this,"log",void 0),C(this,"gc",void 0),C(this,"_syncTimeout",void 0),C(this,"fetchOnDemandContent",void 0),C(this,"fetchAsset",void 0),C(this,"_fetchCollectionData",void 0),C(this,"fetchCollectionIndex",void 0),C(this,"_saveInProgress",!1),C(this,"_calledSave",!1),C(this,"abortControllers",{}),s.default.patch(t.LABEL,t||{}),this._type=t.LABEL,this._path=n.join(s.default.get("ROOT_DIR"),s.default.get("DIR",this.type)),this._fileName=s.default.get("LOOKUP_MAP_FILE",this.type)||s.default.get("LOOKUP_MAP_FILE"),this._downloadManager=null,this._diskLock=new i.default,this._syncLock=new i.default(9999),this.log=new g.default({prefix:`${s.default.get("LOG_PREFIX",this.type)}LookupMap > `,payload:{"event.subcategory":s.default.get("ANALYTICS_SUBCATEGORY",this.type)}}),this.fetchOnDemandContent=r.default.memoize(r.default.retryLocalErrors(this._fetchOnDemandContent.bind(this)),{refresher:t=>"pending"!==t.state,resolver:t=>this.paramsToOnDemandId(t),destructor:(t,e)=>"pending"!==e.state}),this.fetchAsset=r.default.memoize(r.default.retryLocalErrors(this._fetchAsset.bind(this)),{refresher:t=>"pending"!==t.state,resolver:t=>t.key||t.href,wrapper:(t,e,a)=>{const s=t[0]||{};return s.force&&s.force.type&&a&&["stale","always"].includes(s.force.type)?e.then(()=>this._fetchAsset(s)):e},destructor:(t,e)=>"pending"!==e.state}),this._fetchCollectionData=r.default.memoize(this._fetchCollectionDataRaw,{refresher:t=>"pending"!==t.state,resolver:t=>this.paramsToId(t.params,!1),wrapper:(t,e,a)=>{const s=t[0]||{};return s.force&&s.force.type&&a&&["stale","always"].includes(s.force.type)?e.then(()=>this._fetchCollectionData(s)):e},destructor:(t,e)=>"pending"!==e.state}),this.fetchCollectionIndex=r.default.retryLocalErrors(this.fetchCollectionIndexRaw.bind(this)),this.gc=r.default.memoize(this._gc,{refresher:t=>"pending"!==t.state,destructor:(t,e)=>"pending"!==e.state})}isSyncInProgress(t){const e=this._fetchCollectionData.cache&&this._fetchCollectionData.cache.get(t);return e&&"pending"===e.state}paramsToIdRaw(t){const e=this._getCollectionInfo(t);if(e&&e.pendingId)return e.pendingId;if(e&&e.latestId){const t=this._data.metadata[e.latestId];if(r.default.getTimeToExpiry(t.expiryTime)>0)return e.latestId}}paramsToId(t,e=!0){var a,s;const r=this.paramsToIdRaw(t);if(r)return r;const i=this.generateId(t);return this._addNewCollectionInfo({params:t,isPending:!0,collectionId:i,file:null===(a=this._data)||void 0===a?void 0:null===(s=a.metadata[i])||void 0===s?void 0:s.path}),e?this.save().then(()=>i):(this.save(),i)}generateId(t){return[t.filePrefix,t.productCode,t.productVersion,t.productLanguage,u.v4()].filter(t=>!!t).join("-").trim()}async expireAll(t){this._data&&(Object.keys(this._data.metadata).forEach(e=>{t&&t===this._data.metadata[e].userId&&delete this._data.metadata[e].expiryTime}),await this.save())}async forceRefresh(t){const e=[...Object.values(t)],a=this.getIdsByKeys(e);await Promise.all(a.map(async t=>await this.expireOne(t)))}getIdsByKeys(t){const e=[],a=t.reduce((t,a)=>t[a]?t[a]:(e.push(a),t),this._data.versionInfo[f.default.getUserId()]),s=[];if(a.lastUsedId&&s.push(a.lastUsedId),a.pendingId&&s.push(a.pendingId),a.lastDisplayedId&&s.push(a.lastDisplayedId),a.latestId&&s.push(a.latestId),s.length>0)return s;const r=new Set,i=t=>{let a=!1;t.lastUsedId&&(s.push(t.lastUsedId),a=!0),t.pendingId&&(s.push(t.pendingId),a=!0),t.lastDisplayedId&&(s.push(t.lastDisplayedId),a=!0),t.latestId&&(s.push(t.latestId),a=!0);const o=Object.keys(t).some(e=>"object"==typeof t[e]);if(a||!o)return;const n=Object.keys(t),c=e.find(e=>!!t[e]);c?(r.add(c),i(t[c])):n.forEach(e=>i(t[e]))};return i(a),e.length>r.size?[]:s}async expireOne(t){try{delete this._data.metadata[t].expiryTime}catch(t){return}await this.save()}_getLookupKeys(t,e=null){const a=this.makeVersionLookupKey(t.productVersion),s=[e||f.default.getUserId()];return s.push(t.productCode,a,t.productLanguage),s}makeVersionLookupKey(t){const e=t&&t.split(".");return e&&`${e[0]}.${e[1]}`}_getCollectionInfo(t,e=null){if(!t)return;const a=this._getLookupKeys(t,e);let s=this._data.versionInfo;return a.forEach(t=>{s&&(s=s[t])}),s}_setCollectionInfo(t,e){const a=this._getLookupKeys(t);let s=this._data.versionInfo;return a.forEach((t,r)=>{r===a.length-1?s[t]=e:(s[t]=s[t]||{},s=s[t])}),s}_isDataReferenced(t){const e=this._data.metadata[t],a=e&&this._getCollectionInfo(e.params,e.userId);return!!a&&!!Object.keys(a).find(e=>t===a[e])}_isDataPrimaryReference(t){const e=this._data.metadata[t],a=e&&this._getCollectionInfo(e.params,e.userId);if(a){if(a.pendingId)return t===a.pendingId;if(a.latestId)return t===a.latestId}return!1}_checkValidity(t,e){}_addNewCollectionInfo({params:t,isPending:e,collectionId:a,expiry:s,retry:r,cause:i="Unknown",refreshTime:o,file:n}){const c=this._getCollectionInfo(t)||{};let d=new Date;return Object.values(c).forEach(t=>{const e=this._data.metadata[t];if(e&&e.lastUseTime){const t=new Date(e.lastUseTime);!isNaN(t.getTime())&&t>d&&(d=t)}!r&&e&&e.retry&&(r=e.retry)}),e?c.pendingId=a:(c.latestId=a,delete c.pendingId),this._setCollectionInfo(t,c),this._data.metadata[a]={expiryTime:s?s.toISOString():void 0,userId:f.default.getUserId(),lastUseTime:d.toISOString(),retry:r,cause:i,params:t,refreshTime:o,path:null!=n?n:e?void 0:`${a}.json`},this._data.metadata[a]}sanitizeParams(t){return t.productLanguage=r.default.sanitizeLocale(t.productLanguage),t}isRequestPoisoned(t){const e=s.default.get("SUPPORTED_PRODUCTS",this.type);return!(t.productCode&&e[t.productCode]&&r.default.compareMajorMinorVersions(e[t.productCode],t.productVersion)>-1)}_calculateExpiry(t,e){const a=t?t.expiryTime:void 0;let r;if(a){r=new Date(a);const t=new Date;t.setMilliseconds(s.default.get("MAX_TIMEOUT")),r>t&&(r=t);const e=new Date;e.setMilliseconds(s.default.get("MIN_TIMEOUT")),r<e&&(r=e)}return r}_calculateBackOffMetadata({metadata:t,error:e,updateBackOff:a=!0,initialRetry:r=s.default.get("SYNC_INITIAL_RETRY")}){let i=r,o="killed before response";const n=e;if(n&&n.responseHeaders){const t=E.a.getRetryAfterHeader(n.responseHeaders);t&&(i=1e3*t)}else(null==t?void 0:t.retry)&&(i=t.retry*(a?2:1),i=a?Math.max(s.default.get("SYNC_INITIAL_RETRY"),i):i);n&&(o=n.short?n.short:n.message?n.message:n.toString(),n.code&&"403012"===n.code.toString()&&(i=s.default.get("EMBARGO_BACK_OFF"))),i=Math.min(i,s.default.get("MAX_TIMEOUT"));const c=new Date;return c.setMilliseconds(i),{expiry:c,retry:i,cause:o}}async fetchCollectionIndexRaw({requestId:t,desiredId:e,params:a,oldMetadata:i,priority:o,force:n,skipAuth:c=!1}){var d,l;const u=this._createCollectionData(e);let p=!0;await u.load({version:r.default.ccxVersionToString(a),file:null===(d=this._data)||void 0===d?void 0:null===(l=d.metadata[e])||void 0===l?void 0:l.path}).then(()=>{var t;(null===(t=this._data)||void 0===t?void 0:t.metadata[e])&&(this._data.metadata[e].path=u.fileName)}).catch(t=>{p=!1}),p&&r.default.isDateExpired(u.expiryTime)&&(p=!1),p&&u.isDefaultData&&(p=!1);let _=i&&i.refreshTime;if(p&&("stale"===n.type&&r.default.isDateExpired(i.expiryTime)?p=!1:"always"===n.type&&(p=!1)),!p||c){const i=await this.downloadManager.downloadCollectionData({id:t,params:a,priority:o,skipAuth:c});i._ccx=i._ccx||{},i._ccx.version=s.default.get("LOOKUP_COLLECTION_FILE_VERSION",this.type);let n=u.setData(i,r.default.ccxVersionToString(a));if(n)throw n;await u.save(),_=(new Date).toISOString(),this._data.metadata[e]&&(this._data.metadata[e].path=u.fileName,this._data.metadata[e].refreshTime=_),await this.save()}return this._checkValidity(u,a),u}async defaultCollectionData({params:t,desiredId:e}){}async _fetchCollectionDataRaw({params:t,priority:e,payload:a,force:i={type:"none"},fetchType:n="pre-fetch"}){if(l.default.isWaitingForBackOff(l.BackOffType.NETWORK))throw new o.default(`Awaiting global back-off ${l.default.backOffCause(l.BackOffType.NETWORK)}`).silence();return await this._syncLock.read(async()=>{var l,p;if(!f.default.getUserId())throw new o.default("signed out").silence();if(d.default.status===d.default.OFFLINE)throw this.log.disk("Not downloading collection - offline"),new o.default("offline").silence();let _=await this.paramsToId(t);const h=this._getCollectionInfo(t),g=_;if(h&&_===h.latestId){if("always"!==i.type)return this._createCollectionData(_);delete this._data.metadata[_].expiryTime,_=await this.paramsToId(t)}let E=t=>{this.emit(_,t),g!==_&&this.emit(g,t)};if(t=this.sanitizeParams(t),(e=e||this.priority({params:t,key:_})).key=_,this.isRequestPoisoned(t))throw new o.default("Poisoned request not supported.").silence();const y=Object.assign({},this._data.metadata[_]);if(y&&!r.default.isDateExpired(y.expiryTime)&&"none"===i.type){const e=`Waiting for back-off ${y.cause} for ${r.default.getHumanReadableTime(y.retry||0)} expiring at ${y.expiryTime} in ${r.default.getHumanReadableTime(new Date(y.expiryTime).getTime()-Date.now())}`;throw this.log.context({params:t}).disk(e),new o.default(e).silence()}this._addNewCollectionInfo(I(I({params:t,isPending:!0,collectionId:_,refreshTime:y.refreshTime},this._calculateBackOffMetadata({metadata:this._data.metadata[_],initialRetry:s.default.get("KILLED_BEFORE_RESPONSE_INITIAL_RETRY")})),{},{file:null===(l=this._data)||void 0===l?void 0:null===(p=l.metadata[_])||void 0===p?void 0:p.path})),await this.save();const m=u.v4(),T=await this.downloadManager.url(t),O=await N.getNodeTunnelOptionsForURL(new c.URL(T).origin).details;let S=this.log.context({params:t,payload:I(I({},a),{},{"exp.request_guid":m,"event.url":T,"content.action":T,"event.subtype":s.default.analytics.st_API,"ccxp.mode":n,"ccxp.request_type":"get","ccxp.proxy":O},this.downloadManager.additionalAnalytics(t))});return await S.request(async a=>{try{const c={};E(c);const d={requestId:m,params:t,desiredId:_,oldMetadata:y,force:i,priority:e},l=await this.fetchCollectionIndex(d).catch(async e=>{if(!s.default.get("ANONYMOUS_RETRY_DISABLED",this.type)&&await f.default.getAccessToken()){d.skipAuth=!0,this.log.context({params:t}).error(new o.default("Attempting Context only (bypass)",e));const a=await this.fetchCollectionIndex(d).catch(async e=>{if(!s.default.get("DEFAULT_URLS_ENABLED",this.type))throw e;this.log.context({params:t}).error(new o.default("Attempting Default URL (bypass)",e));const a=await this.defaultCollectionData({params:t,desiredId:_});if(!a)throw e;return await a.save(),a});if(!a)throw e;return await a.save(),a}{if(!s.default.get("DEFAULT_URLS_ENABLED",this.type))throw e;this.log.context({params:t}).error(new o.default("Attempting Default URL (bypass)",e));const a=await this.defaultCollectionData({params:t,desiredId:_});if(!a)throw e;return await a.save(),a}});return this.downloadManager.applyResponseAnalytics(a,l.data,t),c.path=`${this._path+l.fileName}`,c.contentId=l.id,c.total=l.totalItems,this._data.metadata[l.id]&&(this._data.metadata[l.id].path=l.fileName),E(c),await l.sync({priority:e,payload:a.options.payload,params:t,progress:t=>{c.path=`${this._path+l.fileName}`,E(Object.assign(t,c))},force:i}),this._checkValidity(l,t),this._addNewCollectionInfo({params:t,isPending:!1,collectionId:l.id,expiry:this._calculateExpiry(l,t),refreshTime:this._data&&this._data.metadata[_]&&this._data.metadata[_].refreshTime,file:l.fileName}),await this.save(),this.emit("newCollection",t,l),l}catch(e){var r,n;throw this._addNewCollectionInfo(I(I({params:t,isPending:!0,collectionId:_,refreshTime:this._data.metadata[_].refreshTime},this._calculateBackOffMetadata({metadata:this._data.metadata[_],error:e,updateBackOff:!1})),{},{file:null===(r=this._data)||void 0===r?void 0:null===(n=r.metadata[_])||void 0===n?void 0:n.path})),await this.save(),e}})},e)}_clearScheduledSyncJob(){this._syncTimeout&&(clearTimeout(this._syncTimeout),delete this._syncTimeout)}async _scheduleNextSyncJob(){var t,e;let a=1/0;if(this._clearScheduledSyncJob(),l.default.isWaitingForBackOff(l.BackOffType.NETWORK))return a=new Date(l.default.backOffExpiry(l.BackOffType.NETWORK)).getTime()-(new Date).getTime(),this.log.disk(`Scheduling next sync in ${r.default.getHumanReadableTime(a)} after global backoff`),a=Math.min(s.default.get("MAX_TIMEOUT"),a),void(this._syncTimeout=setTimeout(this.sync.bind(this),a));await r.default.waitAll(Object.keys(this._data.metadata).map(async t=>{const e=this._data.metadata[t],i=e.params;if(this.needsSync(t,{checkExpiry:!1})){let t=r.default.getTimeToExpiry(e.expiryTime);if(0===t){t=s.default.get("SYNC_INITIAL_RETRY");const a=new Date;a.setMilliseconds(t),e.expiryTime=a.toISOString(),await this.save(),this.log.context({params:i}).info(s.default.analytics.MISSING_DATA,`Scheduling with expired data. Add back-off for ${i.productCode}[${i.productLanguage}] - ${e.expiryTime}`)}a=Math.min(a,t)}})),await r.default.waitAll(Object.values(null!==(t=null===(e=this._data)||void 0===e?void 0:e.onDemandMetadata)&&void 0!==t?t:{}).map(async t=>{if("notReady"===this.getOnDemandCollectionInfo(t.params)&&!this.isOnDemandSyncInProgress(this.paramsToOnDemandId(t.params))){let e=r.default.getTimeToExpiry(t.expiryTime);a=Math.min(a,e)}})),a!==1/0&&(a+=r.default.getRandomizedTime(a<s.default.get("TIME_FOR_SHORT_RANDOMIZE")),a=Math.min(a,s.default.get("MAX_TIMEOUT")),this.log.disk(`Scheduling next sync in ${r.default.getHumanReadableTime(a)} at ${new Date(Date.now()+a).toISOString()}`),this._syncTimeout=setTimeout(this.sync.bind(this),a))}_getReferencedIdList(){const t={};return Object.keys(this._data.metadata).forEach(e=>{this._isDataReferenced(e)&&(t[e]=!0)}),t}_isPendingCollection(t){const e=this._data.metadata[t],a=e&&this._getCollectionInfo(e.params,e.userId);return!(!a||!a.pendingId)&&t===a.pendingId}async _refetchCollection(t){const e=this._data.metadata,a=e[t]&&e[t].params;return a?(this.clearCollectionInfo(a,t),this.log.disk(`Refetch collection [${t}]`),await this.addNewCollectionData({params:a}).catch(t=>this.log.context({params:a}).error(t,"Error Re-fetching collection")&&void 0)):Promise.resolve()}async _getReferencedAssetList(t){const e={};return await r.default.waitAll(Object.keys(t).map(async t=>{let a=this._createCollectionData(t);try{var s;const i=r.default.ccxVersionToString(this._data.metadata[t].params);await a.load({version:i,skipSaving:!0,file:null===(s=this._data.metadata[t])||void 0===s?void 0:s.path}),Object.assign(e,await a.getReferencedAssets())}catch(t){if("ENOENT"!==t.code)throw t;{this.log.disk(`File is missing for collection [${a.id}]`);const t=this._data.metadata[a.id];t&&t.userId===f.default.getUserId()&&this._isDataPrimaryReference(a.id)&&!this._isPendingCollection(a.id)&&this._refetchCollection(a.id)}}})),e}_cleanupCache(t,e){var a;const s=this._data.metadata;Object.keys(s).forEach(a=>{var r,i;this._isDataPrimaryReference(a)||t[a]&&e.includes(null!==(r=null===(i=this._data.metadata[a])||void 0===i?void 0:i.path)&&void 0!==r?r:`${a}.json`)||delete s[a]});const r=null!==(a=this._data.onDemandMetadata)&&void 0!==a?a:{};Object.keys(r).forEach(t=>{this.getOnDemandCollectionInfo(r[t].params)||delete r[t]})}_cleanupAssetsCache(t,e){const a=this._data.assetMetadata;Object.keys(a).forEach(s=>{const r=a[s];r.path&&(t[r.path]&&e.includes(n.basename(r.path))||delete a[s])})}setData(t){const e=r.default.validateDataFields(t,s.default.get("MAP_DATA_SCHEMA"));return e?this.log.error(new o.default(y.default.DATA_VALIDATION_ERR,e[0])):this._data=t,e}getMinorVersion(t,e,a,s){const r=Object.keys(s.metadata).find(r=>{var i,o;const n=null===(i=s.metadata[r])||void 0===i?void 0:i.params;return(null==n?void 0:n.productCode)===e&&(null==n?void 0:n.productVersion.split(".")[0])===a&&(null===(o=s.metadata[r])||void 0===o?void 0:o.userId)===t});if(!r)return null;const i=s.metadata[r].params.productVersion;return this.makeVersionLookupKey(i)}async upgrade(t){return null}async load(){let t=await p.readJson(this._path+this._fileName).catch(t=>{this.log.disk(`Failed to load lookup file from disk: ${this._fileName} - ${r.default.scrubStack(t)}`)}),e=!1;t?t.version!==s.default.get("LOOKUP_MAP_FILE_VERSION",this._type)&&(this.log.disk(`Lookup file version mismatch: ${this._fileName}`),t=await this.upgrade(t).catch(t=>null),e=!0):this.log.disk(`Empty lookup file: ${this._fileName}`),t&&!this.setData(t)||((t={}).version=s.default.get("LOOKUP_MAP_FILE_VERSION",this._type),t.versionInfo={},t.metadata={},t.assetMetadata={},t.usersInfo={},t.onDemand={},t.onDemandMetadata={},this.setData(t)),t.onDemand||(t.onDemand={},t.onDemandMetadata={},e=!0),e&&await this.save()}getPath(){return this._path}async updateDisplayedId({params:t,displayed:e}){if(e&&t){var a;const s=null!==(a=Object.keys(this._data.metadata).find(t=>this._data.metadata[t].path===e))&&void 0!==a?a:n.basename(e,".json");let r=this._getCollectionInfo(t);r||(this._addNewCollectionInfo({params:t,isPending:!1,collectionId:s,file:e}),r=this._getCollectionInfo(t)),r&&r.lastDisplayedId!==s&&(r.lastDisplayedId=s,this._setCollectionInfo(t,r),await this.save())}}validateParams(t){const e=r.default.validateDataFields(t,s.default.get("PARAMETERS_SCHEMA",this.type));if(e)throw new o.default(s.default.analytics.PARAM_VALIDATION_ERR,e[0])}async getLatestPath({params:t,updateLastUsedId:e=!1,updateLastUseTime:a=!1}){if(!t){const t=new Error(y.default.DATA_VALIDATION_ERR);return void this.log.error(t,"No data to get the path for in LookupMap")}this.validateParams(t);const i=this._getCollectionInfo(t);if(i&&i.latestId){var o,n;let u=!1;if(e&&i.latestId!==i.lastUsedId&&(i.lastUsedId=i.latestId,this._setCollectionInfo(t,i),u=!0),a){const t=this._data.metadata[i.lastUsedId?i.lastUsedId:""]||{},e=t.lastUseTime;if(t.lastUseTime=(new Date).toISOString(),e){const t=new Date(e);t.setMilliseconds(s.default.get("STOP_SYNCING_BEYOND")),t<new Date&&this.sync()}u=!0}u&&await this.save();const p=this._data.metadata[i.latestId];if(p&&p.userId===f.default.getUserId()&&!this._isPendingCollection(i.latestId)){var c,d,l;const e=this._createCollectionData(i.latestId);e.load({version:r.default.ccxVersionToString(t),file:null===(c=this._data)||void 0===c?void 0:null===(d=c.metadata[i.latestId])||void 0===d?void 0:d.path}).catch(t=>{"ENOENT"===t.code&&(this.log.disk(`File is missing for collection [${e.id}]`),this._refetchCollection(e.id))}),(null===(l=this._data)||void 0===l?void 0:l.metadata[i.latestId])&&(this._data.metadata[i.latestId].path=e.fileName)}return this._path+(null!==(o=null===(n=this._data.metadata[i.latestId])||void 0===n?void 0:n.path)&&void 0!==o?o:`${i.latestId}.json`)}}getExpiry(t){return this._data.metadata[t]&&this._data.metadata[t].expiryTime}async save(){if(!this._data){const t=new Error(y.default.DATA_VALIDATION_ERR);throw this.log.error(t,"No data to save to LookupMap."),t}this._saveInProgress?this._calledSave=!0:(this._calledSave=!1,this._saveInProgress=!0,await this._diskLock.write(async()=>{const t=await h.default.writeJsonAtomic(this._path,s.default.get("LOOKUP_MAP_FILE"),this._data,!0);n.basename(t)!==this._fileName&&(this._fileName=n.basename(t),s.default.set("LOOKUP_MAP_FILE",this._fileName,this.type))}).catch(t=>{this.log.error(t,`Error writing to ${this._fileName}`)}),this._saveInProgress=!1,this._calledSave&&(await this.save(),this._calledSave=!1))}cachedAsset(t){return this._data.assetMetadata[t]}async _fetchAsset({href:t,assetsDir:e,priority:a,params:i,force:c,key:d,headers:l,auth:u,progressKey:f}){var g,y,m,T;d=d||t;const O=this._data.assetMetadata[d]||{};let{lastModified:S,expiry:A,etag:I,date:C}=O;const N=O.path&&await p.pathExists(`${e}../${O.path}`);if(N||(S=I=C=A=void 0),c&&c.depth>=0&&("always"===c.type||"stale"===c.type)&&(!c.from||!O.refreshTime||new Date(c.from)>new Date(O.refreshTime))&&(S=I=C=A=void 0),new Date(A||"")>new Date)return{path:O.path};if(!("always"===(null==c?void 0:c.type)&&(null!==(g=null==c?void 0:c.depth)&&void 0!==g?g:0)>=0)&&N&&O.path&&".json"!==n.extname(O.path)&&!s.default.get("NON_IDEMPOTENT_IMAGES",this.type))return{path:O.path};const R=(null==a?void 0:a.key)?this.abortControllers[a.key]:void 0,v=O.temp&&n.normalize(`${e}/../${O.temp}`),P=v&&await p.pathExists(v);let D=!0,L=0,w=void 0,b=O.path;const M=r.default.throttle(e=>{var s,r;f=null!==(s=f)&&void 0!==s?s:"Asset-"+(null!==(r=null==a?void 0:a.key)&&void 0!==r?r:d),this.emit(f,{[d||t]:e})},s.default.get("PROGRESS_THROTTLE_INTERVAL"));if(!N&&P&&v&&O.path){const r=await this.downloadManager.load(v).catch(t=>{this.log.error(new o.default(`Could not load file ${v} for resume`,t))});if(r){r.emitter.on("progress",M);const i=await this.downloadManager.resume(r,{url:t,priority:a,options:{signal:null==R?void 0:R.signal}}).catch(async t=>{if(this.log.error(new o.default("Resume Failed",t)),"ERR_SSL_DECRYPTION_FAILED_OR_BAD_RECORD_MAC"===t.code){var e;const a=null!==(e=s.default.get("ASSET_MAX_SOCKETS",this._type))&&void 0!==e?e:s.default.get("NETWORK_MAX_SOCKETS");throw s.default.set("ASSET_MAX_SOCKETS",Math.max(Math.floor(a/2),1),this._type),new o.default("server",t,"LOCAL_RETRY")}});r.emitter.off("progress",M),(D=void 0===i)||(await h.default.rename(v,`${e}../${O.path}`).catch(()=>D=!0),L+=i||0),w=r.headers}}const U=O.id||this.generateId(i||{});if(D){var x,k,F,V,j;l=l||{},I?l["If-None-Match"]=I:C?l["If-Modified-Since"]=C:S&&(l["If-Modified-Since"]=S);let r=await this.downloadManager.get({url:t,options:{headers:l,parallel:{minimumPartialSize:null!==(x=s.default.get("ASSET_MINIMUM_PARTIAL_SIZE",this._type))&&void 0!==x?x:s.default.get("NETWORK_MINIMUM_PARTIAL_SIZE"),maxSockets:null!==(k=s.default.get("ASSET_MAX_SOCKETS",this._type))&&void 0!==k?k:s.default.get("NETWORK_MAX_SOCKETS"),maxLatency:null!==(F=s.default.get("ASSET_MAX_LATENCY",this._type))&&void 0!==F?F:s.default.get("NETWORK_MAX_LATENCY"),maxLatencyRetries:null!==(V=s.default.get("ASSET_MAX_LATENCY_RETRIES",this._type))&&void 0!==V?V:s.default.get("NETWORK_MAX_LATENCY_RETRIES")},signal:null==R?void 0:R.signal},auth:u,priority:a,id:U}).catch(async t=>{if("ERR_SSL_DECRYPTION_FAILED_OR_BAD_RECORD_MAC"===t.code){var e;const a=null!==(e=s.default.get("ASSET_MAX_SOCKETS",this._type))&&void 0!==e?e:s.default.get("NETWORK_MAX_SOCKETS");throw s.default.set("ASSET_MAX_SOCKETS",Math.max(Math.floor(a/2),1),this._type),new o.default("server",t,"LOCAL_RETRY")}if((4===Math.floor(t.code/100)||5===Math.floor(t.code/100))&&l&&(l["If-None-Match"]||l["If-Modified-Since"]))throw delete O.date,delete O.lastModified,delete O.etag,await this.save(),new o.default("server",t,"LOCAL_RETRY");throw t}),i=r.response;if(L+=r.time,304===i.status){if(O.path)return{path:O.path};throw new Error(`Got 304 for asset not on disk for url ${t}`)}let c=_.getExtension(E.a.getContentTypeHeader(i.headers)||"");c||(c=(c=(c=n.extname(i.url))&&c.substr(1))||"bin");let p=`${e}${U}.${c}`;this._data.assetMetadata[d]=(null===(j=this._data)||void 0===j?void 0:j.assetMetadata[d])||{},this._data.assetMetadata[d].id=U,this._data.assetMetadata[d].path=n.basename(e)+`/${U}.${c}`,await this.save();const f=Date.now();let g=!1;p=await h.default.writeAtomic({response:i,target:p,progress:(t,a,s)=>{var r;!g&&d&&this._data.assetMetadata[d]&&(null===(r=this._data.assetMetadata[d])||void 0===r?void 0:r.temp)!==s&&(this._data.assetMetadata[d].temp=n.basename(e)+"/"+n.basename(s),this.save()),M({done:t,total:a})},renameOnError:!0}),g=!0,b=`${n.basename(e)}/${n.basename(p)}`,w=i.headers,L+=Date.now()-f}var H,X,G;(this._data.assetMetadata[d]={id:U,path:b,expiry:w&&E.a.getExpiry(w)||new Date(Date.now()+s.default.get("ASSET_DEFAULT_EXPIRATION")),refreshTime:(new Date).toISOString()},null===(y=w)||void 0===y?void 0:y.get("last-modified"))&&(this._data.assetMetadata[d].lastModified=null===(H=w)||void 0===H?void 0:H.get("last-modified"));(null===(m=w)||void 0===m?void 0:m.get("etag"))&&(this._data.assetMetadata[d].etag=null===(X=w)||void 0===X?void 0:X.get("etag"));(null===(T=w)||void 0===T?void 0:T.get("date"))&&(this._data.assetMetadata[d].date=null===(G=w)||void 0===G?void 0:G.get("date"));return await this.save(),{path:b,time:L}}priority({params:t,key:e="",level:a=i.PriorityLevels.Regular}){return new i.Priority({key:e,value:s.default.get("PRODUCT_PRIORITY")[t.productCode]||0,channel:s.default.get("PRIORITY_CHANNEL",this._type),level:a})}isValidDataForParams({id:t,params:e}){return!0}async addNewCollectionData({params:t,payload:e,priorityLevel:a,progress:o=(()=>{}),force:n}={}){if(!t){const t=new Error(y.default.DATA_VALIDATION_ERR);throw this.log.error(t,"No parameters to add the collection of."),t}const c=(await this.updateParams([t]))[0];let d="pre-fetch";t=null!=c?c:t,this.validateParams(t);const l=this._getCollectionInfo(t);if(l&&t.ccxVersion){let e=!1;Object.values(l).forEach(a=>{const s=this._data.metadata[a];s&&s.params&&s.params.ccxVersion&&(s.params.ccxVersion&&-1!==r.default.compareMajorMinorVersions(t.ccxVersion,s.params.ccxVersion)||(s.params.ccxVersion=t.ccxVersion,e=!0))}),e&&await this.save()}if(l&&t.vmStatus){let e=!1,a=!(256&t.vmStatus);Object.values(l).forEach(s=>{const r=this._data.metadata[s];r&&r.params&&(a||!r.params.vmStatus)&&(r.params.vmStatus=t.vmStatus,e=!0)}),e&&await this.save()}if(l&&l.latestId){const i=l.latestId;this._data.metadata[i]=this._data.metadata[i]||{};let c=!0;if(s.default.get("MINOR_VERSION_SHOULD_UPDATE_CONTENT",this.type)){Object.values(l).some(e=>{const a=this._data.metadata[e];return!!(a&&a.params&&a.params.productVersion&&0==r.default.compareMajorMinorVersions(t.productVersion,a.params.productVersion))})||(n={type:"always"})}if(n)switch(n.type){case"always":d="force-always",delete this._data.metadata[i].expiryTime;case"stale":d="force-stale",r.default.isDateExpired(this._data.metadata[i].expiryTime)&&(d="expired",c=!1)}if(this._data.metadata[i]?this.isValidDataForParams({id:i,params:t})||(c=!1,delete this._data.metadata[i].expiryTime):c=!1,c){var u,p;const s=this._createCollectionData(i);return this._data.metadata[i].params=t,await s.load({version:r.default.ccxVersionToString(t),file:null===(u=this._data)||void 0===u?void 0:null===(p=u.metadata[i])||void 0===p?void 0:p.path}).then(t=>{var e;return(null===(e=this._data)||void 0===e?void 0:e.metadata[i])&&(this._data.metadata[i].path=s.fileName),t}).catch(async s=>(this.clearCollectionInfo(t,i),await this.addNewCollectionData({params:t,payload:e,progress:o,priorityLevel:a,force:n})))}}const _=await this.paramsToId(t),f=this.priority({params:t,key:_,level:a||i.PriorityLevels.Regular});this._syncLock.prioritize(f),this._downloadManager.prioritize(f),this.addListener(_,o);const h=await this._fetchCollectionData({params:t,priority:f,payload:e,force:n,fetchType:d}).catch(async e=>{throw this.log.context({params:t}).disk(e,"Error adding new collection"),await this._scheduleNextSyncJob(),this.removeListener(_,o),e});return this.removeListener(_,o),h}needsSync(t,e={}){const{checkExpiry:a=!0,force:s=!1}=e,i=this._data.metadata[t];let o=i&&i.userId===f.default.getUserId()&&this._isDataPrimaryReference(t)&&!this.isSyncInProgress(t)&&!this.isRequestPoisoned(i.params);return s||(o=o&&r.default.hasBeenUsedRecently(i.lastUseTime)),a&&!s&&(o=o&&r.default.isDateExpired(i.expiryTime)),o}async sync(t={type:"none"}){var e;let a="pre-fetch";if(d.default.status===d.default.OFFLINE){d.default.check(),l.default.updateBackOff({cause:"Offline[Network-Sync]",type:l.BackOffType.NETWORK}),await this._scheduleNextSyncJob();const t=new o.default("Offline");throw this.log.disk(t),t}this._clearScheduledSyncJob(),"always"===t.type&&(a="force-always",await this.expireAll(f.default.getUserId())),(null===(e=this._data)||void 0===e?void 0:e.metadata)&&await r.default.waitAll(Object.keys(this._data.metadata).map(e=>{const s=this._data.metadata[e];return this.needsSync(e,{force:"none"!==t.type,checkExpiry:!this._isPendingCollection(e)})?(s&&s.expiryTime&&r.default.isDateExpired(s.expiryTime)&&(a="expired"),this._fetchCollectionData({params:s.params,force:t,fetchType:a})):Promise.resolve()})).then(async()=>{await this.syncOnDemandAssets()}).catch(async t=>{throw await this._scheduleNextSyncJob(),t}),await this.gc(),await this._scheduleNextSyncJob()}async _gc(){try{await r.default.getLocks(this._syncLock.write.bind(this._syncLock),this._diskLock.write.bind(this._diskLock),async()=>{this.log.disk("GC starts.");const t=this._getReferencedIdList(),e={},a={};Object.keys(t).forEach(t=>{var a,s,r;const i=null!==(a=null===(s=this._data)||void 0===s?void 0:null===(r=s.metadata[t])||void 0===r?void 0:r.path)&&void 0!==a?a:`${t}.json`;e[i]=!0}),e[this._fileName]=!0;const{left:r,removed:i}=await h.default.cleanupFolder(this._path,e,new RegExp(s.default.get("IGNORED_FILES_REGEXP")));i.length>0&&this.log.disk(`Removed from ${this._path} - ${i.join(" ")}`);const o=await this._getReferencedAssetList(t),c=await this._getOnDemandAssetList();Object.assign(o,c),Object.keys(o).forEach(t=>{a[n.basename(t)]=!0});const d=this._path+s.default.get("ASSETS_DIRNAME")+"/",{left:l,removed:u}=await h.default.cleanupFolder(d,a);u.length>0&&this.log.disk(`Removed from ${d} - ${u.join(", ")}`),this._cleanupCache(t,r),this._cleanupAssetsCache(o,l)}),await this.save(),this.log.disk("GC ended successfully.")}catch(t){throw this.log.error(t,s.default.analytics.GC_ERROR),t}}async setForUser(t,e){let a=this._data.usersInfo;(a=a||{})[f.default.getUserId()]=a[f.default.getUserId()]||{},a[f.default.getUserId()][t]=e,await this.save()}getForUser(t){const e=this._data.usersInfo&&this._data.usersInfo[f.default.getUserId()];return e&&e[t]}getLastTimeOfNotification(){let t=this.getForUser("lastTimeOfNotification");return t||(t=(new Date).getTime(),this.setForUser("lastTimeOfNotification",t)),t}async setLastTimeOfNotification(t){await this.setForUser("lastTimeOfNotification",t)}async uninstall(t){await this.clearCollectionInfo(t),await this.clearOnDemandCollectionInfo(t),await this.gc()}async update(t,e){await this.updateOnDemandCollectionInfo(t,e)}async clearCollectionInfo(t,e){this.validateParams(t);const a=this._getLookupKeys(t);let s=this._data.versionInfo,r=!1;const i=[["root",s]];if(a.forEach(t=>{s&&s[t]?(s=s[t],i.push([t,s])):r=!0}),r||0===i.length)return;let o=i.pop(),n=o[0],c=o[1];const d=[];for(Object.keys(c).forEach(t=>{e?c[t]===e&&(delete c[t],d.push(e)):(d.push(c[t]),delete c[t])}),d.forEach(t=>delete this._data.metadata[t]);i.length>0&&0===Object.keys(c).length;){let t=n;n=(o=i.pop())[0],delete(c=o[1])[t]}await this.save()}get downloadManager(){return this._downloadManager}get type(){return this._type}getCachedRequestData(){const t={};return Object.keys(this._data.metadata).forEach(e=>{const a=this._data.metadata[e];if(a.userId===f.default.getUserId()){const e=a.params;if(e&&e.productCode&&e.productVersion){t[e.productCode]||(t[e.productCode]={}),(e=>{t[e.productCode][e.productVersion]||(t[e.productCode][e.productVersion]=[]),t[e.productCode][e.productVersion].push(e)})(a.params)}}}),t}async updateParams(t){var e;const a=JSON.parse(JSON.stringify(t)),s=N.getOSLocale(),r=(null===(e=f.default.getUserInfo())||void 0===e?void 0:e.countryCode)||s.split("_")[1];return a.forEach(t=>{t.productLanguage=t.productLanguage||s,t.countryCode=t.countryCode||r}),a}targetDetails(t){return t}get diskLock(){return this._diskLock}get assetsDir(){return n.join(s.default.get("ROOT_DIR"),s.default.get("DIR",this.type),s.default.get("ASSETS_DIRNAME"))+"/"}_getOnDemandLookupKeys(t,e=null){return this._getLookupKeys(t,e)}getOnDemandCollection(t,e=null){if(!t){const t=new Error(y.default.DATA_VALIDATION_ERR);return void this.log.error(t,"No data to get collection for in LookupMap.")}const a=this._getOnDemandLookupKeys(t,e);let s=this._data.onDemand;return a.forEach(t=>{s&&(s=s[t])}),s}getOnDemandCollectionInfo(t,e=null){const a=this.getOnDemandCollection(t,e);if(a)return a[this.paramsToOnDemandId(t)]}paramsToOnDemandId(t){return(null==t?void 0:t.url)||(null==t?void 0:t.id)}async addOnDemandCollectionInfo({params:t,state:e,updateLastUseTime:a=!1,expiry:s,retry:r,cause:i}){const o=this.paramsToOnDemandId(t);if(o){var n,c,d;let u=this._getOnDemandLookupKeys(t),p=this._data.onDemand;for(const t of u){var l;p[t]=null!==(l=p[t])&&void 0!==l?l:{},p=p[t]}p[o]=e,this._data.onDemandMetadata[o]={userId:f.default.getUserId(),params:t,lastUseTime:a?(new Date).toISOString():null===(n=this._data)||void 0===n?void 0:null===(c=n.onDemandMetadata)||void 0===c?void 0:null===(d=c[o])||void 0===d?void 0:d.lastUseTime,expiryTime:null==s?void 0:s.toISOString(),retry:r,cause:i},await this.save()}}async _getOnDemandAssetList(){var t;const e={};return Object.values((null===(t=this._data)||void 0===t?void 0:t.onDemandMetadata)||{}).forEach(t=>{var a;const s=this.paramsToOnDemandId(t.params),r=null===(a=this._data.assetMetadata[s])||void 0===a?void 0:a.path;r&&(e[r]=!0)}),e}async _fetchOnDemandContent({params:t,force:e,priority:a}){const s=this.paramsToOnDemandId(t);if(!s)throw new Error(y.default.DATA_VALIDATION_ERR);return(await this.fetchAsset({href:s,assetsDir:this.assetsDir,force:e,priority:a})).path}async updateOnDemandCollectionInfo(t,e){this.validateParams(e),this.validateParams(t),Object.keys(this._data.onDemand).forEach(a=>{const s=this.getOnDemandCollection(t,a);if(s){let t=this._getOnDemandLookupKeys(e),a=this._data.onDemand;for(const e of t){var r;a[e]=null!==(r=a[e])&&void 0!==r?r:{},a=a[e]}Object.keys(s).forEach(t=>{this._data.onDemandMetadata[t]&&(this._data.onDemandMetadata[t].params=Object.assign(this._data.onDemandMetadata[t].params,e)),a[t]=s[t]})}}),await this.save()}async clearOnDemandCollectionInfo(t,e){this.validateParams(t);const a=this._getOnDemandLookupKeys(t);let s=this._data.onDemand,r=!1;const i=[["root",s]];if(a.forEach(t=>{s&&s[t]?(s=s[t],i.push([t,s])):r=!0}),r||0===i.length)return;let o=i.pop(),n=o[0],c=o[1];const d=[];for(Object.keys(c).forEach(t=>{e?t===e&&(delete c[t],d.push(e)):(d.push(t),delete c[t])});i.length>0&&0===Object.keys(c).length;){let t=n;n=(o=i.pop())[0],delete(c=o[1])[t]}d.forEach(t=>{this.getOnDemandCollectionInfo(this._data.onDemandMetadata[t].params)||delete this._data.onDemandMetadata[t]}),await this.save()}async syncOnDemandAssets(){var t;await r.default.waitAll(Object.values((null===(t=this._data)||void 0===t?void 0:t.onDemandMetadata)||{}).map(async t=>{r.default.hasBeenUsedRecently(t.lastUseTime)&&"paused"!==this.getOnDemandCollectionInfo(t.params)&&await this.getOnDemandData({params:t.params,force:{type:"stale",depth:999}})}))}isOnDemandSyncInProgress(t){const e=this.fetchOnDemandContent.cache&&this.fetchOnDemandContent.cache.get(t);return e&&"pending"===e.state}getOnDemandAssetPath(t){var e,a,s;return t.url?null===(e=this._data)||void 0===e?void 0:null===(a=e.assetMetadata)||void 0===a?void 0:null===(s=a[t.url])||void 0===s?void 0:s.path:void 0}async getOnDemandData({params:t={},force:e={type:"none"},updateLastUseTime:a=!1,priorityLevel:s=i.PriorityLevels.Regular}){var n;const c=this.paramsToOnDemandId(t);if(!c){const t=new Error(y.default.DATA_VALIDATION_ERR);throw this.log.error(t,"Cannot generate key from parameters."),t}this.abortControllers[c]=this.abortControllers[c]||new O.a;const d=this.priority({params:t,key:c,level:s});if(this._downloadManager.prioritize(d),this.getOnDemandCollectionInfo(t)){var l;const a=null===(l=this._data)||void 0===l?void 0:l.onDemandMetadata[c];if(a&&!r.default.isDateExpired(a.expiryTime)&&"none"===e.type){const e=`Waiting for back-off ${a.cause} for ${r.default.getHumanReadableTime(a.retry||0)} expiring ${a.expiryTime} in ${r.default.getHumanReadableTime(new Date(a.expiryTime).getTime()-Date.now())}`;throw this.log.context({params:t}).disk(e),new o.default(e).silence()}}else{var u;await this.addOnDemandCollectionInfo(I({params:t,state:"notReady",updateLastUseTime:a},this._calculateBackOffMetadata({updateBackOff:!1,metadata:null===(u=this._data)||void 0===u?void 0:u.onDemandMetadata[c]})))}const p=t&&t.url&&this._data.assetMetadata[null===(n=t)||void 0===n?void 0:n.url];let _=e&&"always"===e.type||"ready"!=this.getOnDemandCollectionInfo(t)||p&&r.default.getTimeToExpiry(p.expiry)<=0?void 0:this.getOnDemandAssetPath(t);if(_);else if(this.isOnDemandSyncInProgress(c))_=await this._fetchOnDemandContent({params:t,force:e,priority:d});else{const a={assets:{}};let s=t=>{Object.assign(a.assets,t),this.emit(c,a)};this.on(`Asset-${c}`,s),_=await this._syncLock.read(async()=>await this.log.context({payload:{"ccxp.mode":"on-demand","event.subtype":"api","ccxp.request_type":"get","event.url":t.url,"content.id":t.id}}).request(async()=>(t=(await this.updateParams([t]))[0],await this._fetchOnDemandContent({params:t,force:e,priority:d}).catch(async e=>{var a;e instanceof S.AbortError||(await this.addOnDemandCollectionInfo(I({params:t,state:"notReady"},this._calculateBackOffMetadata({metadata:null===(a=this._data)||void 0===a?void 0:a.onDemandMetadata[c],error:e}))),this.log.error(e,"Error getting on demand data"),this._scheduleNextSyncJob());throw e}))),d),this.off(`Asset-${c}`,s)}return await this.addOnDemandCollectionInfo({params:t,state:"ready",updateLastUseTime:a}),delete this.abortControllers[c],_}async onDemandAbort(t={}){var e;const a=this.paramsToOnDemandId(t);if(!a){const t=new Error(y.default.DATA_VALIDATION_ERR);throw this.log.error(t,"Cannot generate key from parameters."),t}null===(e=this.abortControllers[a])||void 0===e||e.abort(),this.isOnDemandSyncInProgress(a)&&await this.getOnDemandData({params:t}),"notReady"===this.getOnDemandCollectionInfo(t)&&this.addOnDemandCollectionInfo({params:t,state:"paused",updateLastUseTime:!1}),delete this.abortControllers[a]}}},function(t,e,a){"use strict";a.d(e,"a",function(){return _});var s=a(13),r=a(6),i=a(10),o=a(2),n=a(12),c=a(0),d=a(3);function l(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function u(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?l(Object(a),!0).forEach(function(e){p(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function p(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}class _{constructor(t,e){p(this,"_id",void 0),p(this,"_lookupMap",void 0),p(this,"_diskLock",void 0),p(this,"log",void 0),p(this,"_fileName",void 0),p(this,"_data",void 0),this._id=t,this._lookupMap=e,this._diskLock=e.diskLock,this.log=new n.default({prefix:`${c.default.get("LOG_PREFIX",e.type)}Data > `,payload:{"event.subcategory":c.default.get("ANALYTICS_SUBCATEGORY",e.type)}}),this._fileName=`${this._id}.json`}setData(t,e=""){const a=this.validateData(t,e);return a?this.log.error(new o.default(i.default.DATA_VALIDATION_ERR,`Invalid data: ${JSON.stringify(t)}`)):this._data=t,a}get fileName(){return this._fileName}get assetsDir(){return d.join(c.default.get("ROOT_DIR"),c.default.get("DIR",this._lookupMap.type),c.default.get("ASSETS_DIRNAME"))+"/"}hasValidCards(t){return!0}get id(){return this._id}get expiryTime(){return this._data&&this._data.expirationDTS}async upgrade(t,e){return null}async load({version:t,skipSaving:e,file:a}){this._fileName=null!=a?a:this._fileName;let s=await r.readJson(this._lookupMap.getPath()+this._fileName),i=!1;const o=s._ccx&&s._ccx.version||s.version;s&&o!==c.default.get("LOOKUP_COLLECTION_FILE_VERSION",this._lookupMap.type)&&(this.log.disk(`Collection Lookup file version mismatch: ${this._fileName}`),s=await this.upgrade(s,t).catch(t=>null),i=!0);let n=this.setData(s,t);if(n)throw n;return n||!i||e||await this.save(),this}async save(){if(!this._data)throw new Error("No data to save");const t=await this._diskLock.write(async()=>await s.default.writeJsonAtomic(this._lookupMap.getPath(),this._fileName,this._data,!0));this._fileName=d.basename(t)}async logFailures(){var t,e;Object.keys(null!==(t=null==this?void 0:null===(e=this._data)||void 0===e?void 0:e.surfaces)&&void 0!==t?t:{}).forEach(t=>{var e;((null===(e=this._data.surfaces[t||""])||void 0===e?void 0:e.failedContainers)||[]).forEach(e=>{const a=c.default.get("IGNORE_SURFACES_FOR_SOPHIA_ERRORS",this._lookupMap.type);!e||!t||a&&a[t]&&a[t].includes(e.containerId)||this.log.context({surfaceAnalytics:[{surface:t}]}).error(new o.default("Sophia Surface Error",e.errorMessage+` for ${t}(${e.containerId})`,e.errorCode))})})}async sync(t){if(!this._data)throw new Error("Invalid data");this.logFailures(),await this.syncData(u(u({},t),{},{progress:async e=>{await this.save(),t.progress&&t.progress(e)}})),await this.save()}get isDefaultData(){return!!(this._data&&this._data._ccx&&this._data._ccx.isDefault)}get data(){return this._data}validateData(t,e){return null}}},function(t,e,a){const s=a(12).default,r=a(17),i=a(24),o=a(1).default,n=new s({prefix:"Proxy > "}),c=a(32),d=a(47),l=a(32).globalAgent,u="win32"===process.platform&&"arm64"===process.arch,p={},_=!u&&a(48)((t,e)=>{n.disk(e)}),f={getRootCA:!u&&i.promisify(_.getRootCA),resolve:!u&&i.promisify(_.resolve)};t.exports=new class extends r{constructor(){super(),this.getNodeTunnelOptionsForURL=o.memoize(this._getNodeTunnelOptionsForURL,{destructor:(t,e)=>{const a=e.value.agent;return!(!a||!a.isAvailable||0!==Object.values(a.sockets).map(t=>t.length).reduce((t,e)=>{},0)||(a.destroy(),a.isAvailable=!1,0))}}),this._lastCredentials={},this.getOSLocale=u?()=>"en_US":o.memoize(_.getOSLocale,{timeout:-1})}async init(){u||(_.setAuthenticationCallback((t,e)=>{const a=this._lastCredentials[t.proxy.host+t.proxy.port]||{};if(a.username===this.proxyUser&&a.password===this.proxyPassword){const a=new Error(`No new credentials for ${t.proxy.host}:${t.proxy.port}`);a.code="PROXY",e(a)}else if(this.proxyUser)a.username=this.proxyUser,a.password=this.proxyPassword,e(null,a),this._lastCredentials[t.proxy.host+t.proxy.port]=a;else{const a=new Error(`No credentials present for ${t.proxy.host}:${t.proxy.port}`);a.code="PROXY",e(a)}}),_.on("change",()=>{n.disk("System proxy settings changed"),this.getNodeTunnelOptionsForURL.cache.clear(),this.emit("change",!0)}),this._ca=await f.getRootCA().catch(t=>{n.error(t,"Error getting Root CA")}),l.options.ca=this._ca)}async _getNodeTunnelOptionsForURL(t){var e;let a=u?void 0:await f.resolve(t).catch(t=>{n.error(t,"Error getting proxy settings")});const s=(a=a&&a[0])&&a.agentClass||(t.startsWith("https")?c.Agent:d.Agent),r=a&&a.agentOptions||{},i={};r.ca=this._ca,r.keepAlive=!0,r.keepAliveMsecs=1e3,r.maxFreeSockets=5;const o=r.proxy?r.proxy.host+r.proxy.port:t.startsWith("https")?"https":"http";if(p[o]=(null===(e=p[o])||void 0===e?void 0:e.isAvailable)?p[o]:new s(r),p[o].isAvailable=!0,i.agent=p[o],a.agent){const e=`${a.hostname}:${a.port}${this.proxyUser?" with":" without"} authentication`;n.disk(`Setting proxy for ${t}: ${e}`),i.details=e}else n.disk(`No proxy (direct connection) for ${t}`),i.details="No Proxy";return i}setProxyCredentials(t,e){this.proxyUser===t&&this.proxyPassword===e||(n.disk("Setting proxy username and password"),this.proxyUser=t,this.proxyPassword=e,this.getNodeTunnelOptionsForURL.cache.clear(),this.emit("change",!1))}getProxyCredentials(){return{user:this.proxyUser,password:this.proxyPassword}}clearCache(){this.getNodeTunnelOptionsForURL.cache&&this.getNodeTunnelOptionsForURL.cache.clear(),this.proxyUser=void 0,this.proxyPassword=void 0,this._lastCredentials={}}}},function(t,e,a){"use strict";a.d(e,"a",function(){return p});var s=a(0),r=a(12),i=a(6),o=a(3),n=a(1),c=a(13);function d(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function l(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?d(Object(a),!0).forEach(function(e){u(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):d(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function u(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}class p{constructor(t,e){u(this,"lock",void 0),u(this,"log",void 0),u(this,"assetsDir",void 0),this.log=new r.default({prefix:`${s.default.get("LOG_PREFIX",t)}DataManager`,payload:{"event.subcategory":s.default.get("ANALYTICS_SUBCATEGORY",t)}}),this.assetsDir=o.join(s.default.get("ROOT_DIR"),s.default.get("DIR",t),s.default.get("ASSETS_DIRNAME"))+"/",this.lock=e}async downloadAEMData({card:t,lookupMap:e,priority:a,bundle:r,params:d,started:u,force:p}){let _=0,f=0,h={},g="",E="";if("URL"===t.dataType&&t.data||t.contentURL){E="URL"===t.dataType&&t.data?"data":"contentURL";const s=await e.fetchAsset({href:t[E],assetsDir:this.assetsDir,priority:a,params:d,force:l(l({},p),{},{depth:(p.depth||0)-1})})||{};_++,f+=s.time,g=o.basename(s.path),h=await i.readJson(`${this.assetsDir}/${g}`),t.path=s.path}else{if("application/json"!==t.dataType||!t.data)return{totalTime:f,count:_};h=JSON.parse(t.data),g=e.generateId(d)+".json",g=o.basename(await c.default.writeJsonAtomic(this.assetsDir,g,h,!0)),t.path=s.default.get("ASSETS_DIRNAME")+"/"+g}if(u(),h.data)for(let s of Object.values(h.data))Array.isArray(s._references)&&await n.default.waitAll(s._references.map(async t=>{if(t._publishUrl){const s=await e.fetchAsset({href:t._publishUrl,assetsDir:this.assetsDir,priority:a,params:d,force:l(l({},p),{},{depth:(p.depth||0)-2})});t.path=s.path,s.time&&(_++,f+=s.time)}})).finally(async()=>{await this.lock.write(async()=>{if(t.path=o.basename(this.assetsDir)+"/"+o.basename(await c.default.writeJsonAtomic(this.assetsDir,g,h,!0)),E.length>0){var a;(null===(a=e.cachedAsset(t[E]))||void 0===a?void 0:a.path)!==t.path&&e.cachedAsset(t[E])&&(e.cachedAsset(t[E]).path=t.path,await e.save())}})});return{totalTime:f,count:_}}async downloadIndexFileData({card:t,lookupMap:e,priority:a,bundle:r,params:d,started:u,force:p}){var _;let f=0,h=0,g={},E="",y="";if("URL"===t.dataType&&t.data||t.contentURL){y="URL"===t.dataType&&t.data?"data":"contentURL";const s=await e.fetchAsset({href:t[y],assetsDir:this.assetsDir,priority:a,params:d,force:l(l({},p),{},{depth:(p.depth||0)-1})})||{};f++,h+=s.time,E=o.basename(s.path),g=await i.readJson(`${this.assetsDir}/${E}`),t.path=s.path}else{if("application/json"!==t.dataType||!t.data)return{totalTime:h,count:f};g=JSON.parse(t.data),E=e.generateId(d)+".json",E=o.basename(await c.default.writeJsonAtomic(this.assetsDir,E,g,!0)),t.path=s.default.get("ASSETS_DIRNAME")+"/"+E}if(u(),null===(_=g)||void 0===_?void 0:_.paths){g._assetPaths={};let s=Object.keys(g.paths);await n.default.waitAll(s.map(async t=>{var s,r;if(null===(s=g)||void 0===s?void 0:null===(r=s.paths)||void 0===r?void 0:r[t]){var i,o;const s=await e.fetchAsset({href:null===(i=g)||void 0===i?void 0:null===(o=i.paths)||void 0===o?void 0:o[t],assetsDir:this.assetsDir,priority:a,params:d,force:l(l({},p),{},{depth:(p.depth||0)-2})});g._assetPaths[t]=s.path,s.time&&(f++,h+=s.time)}})).finally(async()=>{await this.lock.write(async()=>{if(t.path=o.basename(this.assetsDir)+"/"+o.basename(await c.default.writeJsonAtomic(this.assetsDir,E,g,!0)),y.length>0){var a;(null===(a=e.cachedAsset(t[y]))||void 0===a?void 0:a.path)!==t.path&&e.cachedAsset(t[y])&&(e.cachedAsset(t[y]).path=t.path,await e.save())}})})}return{totalTime:h,count:f}}async downloadContentfulData({card:t,lookupMap:e,priority:a,urlKey:s,bundle:r,params:d,started:u,force:p}){if(!t[s]||0===t[s].length)return{count:0,totalTime:0};let _=0,f=0;const h=await e.fetchAsset({href:t[s],assetsDir:this.assetsDir,priority:a,params:d,force:l(l({},p),{},{depth:(p.depth||0)-1})})||{};_++,f+=h.time;const g=o.basename(h.path),E=await i.readJson(`${this.assetsDir}/${g}`);return r&&(t.content=E),t.path=h.path,u(),E.includes&&Array.isArray(E.includes.Asset)&&await n.default.waitAll(E.includes.Asset.map(async t=>{if(t.fields&&t.fields.file&&t.fields.file.url){const s=await e.fetchAsset({href:t.fields.file.url,assetsDir:this.assetsDir,priority:a,params:d,force:l(l({},p),{},{depth:(p.depth||0)-2})});t.fields.file.path=s.path,s.time&&(_++,f+=s.time)}})).finally(async()=>{await this.lock.write(async()=>{var a;t.path=o.basename(this.assetsDir)+"/"+o.basename(await c.default.writeJsonAtomic(this.assetsDir,g,E,!0)),(null===(a=e.cachedAsset(t[s]))||void 0===a?void 0:a.path)!==t.path&&e.cachedAsset(t[s])&&(e.cachedAsset(t[s]).path=t.path,await e.save())})}),{count:_,totalTime:f}}async downloadLegacyData({card:t,lookupMap:e,priority:a,params:s}){if(!t.backgroundImage||0===t.backgroundImage.length)return{count:0,totalTime:0};let r,i=null;try{i=(r=await e.fetchAsset({href:t.backgroundImage,assetsDir:this.assetsDir,priority:a,params:s})).path}catch(s){if(404!==s.statusCode||0===t.backgroundImage.indexOf("1000x560"))throw s;t.backgroundImage=t.backgroundImage.replace("1000x560","730x280"),i=(r=await e.fetchAsset({href:t.backgroundImage,assetsDir:this.assetsDir,priority:a})).path}return t.backgroundImageLocalpath=i,{count:1,totalTime:r.time}}async downloadData({modeID:t,card:e,lookupMap:a,priority:s,bundle:r=!1,params:i={},started:o=(()=>{}),force:n={type:"none"}}){try{switch(t){case"CCX_Start_2.5_Learn":case"CCX_Start_2.5_Toast":case"CCX_Start_2.5_Home":return await this.downloadContentfulData({card:e,lookupMap:a,priority:s,urlKey:"contentURL",bundle:r,params:i,started:o,force:n});case"firstrun":case"footer":case"learn":case"discover":case"trial":case"openDoc":case"welcome":return await this.downloadLegacyData({card:e,lookupMap:a,priority:s,params:i});case"CCX_Start_3.0_Learn":case"CCX_Start_3.0_Home":case"CCX_Start_3.0_Toast":case"ACCC_ALL_APPS_BANNERS":case"ACCC_CATEGORIES_BANNERS":case"ACCC_APPS_CATALOG":case"ACCC_APP_SKELETON":case"CCX_Start_3.1_Learn":case"CCX_Start_3.1_Toast":case"CCX_Start_3.1_Home":case"CCX_Start_3.1_Whats_New":return await this.downloadContentfulData({card:e,lookupMap:a,priority:s,urlKey:"data",bundle:r,params:i,started:o,force:n});case"Discover_Panel":return await this.downloadIndexFileData({card:e,lookupMap:a,priority:s,bundle:r,params:i,started:o,force:n});case"CCX_Start_4.0_Home":case"CCX_Start_4.0_Whats_New":case"CCX_Start_4.0_Toast":case"CCD_ALL_APPS_BANNERS":case"CCD_APP_SKELETON":case"CCD_APPS_CATALOG":default:return await this.downloadAEMData({card:e,lookupMap:a,priority:s,bundle:r,params:i,started:o,force:n})}}catch(a){throw this.log.disk(`Error downloading content for ${t} ${a}, ${a.stack}, card: ${JSON.stringify(e)},`),a}}async getReferencedAssets(t,e){const a={};if(e.backgroundImageLocalpath)return{[`${e.backgroundImageLocalpath}`]:!0};switch(t){case"CCX_Start_3.0_Learn":case"CCX_Start_3.0_Home":case"CCX_Start_3.0_Toast":case"CCX_Start_2.5_Learn":case"CCX_Start_2.5_Toast":case"CCX_Start_2.5_Home":case"ACCC_ALL_APPS_BANNERS":case"ACCC_CATEGORIES_BANNERS":case"ACCC_APPS_CATALOG":case"ACCC_APP_SKELETON":case"CCX_Start_3.1_Learn":case"CCX_Start_3.1_Toast":case"CCX_Start_3.1_Home":case"CCX_Start_3.1_Whats_New":let s=e.content;if(e.path){a[e.path]=!0;const t=o.basename(e.path);s=await i.readJson(`${this.assetsDir}/${t}`).catch(()=>{delete a[e.path]})}return s&&s.includes&&Array.isArray(s.includes.Asset)&&s.includes.Asset.forEach(t=>{t.fields&&t.fields.file&&t.fields.file.path&&(a[t.fields.file.path]=!0)}),a;case"Discover_Panel":a[e.path]=!0;const r=o.basename(e.path);let n=await i.readJson(`${this.assetsDir}/${r}`).catch(()=>(delete a[e.path],{}));return(null==n?void 0:n._assetPaths)&&(Object.keys(n._assetPaths)||[]).forEach(t=>{a[n._assetPaths[t]]=!0}),a;case"CCX_Start_4.0_Home":case"CCX_Start_4.0_Whats_New":case"CCX_Start_4.0_Toast":case"CCD_ALL_APPS_BANNERS":case"CCD_APP_SKELETON":case"CCD_APPS_CATALOG":default:if(e.path){a[e.path]=!0;const t=o.basename(e.path);let s=await i.readJson(`${this.assetsDir}/${t}`).catch(()=>(delete a[e.path],{}));if(s&&s.data)for(const t of Object.values(s.data))Array.isArray(t._references)&&t._references.forEach(t=>{t.path&&(a[t.path]=!0)})}return a}}}},function(t,e,a){"use strict";a.d(e,"a",function(){return i});var s=a(14);const r=a(1).default;class i{static stripPathFromURL(t){if("string"!=typeof t)return;const e=s.parse(t);return e.protocol&&e.host?`${e.protocol}//${e.host}`:void 0}static getRetryAfterHeader(t){if(t){const e=t.get("retry-after");if(e)try{const t=parseInt(e,10);if(t)return Math.max(0,t);const a=new Date(e);if(!isNaN(a)){const t=(new Date).valueOf(),e=Math.max(0,a-t),s=r.getRandomizedTime();return Math.round((e+s)/1e3)}}catch(t){}}return 0}static getExpiry(t){let e=t.get("expiry")?new Date(t.get("expiry")||""):void 0;const a=t.get("cache-control");if(a&&"string"==typeof a&&a.includes("max-age=")){const t=parseInt(a.split("max-age=")[1].trim(),10);t&&(e=new Date).setSeconds(t)}if(e&&!isNaN(e)&&e>new Date)return e.toISOString()}static getContentTypeHeader(t){if(t){let e=t.get("content-type");if(e&&"string"==typeof e){const t=e.indexOf(";");return t>0&&(e=e.substring(0,t)),e}}}}},function(t,e){t.exports=require("xml2js")},function(t,e){t.exports=require("util")},function(t,e){t.exports=require("@ccx/parallel-fetch")},function(t,e){t.exports=require("fs")},function(t,e,a){"use strict";var s=a(6),r=a(0),i=a(17);function o(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}const n=new class extends i.EventEmitter{constructor(...t){super(...t),o(this,"logFilePath",`${r.default.get("LOG_DIR")}CCX Process.log`),o(this,"prevLogFilePath",`${r.default.get("LOG_DIR")}CCX Process (prev).log`),o(this,"pendingLogWrite",void 0),o(this,"writingToLog",!1)}swapLogIfNeeded(t){s.stat(this.logFilePath,(e,a)=>{!e&&a.size>r.default.get("MAX_LOG_SIZE")?s.rename(this.logFilePath,this.prevLogFilePath,t):t(null)})}doLogWrite(){s.ensureDir(r.default.get("LOG_DIR"),t=>{if(t)return this.pendingLogWrite=void 0,void console.log(t);this.swapLogIfNeeded(t=>{if(t)return this.pendingLogWrite=void 0,void console.log(t);const e=this.pendingLogWrite;this.pendingLogWrite=void 0,this.writingToLog=!0,s.appendFile(this.logFilePath,e,t=>{t&&console.log(t),this.writingToLog=!1,this.pendingLogWrite&&this.doLogWrite(),this.emit("logWrite")})})})}log(...t){const e=t.join(": ");r.default.get("CONSOLE_LOGGING")&&e.match(new RegExp(process.argv[3]||".*"))&&console.log(e);const a=new Date,s=`${a.toString().replace(/(\d+\:\d+\:\d+)/,"$1."+a.getMilliseconds())} ${e}\n`;this.pendingLogWrite?this.pendingLogWrite+=s:(this.pendingLogWrite=s,this.writingToLog||this.doLogWrite())}};e.a=n},function(t){t.exports={name:"ccx-welcome-process",version:"4.3.2",private:!0,description:"CCXProcess",dependencies:{"@ccx/isRosetta":"git+ssh://git@git.corp.adobe.com:CCX/isRosetta.git#v0.0.1","@ccx/node-ProxyResolver":"git+ssh://git@git.corp.adobe.com:ProjectCentral/node-ProxyResolver.git#v2.0.1","@ccx/node-aid":"git+ssh://git@git.corp.adobe.com:CCX/node-aid.git#v0.0.6","@ccx/node-ngl":"git+ssh://git@git.corp.adobe.com:ProjectCentral/node-ngl.git#v1.24.1.2","@ccx/parallel-fetch":"0.0.31",decompress:"^4.2.1","fs-ext":"2.0.0","fs-extra":"8.1.0",ingest:"git+ssh://git@git.corp.adobe.com:CCX/Ingest.git#v4.2.0",jsonschema:"1.2.5",mime:"2.4.4",mkdirp:"^1.0.3","node-vulcanjs":"git+ssh://git@git.corp.adobe.com:slade/VulcanJS.git#v2.0.7","simple-plist":"^1.1.0",uuid:"3.3.3",winreg:"^1.2.4",xml2js:"0.4.23"},devDependencies:{"7zip":"0.0.6","@adobe/tessa-npm-plugin":"1.2.1","@babel/cli":"^7.1.2","@babel/core":"^7.1.2","@babel/plugin-proposal-class-properties":"^7.1.0","@babel/plugin-proposal-object-rest-spread":"^7.0.0","@babel/preset-env":"^7.1.0","@babel/preset-typescript":"^7.1.0","@ccx/hyperdrive-builder":"git+ssh://git@git.corp.adobe.com:CCX/hyperdrive-builder.git#v4.0.22","@types/core-js":"^2.5.0","@types/decompress":"^4.2.3","@types/es6-promise":"^3.3.0","@types/fs-ext":"0.0.29","@types/fs-extra":"5.0.4","@types/glob":"^7.1.1","@types/jest":"23.3.7","@types/mime":"^2.0.0","@types/mustache":"^4.0.1","@types/nock":"^9.3.0","@types/node":"^10.12.0","@types/uuid":"^3.4.4","@types/webpack":"^4.4.17","@types/winreg":"^1.2.4","@types/xml2js":"0.4.3","babel-loader":"^8.0.4",glob:"7.1.3",husky:"1.1.2",jest:"23.6.0","jest-date-mock":"1.0.5","jest-extended":"0.11.0",jsftp:"2.1.3",matchdep:"2.0.0",mockery:"2.1.0",mustache:"^4.0.1",nock:"10.0.1","node-gyp":"^6.1.0","node-uglifier":"0.5.41",prettier:"2.0.5","pretty-quick":"1.8.0","terser-webpack-plugin":"1.1.0","ts-jest":"23.10.4","ts-loader":"5.2.2","ts-node":"7.0.1","ts-node-dev":"^1.0.0-pre.30",typescript:"3.8",webpack:"4.23.0","webpack-node-externals":"1.7.2"},prettier:{tabWidth:4,useTabs:!1,singleQuote:!0,trailingComma:"all",printWidth:120,arrowParens:"avoid",endOfLine:"auto"},engines:{node:">=12.0.0"},scripts:{test:"jest",coverage:"jest --coverage",updateBuildCoverageComment:"ts-node packaging/updateCoverage",main:"ts-node-dev --no-deps --files main --debug",tessa:"tessa-npm-plugin update --yarn","tessa-plugin-pr":"tessa-npm-plugin check --errorOnNewVulnerability --yarn",kill:'pkill -f ".*CCXProcess.app/Contents/MacOS/../js/main.js$"',killWin:'cmd /C taskkill /f /im "CCXProcess.exe" /t',build:"ts-node --files packaging/build.ts compile","build:arm":"ts-node --files packaging/build.ts compile arm",package:"ts-node --files packaging/build.ts hyperdrive","package:arm":"ts-node --files packaging/build.ts hyperdrive arm",jira:"node packaging/jiraRestApi",preinstall:"node packaging/credentials",start:"node -p \"if (process.platform == 'darwin') { try { require('child_process').execSync('yarn run kill')} catch(err) {}} else { try { require('child_process').exec('yarn run killWin')} catch (err) {}} require('child_process').execSync('yarn run main', {stdio: [0,1,2]})\"",postinstall:"node packaging/fixDepsMac",installNoDepCopy:"NO_DEP_COPY=true yarn install"},cepPanels:[{NOTE:"REMOVING START 2.7 from the CCXPROCESS WILL CAUSE LEARN TAB TO GO MISSING IN FRESH INSTALLS OF CC 2019 APPS. ALSO DISABLE YBR NON 2.5 COMPATIBLE CAMPAIGNS BEFORE THIS",product:"CCX Start",subproduct:"Extension",version:"2.7.2",certification:"Not Tested",destination:"com.adobe.ccx.start-2.7.2",name:"com.adobe.ccx.start"},{product:"CCX Start",subproduct:"Extension",version:"2.16.0",certification:"Not Tested",destination:"com.adobe.ccx.start-2.16.0",name:"com.adobe.ccx.start"},{product:"CCX Start",subproduct:"CmdN",version:"3.5.0",certification:"Not Tested",destination:"com.adobe.ccx.fnft-3.5.0",name:"com.adobe.ccx.fnft"}],"UNINSTALLATION INSTRUCTIONS":{STEPS:"NAME THE KEY uninstall to uninstall extensions. The contents of the key add  an array objects each with a destination folder name and isCEP which is true if this is a CEP extension and false if this is a UXP extension.",SAMPLE:{uninstall:[{COMMENT:"The provided destination folder(com.adobe.ccx.start-2.6.1) in the CEP or UXP (CEP in this case) extension is deleted",destination:"com.adobe.ccx.start-2.6.1",isCEP:!0}]}},"uninstall-example":[{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.3.0) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.3.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.5.0) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.5.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.5.1) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.5.1",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.6.1) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.6.1",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.7.0) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.7.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.7.2) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.7.2",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.7.4) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.7.4",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.8.0) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.8.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.9.0) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.9.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.10.0) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.10.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.11.0) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.11.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.12.0) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.12.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.13.0) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.13.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2.14.0) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2.14.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-2019) in CEP extensions is deleted",destination:"com.adobe.ccx.start-2019",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.start-3.1.0) in UXP extensions is deleted",destination:"com.adobe.ccx.start-3.1.0",isCEP:!1},{COMMENT:"The provided destination folder (com.adobe.ccx.start-3.2.0) in UXP extensions is deleted",destination:"com.adobe.ccx.start-3.2.0",isCEP:!1},{COMMENT:"The provided destination folder (com.adobe.ccx.start-3.3.0) in UXP extensions is deleted",destination:"com.adobe.ccx.start-3.3.0",isCEP:!1},{COMMENT:"The provided destination folder (com.adobe.ccx.start-3.4.0) in UXP extensions is deleted",destination:"com.adobe.ccx.start-3.4.0",isCEP:!1},{COMMENT:"The provided destination folder (com.adobe.ccx.start-3.5.0) in UXP extensions is deleted",destination:"com.adobe.ccx.start-3.5.0",isCEP:!1},{COMMENT:"The provided destination folder (com.adobe.ccx.start-3.6.0) in UXP extensions is deleted",destination:"com.adobe.ccx.start-3.6.0",isCEP:!1},{COMMENT:"The provided destination folder (com.adobe.ccx.start-3.7.0) in UXP extensions is deleted",destination:"com.adobe.ccx.start-3.7.0",isCEP:!1},{COMMENT:"The provided destination folder (com.adobe.ccx.start.uxp-2019) in UXP extensions is deleted",destination:"com.adobe.ccx.start.uxp-2019",isCEP:!1},{COMMENT:"The provided destination folder (com.adobe.ccx.fnft-2.5.0) in CMDN extensions is deleted",destination:"com.adobe.ccx.fnft-2.5.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.fnft-2.5.1) in CMDN extensions is deleted",destination:"com.adobe.ccx.fnft-2.5.1",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.fnft-2.6.0) in CMDN extensions is deleted",destination:"com.adobe.ccx.fnft-2.6.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.fnft-3.0.0) in CMDN extensions is deleted",destination:"com.adobe.ccx.fnft-3.0.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.fnft-3.1.0) in CMDN extensions is deleted",destination:"com.adobe.ccx.fnft-3.1.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.fnft-3.2.0) in CMDN extensions is deleted",destination:"com.adobe.ccx.fnft-3.2.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.fnft-3.3.0) in CMDN extensions is deleted",destination:"com.adobe.ccx.fnft-3.3.0",isCEP:!0},{COMMENT:"The provided destination folder (com.adobe.ccx.fnft-3.4.0) in CMDN extensions is deleted",destination:"com.adobe.ccx.fnft-3.4.0",isCEP:!0}],uxpPanels:[{product:"CCX Start",subproduct:"HomeScreenUXP",version:"4.2.0",certification:"Not Tested",destination:"com.adobe.ccx.start-4.2.0",name:"com.adobe.ccx.start.{{build}}"}],thor:[{product:"ACCC",subproduct:"Application",version:"5.4.1",certification:"Product Team Only",name:"ACCCx5_4_1_{{build}}",volume:"Creative Cloud",build:"^\\d+$"},{product:"ACCC",subproduct:"HDSetup",version:"5.4.1",certification:"Product Team Only",name:"HDSetup",volume:"Release"}],resolutions:{"ffi-napi":"2.4.7","ref-napi":"1.4.2",xml2js:"0.4.23","node-fetch":"3.0.0-beta.7"},husky:{hooks:{"pre-commit":"pretty-quick --staged"}}}},function(t,e){t.exports=require("node-vulcanjs")},function(t,e,a){"use strict";a.r(e),a.d(e,"Avatar",function(){return E}),a.d(e,"getFileName",function(){return y});var s=a(4),r=a(13),i=a(16),o=a(0),n=a(6),c=a(12),d=a(5),l=a(1),u=a(2);function p(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function _(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?p(Object(a),!0).forEach(function(e){f(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):p(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function f(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}const h=864e5;class g extends i.default{constructor(){super("AVATAR")}}class E{constructor(){f(this,"downloadManager",void 0),f(this,"log",void 0),f(this,"loaded",!1),f(this,"loading",!1),this.downloadManager=new g,this.log=new c.default({prefix:"Avatar > ",payload:{"event.subcategory":o.default.analytics.sc_AVATAR,"event.subtype":o.default.analytics.st_NETWORK}}),s.default.on("SIGN_IN",()=>this.init())}async init(){try{this.loaded=!1,this.loading=!0;const t=await Promise.race([await this.downloadAvatar(),l.default.setTimeoutAsync(2e3)]);o.default.set("avatar",_(_({},t||await this.getCachedAvatar()),{},{expiry:h+Date.now()}),s.default.getUserId()),this.loading=!1,this.loaded=!0}catch(t){this.log.error(new u.default("Error updating avatar",t)),this.loading=!1}setTimeout(()=>this.init(),h)}async getAvatar(){this.loaded||this.loading||this.init();let t=0;for(;!this.loaded&&t<3e5;)t+=500,await l.default.setTimeoutAsync(500);return o.default.get("avatar",s.default.getUserId())}async getCachedAvatar(){const t=o.default.get("avatar",s.default.getUserId());return t&&await n.pathExists(t.path)?t:{url:"",path:""}}async downloadAvatar(){try{const t=`${E.profileUrl}/${s.default.getUserId()}`,{response:e}=await this.downloadManager.get({url:t,priority:new d.Priority({channel:d.PriorityChannels.Avatar})});let a=`${o.default.get("ROOT_DIR")}${y(e.url)}`;return{path:a=await r.default.writeAtomic({response:e,target:a,renameOnError:!0}),url:t}}catch(t){return this.log.error(t),{url:"",path:""}}}static get profileUrl(){return o.default.getEnvironment().PROFILE_URL}}function y(t){const e=t?t.split("/").pop():"";return(e?e.split("?")[0]:"")||null}const m=new E;e.default=m},function(t,e){t.exports=require("v8")},function(t,e){t.exports=require("https")},function(t,e){t.exports=require("jsonschema")},function(t,e){t.exports=require("dns")},function(t,e){t.exports=require("fs-ext")},function(t,e){t.exports=require("decompress")},function(t,e){t.exports=require("mime")},function(t,e){t.exports=require("abort-controller")},function(t,e){t.exports=require("simple-plist")},function(t,e,a){t.exports=a(41)},function(t,e,a){const s=a(42).Module,r=s._nodeModulePaths.bind(s);s._nodeModulePaths=(t=>r(t).filter(t=>t.startsWith(__dirname)));const i=a(31),o=a(43);i.setFlagsFromString("--expose_gc"),i.setFlagsFromString("--max_heap_size=100"),i.setFlagsFromString("--optimize-for-size"),global.gc=o.runInNewContext("gc"),setTimeout(function t(){global.gc(),setTimeout(t,3e4)},3e4);const n=a(44);t.exports=(new n).init()},function(t,e){t.exports=require("module")},function(t,e){t.exports=require("vm")},function(t,e,a){const s=a(0).default,r=a(1).default,i=a(12).default,o=a(51).default,n=a(4).default,c=a(13).default,d=a(7).default,l=a(7).BackOffType,u=a(52).default,p=a(20),_=a(54),f=a(65).default,h=a(61).default,g=a(62).default,E=a(66).default,y=a(63).default,m=a(64).default,T=a(56).default,O=a(10).default,S=a(15).default,A=a(16).default,I=a(5).PriorityLevels,C=a(2).default,N=a(8).default,R=a(30).default,v=(a(6),a(11),a(3),a(57),a(58)),P=a(31),D=a(59).default;t.exports=class{constructor(){i.init(),this.log=new i({prefix:"Main > ",payload:{"event.subcategory":s.analytics.sc_PROCESS,"event.subtype":s.analytics.st_PROCESS}}),o.startPoll(),P.setFlagsFromString("--max_heap_size=100"),this.stockLookupMap=new m,this.firstMileLookupMap=new f,this.learnLookupMap=new h,this.maps=[this.firstMileLookupMap,this.stockLookupMap,this.learnLookupMap,new g,new y,new E],this.lastKnownCredentials={},this.serviceInterface=new T(this.maps)}exec(t,e){return new Promise((a,s)=>v.exec(t,e,(t,e)=>t?s(t):a(e)))}async sync(t=this.maps,e={type:"none"}){n.getUserId()&&await r.waitAll(t.map(async t=>{await t.sync(e).catch(e=>{this.log.disk(e,`Failed to sync ${t.type}`)})}))}async updateLookupMapWithInstalledApps(){await r.waitAll(this.maps.map(async t=>{const e=await u.getMissingProductList(t);await r.waitAll((await t.updateParams(e)).map(async e=>await t.addNewCollectionData({params:e}))),(await u.getExcessProductList(t.getCachedRequestData())).forEach(e=>{t.uninstall(e)})}))}setProxyCredentials(t,e){t&&this.lastKnownCredentials.user!==t&&this.lastKnownCredentials.password!==e&&(this.lastKnownCredentials={user:t,password:e},p.setProxyCredentials(t,e),this.sync())}setUserAnalyticsFlag(t){O.enable(t)}prefetchData(){if(!n.getUserId())return;const t=r.getClientsThatNeedRefresh(this.firstMileLookupMap);Object.keys(t).forEach(e=>{t[e].forEach(t=>{const a=JSON.parse(JSON.stringify(t));a.ccxVersion=s.get("START_VERSION",e),delete a.radarSessionGUID,delete a.requestId,this.firstMileLookupMap.isRequestPoisoned(a)||this.firstMileLookupMap.addNewCollectionData({params:a}).catch(t=>this.log.context({params:a}).disk(t,"Error pre-fetching"))})})}async addProductInfoToLookup(t,e){await r.waitAll(this.maps.map(async a=>{const i=s.get("SUPPORTED_PRODUCTS",a.type);i[t.productCode]&&1!==r.compareMajorMinorVersions(t.productVersion,i[t.productCode])&&await r.waitAll((await a.updateParams([t])).map(async s=>{await a.addNewCollectionData({params:s,priorityLevel:e}).catch(e=>{this.log.context({params:t}).disk(e,`Error adding new ${a.type} product`)})}))}))}async forceRefresh(t,e){const a=new i({prefix:"Force Refresh > ",payload:{"event.workflow":s.analytics.w_NOTIFICATION,"event.subcategory":s.analytics.sc_FORCE_REFRESH}});if(r.validateDataFields(e,s.get("FORCE_REFRESH_SCHEMA"))){const t=new C(O.DATA_VALIDATION_ERR,`Invalid data: ${JSON.stringify(e)}`);throw a.error(t),t}try{const{expire:r={},force:i={type:"stale"}}=e,o=Object.keys(r).filter(t=>!!this.maps.find(e=>e.type===t)),c=this.maps.filter(t=>o.includes(t.type));if(c.length<1)return;d.updateBackOff({clear:!0,type:l.NETWORK,sync:!1}),d.updateBackOff({clear:!0,type:l.AUTH,sync:!1}),a.context({payload:{"event.subtype":s.analytics.st_RECEIVED,"event.value":o.join(", ")}}).info(s.analytics.t_REQUEST),await Promise.all(c.map(async e=>{const a=[];return t&&a.push(e.setLastTimeOfNotification(t)),!0===r[e.type]?await e.expireAll(n.getUserId()):((r[e.type]||[]).forEach(t=>{"PHSP"===t.productCode&&(t.productCode="PHXS"),a.push(e.forceRefresh(t))}),await Promise.all(a))})),await this.sync(c,i),a.context({payload:{"event.subtype":s.analytics.st_FINISHED,"event.value":o.join(", ")}}).info(s.analytics.t_REQUEST)}catch(t){a.error(t)}}async registerNotifications(){this.log.info(s.analytics.t_START),n.on("SIGN_OUT",()=>this.setUserAnalyticsFlag(!1)),S.on(S.ONLINE,r.throttle(()=>{this.log.disk("Network status back to online."),d.updateBackOff({clear:!0,type:l.NETWORK,sync:!1}),d.updateBackOff({clear:!0,type:l.AUTH,sync:!1}),this.sync()},s.get("ONLINE_SYNC_THROTTLE"))),d.on(d.SYNC,r.throttle(()=>{this.log.disk("Global backoff over, syncing data."),this.sync()},s.get("GLOBAL_BACKOFF_SYNC_THROTTLE"))),n.on("SIGN_IN",()=>{n.getUserId(),_.getUserAnalyticsEnabledFlag().then(({enabled:t})=>{this.setUserAnalyticsFlag(t)}),this.sync(),this.updateLookupMapWithInstalledApps(),this.prefetchData()}),_.addListener(_.events.PROXY_SETTINGS_CHANGED,(t,e)=>{this.setProxyCredentials(t,e)}),_.addListener(_.events.FORCE_REFRESH,(t,e)=>{this.forceRefresh(t,e)}),_.addListener(_.events.PROFILE_UPDATED,async t=>{t&&await this.firstMileLookupMap.setLastTimeOfNotification(t),await this.sync([this.firstMileLookupMap],{type:"always"})}),_.addListener(_.events.SUBSCRIPTION_STATUS_CHANGED,async t=>{t&&(await this.firstMileLookupMap.setLastTimeOfNotification(t),await this.stockLookupMap.setLastTimeOfNotification(t)),await this.sync([this.firstMileLookupMap])}),_.addListener(_.events.UPDATE_STOCK,async t=>{t&&await this.stockLookupMap.setLastTimeOfNotification(t),await this.sync([this.stockLookupMap],{type:"always"})}),_.addListener(_.events.INSTALL_APPLICATION,t=>{this.log.context({params:t}).disk("Handle installApplication"),this.addProductInfoToLookup(t,I.Installation)});const t={};if(_.addListener(_.events.UPDATE_APPLICATION,async e=>{var a;const s=(await N.getInstalledApps())[e.productCode];t[e.productCode]=Object.assign(null!=s?s:{},null!==(a=t[e.productCode])&&void 0!==a?a:{}),this.log.context({params:e}).disk("Handle updateApplication event"),this.addProductInfoToLookup(e,I.Installation),await r.setTimeoutAsync(1e3),N.clearInstalledAppsCache();const i=(await N.getInstalledApps())[e.productCode];await r.waitAll(Object.keys(t[e.productCode]).map(async a=>{i[a]||await r.waitAll(this.maps.map(async s=>{const i=t[e.productCode][a],o={productCode:i.SAPCode,productVersion:i.CodexVersion,productLanguage:e.productLanguage,countryCode:e.countryCode};await s.update(o,e),await r.waitAll(i.InstallLanguage.split(",").map(async t=>{o.productLanguage=t}))}))}))}),_.addListener(_.events.UNINSTALL_APPLICATION,async t=>{await r.setTimeoutAsync(1e3),this.log.context({params:t}).disk("Handle uninstallApplication event"),N.clearInstalledAppsCache();const e=await N.getInstalledApps();e[t.productCode]&&(e[t.productCode][t.productVersion]||e[t.productCode][t.productVersion+".0"])?this.log.disk("Ignoring uninstall as the version or alias is already installed."):(this.log.disk(`Removing ${t.productCode}[${t.productVersion}]`),this.maps.forEach(e=>e.uninstall(t)))}),p.addListener("change",async t=>{if(t){const{user:t,password:e}=await _.getProxyCredentials();this.setProxyCredentials(t,e)}}),_.registerANSNotifications(),n.getUserId()){const t=this.maps.map(t=>t.getLastTimeOfNotification());_.checkForMissedNotifications(t[0],t[1],Math.max(...t))}}async onLoadHouseKeeping(){await c.obtainProcessLock("lockfile").catch(t=>{"EAGAIN"===t.code||"EWOULDBLOCK"===t.code?this.log.disk("Unable to get lock. Process is already running"):this.log.error(t,"Failed to get Lockfile."),process.exit(1)}),this.log.info(s.analytics.t_INIT),Error.stackTraceLimit=1/0,process.on("uncaughtException",t=>this.log.error(t,"Uncaught Exception")),process.on("unhandledRejection",t=>this.log.error(t,"Uncaught Promise Rejection")),this.monitorHealth()}async monitorHealth(){const t=new Date(s.get("HEALTH_POLL")||"2010-01-01T00:00:00Z");if(t.setMilliseconds(s.get("HEALTH_POLL_INTERVAL")),t<new Date){const t=process.cpuUsage(),e=process.hrtime();await r.setTimeoutAsync(s.get("CPU_POLL_DURATION"));const a=process.cpuUsage(t),i=process.hrtime(e),o=(100*(a.system+a.user)/(1e6*i[0]+i[1]/1e3)).toFixed(2);this.log.context({payload:{"event.subcategory":"Metrics","event.subtype":"cpu","event.value":o}}).info(s.analytics.t_PERFORMANCE);const n=(await r.getDiskSize().catch(t=>(this.log.error(t,"Error getting disk size"),-1))/1048576).toFixed(2);this.log.context({payload:{"event.subcategory":"Metrics","event.subtype":"disk","event.value":n}}).info(s.analytics.t_PERFORMANCE);const c=(process.memoryUsage().rss/1048576).toFixed(2);this.log.context({payload:{"event.subcategory":"Metrics","event.subtype":"ram","event.value":c}}).info(s.analytics.t_PERFORMANCE),this.log.disk(`CPU: ${o}%, RAM: ${c}MB, Disk: ${n}MB `),s.set("HEALTH_POLL",(new Date).toISOString()),setTimeout(this.monitorHealth.bind(this),s.get("HEALTH_POLL_INTERVAL"))}else setTimeout(this.monitorHealth.bind(this),t.valueOf()-(new Date).valueOf())}preventQuitting(){setTimeout(this.preventQuitting.bind(this),999999)}async initNetwork(){await A.requestLock.write(async()=>{await p.init();const{user:t,password:e}=await _.getProxyCredentials();this.setProxyCredentials(t,e)})}async init(){this.log.disk("-------------------------Startup------------------------------"),this.log.disk(`Build version is ${r.getProcessVersion()}, Environment: ${s.getEnvironment().LABEL}`),await D.isKillSwitchEnabled((t,e)=>{t&&"ENOENT"!==t.code&&this.log.error(new C("Failed to enable admin download blocking.",t)),e&&this.log.disk(`Successfully updated admin settings: ${JSON.stringify(e)}`)}),await this.onLoadHouseKeeping(),await S.check();for(const t of this.maps)await t.load().catch(e=>this.log.error(new C(`Failed to load lookup map ${t.type}`,e)));const t=this.initNetwork();await n.init(),this.serviceInterface.init(),await this.registerNotifications().catch(t=>{this.log.error(new C("Failed to register for notifications",t))}),await this.updateLookupMapWithInstalledApps().catch(t=>{this.log.error(new C("Failed to update lookup map on launch",t))});const{enabled:e}=await _.getUserAnalyticsEnabledFlag().catch(t=>{this.log.error(new C("Could not enable analytics",t))});return this.setUserAnalyticsFlag(e),R.init(),this.prefetchData(),await this.sync().catch(t=>{this.log.error(new C("Launch sync failed",t))}),this.preventQuitting(),await t.catch(t=>{this.log.error(new C("Failed to initialize network",t))}),this}}},function(t,e){t.exports=require("@ccx/isRosetta")},function(t,e){t.exports=require("@ccx/node-ngl")},function(t,e){t.exports=require("http")},function(t,e){t.exports=require("@ccx/node-ProxyResolver")},function(t,e){t.exports=require("node-fetch")},function(t,e){t.exports=require("ingest/src/ingest")},function(t,e,a){"use strict";a.r(e);var s=a(29),r=a(0),i=a(11),o=a(10),n=a(12);const c=s.createControlAdapter();const d=new class{constructor(){var t,e,a;t=this,e="log",a=new n.default({prefix:"HeartbeatProductAnalytics > "}),e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a}createOperationalPayload(t){const e={};return e["event.workflow"]=r.default.analytics.w_INTERNAL,e["event.subcategory"]=r.default.analytics.sc_PULSE,e["event.type"]=r.default.analytics.t_APP,e["event.subtype"]=r.default.analytics.st_RUNNING,e["source.name"]=t.SAPCode,e["source.version"]=t.CodexVersion,e["source.platform"]=i.platform(),e["source.device"]="Desktop",e["source.os_version"]=i.release(),e}sendPollingEvent(){c.getInstalledApps().filter(t=>t.SAPCode&&c.isAppRunning(t.SAPCode)).forEach(t=>{const e=this.createOperationalPayload(t);this.log.disk(`App Running: ${t.SAPCode}:${t.CodexVersion}`),o.default.logPollingEvent(e)})}startPoll(){setInterval(()=>this.sendPollingEvent(),r.default.get("ANALYTICS_HEARTBEAT_INTERVAL"))}};e.default=d},function(t,e,a){"use strict";a.r(e),a.d(e,"default",function(){return n});var s=a(0),r=a(12),i=a(1);const o=a(8).default;class n{static async getMissingProductList(t){const e=t.getCachedRequestData(),a=new r.default({prefix:`LookupMapUtils > ${t.type}`}),n=s.default.get("SUPPORTED_PRODUCTS",t.type),c=[],d=await o.getSpecifiers();return await Promise.all(Object.keys(d).map(async t=>{const s=i.default.getProductAlias(t);return Promise.all(Object.keys(d[t]).map(async r=>{const d=await o.getAppLanguage(t,r);if(d&&s&&n[s]&&i.default.compareMajorMinorVersions(n[s],r)>-1){const t=e[s],i=t&&(t[r]||t[`${r}.0`]),o=i&&i.find(t=>void 0===t.productLanguage||t.productLanguage===d);t&&i&&o||(a.disk("App NOT found, Adding : ",s,r,d),c.push({productCode:s,productVersion:r,productLanguage:d}))}}))})),c}static async getExcessProductList(t){const e=[];Object.values(t).forEach(t=>{Object.values(t).forEach(t=>{e.push(...t)})});const a=await o.getSpecifiers(),s=[];return await Promise.all(Object.keys(a).map(async t=>{const e=i.default.getProductAlias(t);Object.keys(a[t]).map(async t=>{e&&t&&s.push({productCode:e,productVersion:t})})})),e.filter(t=>!s.find(e=>e.productCode===t.productCode&&(e.productVersion===t.productVersion||t.productVersion===e.productVersion+".0")))}}},function(t,e){t.exports=require("@ccx/node-aid")},function(t,e,a){const s=a(9),r=a(23),i=a(8).default,o=a(0).default,n=a(17),c=a(12).default,d=a(2).default,l=a(10).default,u=a(4).default,p=a(1).default,_="com.adobe.aam.AAMIMSStatus",f="com.adobe.aam.AAMSIGNOUTStatus",h="accc.app.ProxySettingsRequest",g="accc.app.ProxySettingsResponse",E="any.accc.app.ProxySettingsChanged",y="accc.localapps.panel.refresh.ssoevent",m="any.accc.app.UserContextData",T="accc.app.UserContextDataRequest",O="adbproduct.app.UserContextDataResponse",S="any.accc.app.ProductDeploymentEvent",A='<?xml version="1.0" encoding="utf-8"?><request><type>accc.app.ProxySettingsRequest</type><request_id>{{uuid}}</request_id></request>',I='<?xml version="1.0" encoding="utf-8"?><NEMessage action="RegisterObserver"><type>{{NOTIFICATION_TYPE}}</type><sub-type>{{NOTIFICATION_SUB_TYPE}}</sub-type><observer-namespace>{{observer-namespace}}</observer-namespace></NEMessage>',C='<?xml version="1.0" encoding="utf-8"?><NEMessage action="GetDataByTime"><timestamp>{{TIME_STAMP}}</timestamp><type>{{NOTIFICATION_TYPE}}</type><notifications-count-limit>{{NOTIFICATION_COUNT}}</notifications-count-limit><request-context>{{uuid}}</request-context><requestor-namespace>{{requestor-namespace}}</requestor-namespace></NEMessage>',N='<?xml version="1.0" encoding="utf-8"?><NEMessage action="GetDataByID"><notification-ids>{{NOTIFICATION_IDS}}</notification-ids><request-context>{{uuid}}</request-context><requestor-namespace>{{requestor-namespace}}</requestor-namespace></NEMessage>',R='<?xml version= "1.0" encoding= "utf-8"?><request><request-id>{{uuid}}</request-id></request>',v=new r.Parser;class P extends n{constructor(){super(),this.log=new c({prefix:"CCNotifications > ",payload:{"event.subcategory":o.analytics.sc_PROCESS,"event.subtype":o.analytics.st_ANS}}),this.events={SIGN_IN:"signIn",SIGN_OUT:"signOut",PROXY_SETTINGS_CHANGED:"proxySettingsChanged",PROFILE_UPDATED:"profileUpdated",INSTALL_APPLICATION:"installApplication",UNINSTALL_APPLICATION:"uninstallApplication",UPDATE_APPLICATION:"updateApplication",SUBSCRIPTION_STATUS_CHANGED:"subscriptionStatusChanged",UPDATE_STOCK:"updateStock",UPDATE_APPLICATION_COMPONENTS:"updateApplicationComponents",USER_ANALYTICS_CHANGED:"userAnalyticsChanged",FORCE_REFRESH:"forceRefresh"},this.addListeners()}getMessageValue(t,e){let a=null;if(t){const s=new RegExp(`<${e}[^<>]*>([^<>]*)</${e}>`,""),r=t.match(s);a=r&&r[1]}return a}constructMessage(t,e){let a=t;return Object.keys(e).forEach(t=>{a=a.replace(t,e[t])}),a}normalizeProductCode(t){return p.getProductAlias(t)}addListeners(){i.addListener(y,t=>{const e=this.getMessageValue(t,"event_type");this.log.disk(`ACCC Sign-on State: ${e}`),"signin_success"===e?this.emit(this.events.SIGN_IN):"signout_success"===e&&this.emit(this.events.SIGN_OUT)}),i.addListener("accc.any.NoListenerAvailable",t=>{this.log.error(`No Listener Available: ${t}`)}),i.addListener(_,t=>{const e=this.getMessageValue(t,"Status");this.log.disk(`AAM Sign-on State: ${e}`),"USER_AUTH_SUCCESS"===e&&this.emit(this.events.SIGN_IN)}),i.addListener(f,t=>{this.emit(this.events.SIGN_OUT),this.log.disk("AAM Sign-on State: signOut")}),i.addListener(m,t=>{const e=o.get(u.getUserId(),"USER_ANALYTICS_ENABLED")||!1;if(!t)return this.log.error(new d(o.analytics.PARSE_MSG_FAIL,"Fail to receive user analytics message on sign in")),void l.enable(e);v.parseString(t,(t,a)=>{if(t||!a)return this.log.error(new d(o.analytics.PARSE_MSG_FAIL,`Fail to parse user analytics flag on update, err=${t}`)),void l.enable(e);if(a.response&&a.response.error)return this.log.error(new d(o.analytics.PARSE_MSG_FAIL,`Error in user analytics flag on update, err=${JSON.stringify(a.response.error)}`)),void l.enable(e);const s=a["feature-response"]&&a["feature-response"]["feature-entry"]&&a["feature-response"]["feature-entry"].find((t,e)=>"com.adobe.oobe.acc.v1.piip.user.status"===t.$.id);if(s&&s.$){this.log.disk(`GetUserAnalyticsFlag - Successfully updated user analytics enabled flag: ${s.$.state}`);const t="OptedIn"===s.$.state;return l.enable(t),void o.set(u.getUserId(),t,"USER_ANALYTICS_ENABLED")}return this.log.error(new d(o.analytics.PARSE_MSG_FAIL,`Fail to parse userAnalyticsStatus, userAnalyticsStatus=${s}`)),void l.enable(e)})}),i.addListener(E,t=>{const e=this.getMessageValue(t,"proxyuser"),a=this.getMessageValue(t,"proxypassword");null!==e&&null!==a&&this.emit(this.events.PROXY_SETTINGS_CHANGED,e,a)}),i.addListener(S,t=>{const e={productCode:this.getMessageValue(t,"productCode"),productVersion:this.getMessageValue(t,"productVersion"),productLanguage:this.getMessageValue(t,"productLanguage"),countryCode:this.getMessageValue(t,"countryCode")};if(e.productCode=this.normalizeProductCode(e.productCode),o.get("PRODUCT_LIST").includes(e.productCode))switch(this.getMessageValue(t,"eventType")){case"Install":case"Install-Start":case"Install-Progress":this.emit(this.events.INSTALL_APPLICATION,e);break;case"Uninstall":this.emit(this.events.UNINSTALL_APPLICATION,e);break;case"Update":case"Update-Start":case"Update-Progress":this.emit(this.events.UPDATE_APPLICATION,e);break;case"UpdateComponents":0!==P.listenerCount(this.events.UPDATE_APPLICATION_COMPONENTS)&&(e.productID=this.getMessageValue(t,"productID"),this.emit(this.events.UPDATE_APPLICATION_COMPONENTS,e))}}),i.addListener(o.get("NOTIFICATION_PSDK_RESPONSE"),t=>{this.handleNotificationResponse(t,o.get("ANS_PSDK_NOTIFICATION_TYPE"),o.get("NOTIFICATION_PSDK_QUERY_DATA_BY_ID_RESPONSE"))}),i.addListener(o.get("NOTIFICATION_STOCK_RESPONSE"),t=>{this.handleNotificationResponse(t,o.get("ANS_STOCK_NOTIFICATION_TYPE"),o.get("NOTIFICATION_STOCK_QUERY_DATA_BY_ID_RESPONSE"))}),i.addListener(o.get("NOTIFICATION_FORCE_REFRESH_RESPONSE"),t=>{this.handleNotificationResponse(t,o.get("ANS_FORCE_REFRESH_NOTIFICATION_TYPE"),o.get("ANS_FORCE_REFRESH_NOTIFICATION_SUB_TYPE"))}),i.addListener(o.get("NOTIFICATION_FORCE_REFRESH_RESPONSE"),t=>{this.handleNotificationResponse(t,o.get("ANS_NUJ_REFRESH_NOTIFICATION_TYPE"),o.get("ANS_NUJ_REFRESH_NOTIFICATION_SUB_TYPE"))})}_handlePayload(t,e){const a={},s=(t,e,s)=>{if(t===o.get("ANS_PSDK_NOTIFICATION_TYPE")&&e===o.get("ANS_PSDK_NOTIFICATION_SUB_TYPE")){let r;this.log.disk(`Handle ANS message: type=${t}, subtype=${e}, payload=${s}`);try{r=s&&JSON.parse(s)}catch(t){return this.log.error(new Error(o.analytics.PAYLOAD_PARSE_FAIL,`Fail to parse payload: ${s}`))}switch(r&&r.eventType){case"HVA_COMMUNICATION":case"HVA_COMPLETED":case"SEGMENT_CHANGE":case"EXPERIENCE_CHANGE":case"APS_COMMUNICATION":case"APPLAUNCH_BUCKET_CHANGE":case"PERSONA_SEGMENT_CHANGE":case"ENTITLEMENT_CHANGE":case"ENGAGEMENT_CLICK_EVENT":a.profileUpdated=!0;break;case"MEMBERSHIP_CHANGE":a.subscriptionStatusChanged=!0}}else if(t===o.get("ANS_STOCK_NOTIFICATION_TYPE")&&e===o.get("ANS_STOCK_NOTIFICATION_SUB_TYPE"))a.updateStock=!0;else if(t===o.get("ANS_FORCE_REFRESH_NOTIFICATION_TYPE")&&e===o.get("ANS_FORCE_REFRESH_NOTIFICATION_SUB_TYPE"))try{a[this.events.FORCE_REFRESH]=JSON.parse(s).payload}catch(a){this.log.error(new d(o.analytics.UNEXPECTED_ANS_MSG,`Unable to parse ANS message payload, type=${t}, subType=${e}, payload=${s}`))}else if(t===o.get("ANS_NUJ_REFRESH_NOTIFICATION_TYPE")&&e===o.get("ANS_NUJ_REFRESH_NOTIFICATION_SUB_TYPE"))try{a[this.events.FORCE_REFRESH]=JSON.parse(s[0])}catch(a){this.log.error(new d(o.analytics.UNEXPECTED_ANS_MSG,`Unable to parse ANS message payload, type=${t}, subType=${e}, payload=${s}`))}};v.parseString(t,(t,r)=>{if(t)return void this.log.error(t,"Fail to parse message");const i=r["notification-error"];if(i){const t=i.error&&i.error[0],e=t&&t.$&&t.$.desc||"Unknown notification error";return void this.log.disk(e)}const o=r&&r.notifications&&r.notifications.notification||[];let n;this.log.disk(`Received ${o.length} ANS notifications.`),o.forEach(t=>{const a=t.type[0],r=t["sub-type"][0],i=parseInt(t.timestamp[0],10),o=t.payload;(!e||i>e)&&(n=!n||i>n?i:n,s(a,r,o))}),Object.keys(a).forEach(t=>{this.emit(t,n||(new Date).getTime(),a[t]||null)})})}_queryANSNotificationsByTime(t,e,a,r){const n=s.v4();let c;const d=t=>{clearTimeout(c),i.removeListener(e,d),a(null,t)};i.addListener(e,d);const l={"{{TIME_STAMP}}":(new Date).getTime(),"{{NOTIFICATION_TYPE}}":t,"{{NOTIFICATION_COUNT}}":"10","{{uuid}}":n,"{{requestor-namespace}}":e};r&&(l["{{NOTIFNOTIFICATION_SUB_TYPE}}"]=r),i.sendMessage(o.get("NOTIFICATION_REQUEST"),this.constructMessage(C,l),"ADCS",""),c=setTimeout(()=>{i.removeListener(e,d),a(new Error("GetNotificationDataByTime timeout"))},o.get("GET_NOTIFICATION_DATA_TIMEOUT"))}getUserAnalyticsEnabledFlag(){return new Promise(t=>{let e,a;const r=o.get(u.getUserId(),"USER_ANALYTICS_ENABLED")||!1,n=s=>{if(i.removeListener(O,n),clearTimeout(e),!s)return this.log.error(new d(o.analytics.PARSE_MSG_FAIL,"Fail to receive user analytics message on sign in.")),void t({enabled:r});v.parseString(s,(e,s)=>{if(e||!s)return this.log.error(new d(o.analytics.PARSE_MSG_FAIL,`Fail to receive user analytics flag on sign in, err=${e}`)),void t({enabled:r});if(s.response&&s.response.error){const e=s.response.error;return e[0]&&"SignInPending"===e[0].$.id?(this.log.disk("User sign in pending. Analytics flag not received yet."),void t({enabled:r})):(this.log.error(new d(o.analytics.PARSE_MSG_FAIL,`Fail to parse user analytics flag on sign in, err=${JSON.stringify(s.response.error)}`)),void t({enabled:r}))}{const e=s.response&&s.response.UserfeatureXML&&s.response.UserfeatureXML[0];v.parseString(e,(e,s)=>{if(e||!s)return this.log.error(new d(o.analytics.PARSE_MSG_FAIL,`Fail to parse UserfeatureXML, err=${e}`)),void t({enabled:r});if((a=s["feature-response"]&&s["feature-response"]["feature-entry"]&&s["feature-response"]["feature-entry"].find((t,e)=>t&&t.$&&"com.adobe.oobe.acc.v1.piip.user.status"===t.$.id))&&a.$){this.log.disk(`GetUserAnalyticsFlag - Successfully obtained user analytics enabled flag: ${a.$.state}`);const e="OptedIn"===a.$.state;return t({enabled:e}),void o.set(u.getUserId(),e,"USER_ANALYTICS_ENABLED")}return this.log.error(new d(o.analytics.PARSE_MSG_FAIL,`Fail to parse userAnalyticsStatus, userAnalyticsStatus=${a}`)),void t({enabled:r})})}})};i.addListener(O,n),i.sendMessage(T,this.constructMessage(R,{"{{uuid}}":s.v4()}),"ADCS",""),e=setTimeout(()=>{i.removeListener(O,n),this.log.disk("GetUserAnalyticsFlag - Error: timed out getting user analytics enabled flag"),t({enabled:r})},o.get("USER_ANALYTICS__REQUEST_TIMEOUT"))})}getProxyCredentials(){return new Promise(t=>{let e;const a=s=>{i.removeListener(g,a),clearTimeout(e);const r=this.getMessageValue(s,"proxyuser"),o=this.getMessageValue(s,"proxypassword");this.log.disk("GetProxySettings - Successfully obtained username/password"),t({user:r,password:o})};i.addListener(g,a),i.sendMessage(h,this.constructMessage(A,{"{{uuid}}":s.v4()}),"ADCS",""),e=setTimeout(()=>{i.removeListener(g,a),this.log.disk("GetProxySettings - Error: timed out getting proxy settings"),t({})},o.get("PROXY_REQUEST_TIMEOUT"))})}registerANSNotifications(){[{"{{NOTIFICATION_TYPE}}":o.get("ANS_PSDK_NOTIFICATION_TYPE"),"{{NOTIFICATION_SUB_TYPE}}":o.get("ANS_PSDK_NOTIFICATION_SUB_TYPE"),"{{observer-namespace}}":o.get("NOTIFICATION_PSDK_RESPONSE")},{"{{NOTIFICATION_TYPE}}":o.get("ANS_STOCK_NOTIFICATION_TYPE"),"{{NOTIFICATION_SUB_TYPE}}":o.get("ANS_STOCK_NOTIFICATION_SUB_TYPE"),"{{observer-namespace}}":o.get("NOTIFICATION_STOCK_RESPONSE")},{"{{NOTIFICATION_TYPE}}":o.get("ANS_FORCE_REFRESH_NOTIFICATION_TYPE"),"{{NOTIFICATION_SUB_TYPE}}":o.get("ANS_FORCE_REFRESH_NOTIFICATION_SUB_TYPE"),"{{observer-namespace}}":o.get("NOTIFICATION_FORCE_REFRESH_RESPONSE")},{"{{NOTIFICATION_TYPE}}":o.get("ANS_NUJ_REFRESH_NOTIFICATION_TYPE"),"{{NOTIFICATION_SUB_TYPE}}":o.get("ANS_NUJ_REFRESH_NOTIFICATION_SUB_TYPE"),"{{observer-namespace}}":o.get("NOTIFICATION_FORCE_REFRESH_RESPONSE")}].forEach(t=>{i.sendMessage(o.get("NOTIFICATION_REQUEST"),this.constructMessage(I,t),"ADCS","")})}getNotificationDataByIDs(t,e,a,r){if(0===Object.keys(t).length)return void r(new Error("No notification id"));let n;const c=s.v4(),l=t=>{i.removeListener(a,l),clearTimeout(n),r(null,t)};i.addListener(a,l);let u="";Object.keys(t).forEach(t=>{u+=`<notification-id>${t}</notification-id>`});const p={"{{NOTIFICATION_TYPE}}":e,"{{NOTIFICATION_IDS}}":u,"{{uuid}}":c,"{{requestor-namespace}}":a};i.sendMessage(o.get("NOTIFICATION_REQUEST"),this.constructMessage(N,p),"ADCS",""),n=setTimeout(()=>{i.removeListener(a,l);const t=new d(o.analytics.GET_NOTIFICATION_DATA,"GetNotificationDataByID - Error: timed out getting notification data");this.log.error(t),r(t)},o.get("GET_NOTIFICATION_DATA_TIMEOUT"))}handleNotificationResponse(t,e,a){const s={};v.parseString(t,(r,i)=>{if(r)return void this.log.error(new d(o.analytics.PARSE_MSG_FAIL,`Fail to parse message, message=${t}`));const n=i&&i["notifications-signal"],c=n&&n["notification-signal"];(c&&c[0]&&c[0]["notification-info"]||[]).forEach(t=>{const e=t&&t["notification-ids"]&&t["notification-ids"][0];(e&&e["notification-id"]||[]).forEach(t=>{s[t]=!0})}),this.getNotificationDataByIDs(s,e,a,(t,e)=>{t?this.log.disk(t):this._handlePayload(e)})})}checkForMissedNotifications(t,e,a){[{type:o.get("ANS_PSDK_NOTIFICATION_TYPE"),requestNamespace:o.get("NOTIFICATION_PSDK_QUERY_DATA_BY_TIME_RESPONSE"),lastTimeOfNotification:t},{type:o.get("ANS_STOCK_NOTIFICATION_TYPE"),requestNamespace:o.get("NOTIFICATION_STOCK_QUERY_DATA_BY_TIME_RESPONSE"),lastTimeOfNotification:e},{type:o.get("ANS_FORCE_REFRESH_NOTIFICATION_TYPE"),subtype:o.get("ANS_FORCE_REFRESH_NOTIFICATION_SUB_TYPE"),requestNamespace:o.get("NOTIFICATION_FORCE_REFRESH_QUERY_DATA_BY_TIME_RESPONSE"),lastTimeOfNotification:a},{type:o.get("ANS_NUJ_REFRESH_NOTIFICATION_TYPE"),subtype:o.get("ANS_NUJ_REFRESH_NOTIFICATION_SUB_TYPE"),requestNamespace:o.get("NOTIFICATION_FORCE_REFRESH_QUERY_DATA_BY_TIME_RESPONSE"),lastTimeOfNotification:a}].forEach(t=>{const e=t.lastTimeOfNotification;this.queryANSNotificationsByTime(t,(t,a)=>{t?this.log.disk(t):this._handlePayload(a,e)})})}queryANSNotificationsByTime(t,e){this._queryANSNotificationsByTime(t.type,t.requestNamespace,e,t.subtype)}}t.exports=new P},function(t,e,a){function s(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function r(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?s(Object(a),!0).forEach(function(e){i(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function i(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}const o=a(9),n=a(16).default,c=a(0).default,d=a(1).default,l=a(4).default,u=a(2).default,p=a(14).URL;t.exports=class extends n{_convertSurfaceIdToModeId(t,e){const a=c.get("FIRST_MILE_SURFACE_MODE_MAP",e);return a&&a[t]?a[t]:t}async url(t){const e=c.getEnvironment(),a=new p(c.get(`URL_${e.LABEL.toUpperCase()}`,this.type)),s=c.get("FIRST_MILE_SURFACE_ID",d.ccxVersionToString(t)),r={productCode:t.productCode,productLanguage:t.productLanguage,productVersion:t.productVersion,productSemver:t.productVersion,surfaceId:s,ccxVersion:t.ccxVersion,osVersion:d.getOsVersion(),platform:d.getOsPlatform()};return t.vmStatus&&(r.vmStatus=t.vmStatus),this.appendUrlSearchParams(a.searchParams,r),a.toString()}additionalAnalytics(t){return{"exp.surface_id":c.get("FIRST_MILE_SURFACE_ID",d.ccxVersionToString(t)).join(", ")}}applyResponseAnalytics(t,e,a){if(t.appendPayload({"exp.response_guid":e.analyticsParams&&e.analyticsParams.responseGUID,"content.type":c.analytics.SOPHIA_CARDS,"content.size":e.cards?e.cards.length:0}),a&&["V2_8","V3_0","V3_1","V4_0"].includes(d.ccxVersionToString(a))){t.appendPayload({"exp.response_guid":e.analyticsData&&e.analyticsData.responseGUID,"content.size":Object.keys(e.surfaces).length});for(let a in e.surfaces)t.addSurfaceAnalytics([{surface:a}]),Array.isArray(e.surfaces[a].containers)&&t.addSurfaceAnalytics(e.surfaces[a].containers.map(t=>t.containerAnalyticsData))}else e.cardControl&&Array.isArray(e.cardControl)&&e.cardControl.forEach(e=>{Array.isArray(e.containerAnalyticsParams)&&(t.addSurfaceAnalytics(e.containerAnalyticsParams),t.addSurfaceAnalytics([{surface:e.modeID}]))})}async downloadCollectionDataRaw({params:t,priority:e,id:a=o.v4(),skipAuth:s=!1}){const i=await this.url(t),n=await this.log.context({params:t}).time(async t=>{let r={"content-type":"application/json","X-API-Key":c.getEnvironment().CLIENT_ID};const o=!s&&!!await l.getAccessToken().catch(t=>!1);o&&(r["x-gw-ims-user-id"]=l.getUserId());let{response:n,time:d}=await this.get({url:i,options:{method:"GET",timeout:c.get("SERVER_TIMEOUT"),headers:r},priority:e,auth:o,id:a});t.appendPayload({"event.value":d,"event.url":i,"env.svc.name":"Sophia"});const u=Date.now(),p=await this.getResponseJson(n,i);return d+=Date.now()-u,p}),p=c.get("FIRST_MILE_RESPONSE_SCHEMA"),_=d.validateDataFields(n,p);if(_)throw new u(c.analytics.PARAM_VALIDATION_ERR,_);if(["V2_8","V3_0","V3_1","V4_0"].includes(d.ccxVersionToString(t)))return n.analyticsData&&(n.analyticsData.requestId=a),n.ccxVersion=t.ccxVersion,n.surfaces&&Object.keys(n.surfaces).forEach(t=>{const e=n.surfaces[t];e.containers&&(e.containers=e.containers.map(t=>"application/json"===t.dataType?r(r({},t),{},{content:JSON.parse(t.data)}):t))}),n;const f={cards:[],cardControl:[],expirationDTS:new Date(Math.min(new Date(n.expirationDTS||0),new Date(Date.now()+c.get("MAX_TIMEOUT")))).toISOString(),analyticsParams:{responseGUID:n.analyticsData&&n.analyticsData.responseGUID,requestId:a},ccxVersion:t.ccxVersion};return n.surfaces&&Object.keys(n.surfaces).forEach(e=>{if(!Array.isArray(n.surfaces[e].containers)||0==n.surfaces[e].containers.length)return;const a={modeID:this._convertSurfaceIdToModeId(e,d.ccxVersionToString(t)),cardOrder:[],containerAnalyticsParams:[]};n.surfaces[e].containers.forEach(t=>{t.containerAnalyticsData=t.containerAnalyticsData||{},a.containerAnalyticsParams.push(t.containerAnalyticsData);let s={startDTS:t.startDTS,endDTS:t.endDTS};if("application/json"===t.dataType)try{Object.assign(s,JSON.parse(t.data))}catch(s){this.log.error(new u(c.analytics.PARAM_VALIDATION_ERR,s).setContext(`Error parsing card data for ${e} with analytics ${JSON.stringify(a.containerAnalyticsData)} which was ${t.data}`))}else"URL"===t.dataType?Object.assign(s,{contentURL:t.data}):Object.assign(s,t);f.cards.push(s),a.cardOrder.push(f.cards.length-1)}),f.cardControl.push(a)}),"V2"===d.ccxVersionToString(t)&&f.cards.forEach(t=>{t.backgroundImage&&(t.backgroundImage=t.backgroundImage.replace("730x280","1000x560"))}),f}}},function(t,e,a){"use strict";a.r(e),a.d(e,"default",function(){return O});var s=a(11),r=a(3),i=a(6),o=a(9),n=a(4),c=a(8),d=a(0),l=a(12),u=a(1),p=a(13),_=a(10),f=a(16),h=a(2),g=a(5),E=a(30);function y(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function m(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?y(Object(a),!0).forEach(function(e){T(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):y(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function T(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}class O{constructor(t){T(this,"log",void 0),T(this,"maps",void 0),T(this,"_firstMileLookupMap",void 0),T(this,"_stockLookupMap",void 0),T(this,"_learnLookupMap",void 0),T(this,"_downloadManager",void 0),this.log=new l.default({prefix:"ServiceInterface > ",payload:{"event.subtype":_.default.st_CLIENT}}),this._firstMileLookupMap=t.find(t=>"FIRST_MILE"===t.type),this._stockLookupMap=t.find(t=>"STOCK"===t.type),this._learnLookupMap=t.find(t=>"LEARN"===t.type),this.maps=t}init(){var t,e;c.default.addListener(d.default.get("VULCAN_PING_REQUEST"),(t,e,a)=>{c.default.sendMessage(d.default.get("VULCAN_PING_RESPONSE"),"",e,a)}),c.default.addListener(d.default.get("VULCAN_AVATAR_REQUEST"),(t,e,a)=>{this.log.context({payload:{"event.subcategory":d.default.analytics.sc_CCX_START}}).request(async()=>{c.default.sendMessage(d.default.get("VULCAN_AVATAR_RESPONSE"),await E.default.getAvatar(),e,a)})}),c.default.addListener(d.default.get("VULCAN_PSDK_FEED_REQUEST"),async(t,e,a)=>{let s,r,i={};try{i=JSON.parse(t)}catch(e){s=new h.default(d.default.analytics.PARAM_VALIDATION_ERR,e).setContext(`Unable to parse PSDK feed data:${t}`)}i.psdkParams=i.psdkParams||{};const l={"event.context_guid":i.radarSessionGUID||o.v4()};r=this.log.context({params:i&&i.psdkParams,payload:m({"event.subcategory":d.default.analytics.sc_SOPHIA},l)});const u=await r.request(async()=>{if(s)throw s;if(!n.default.getUserId())throw new Error(d.default.analytics.SIGNED_OUT);const t=this._firstMileLookupMap,e={requestId:i.requestId,settings:d.default.get(`${i.psdkParams.productCode}_PSDK`,`SETTINGS_${n.default.getUserId()}`)||{}};return await t.updateDisplayedId({params:i.psdkParams,displayed:i.psdkParams.displayed}),i.psdkParams.urgent?(delete i.psdkParams.urgent,await t.addNewCollectionData({params:i.psdkParams,payload:l,priorityLevel:g.PriorityLevels.UrgentRequest}),e.path=await t.getLatestPath({params:i.psdkParams,updateLastUsedId:!0,updateLastUseTime:!0})):(e.path=await t.getLatestPath({params:i.psdkParams,updateLastUsedId:!0,updateLastUseTime:!0}),e.path||t.addNewCollectionData({params:i.psdkParams,payload:l,priorityLevel:g.PriorityLevels.BackgroundRequest})),e.path&&(e.path=e.path.replace(/\\/gi,"/")),e}).catch(t=>({requestId:i.requestId,err:t}));c.default.sendMessage(d.default.get("VULCAN_PSDK_FEED_RESPONSE"),u,e,a)}),c.default.addListener(d.default.get("VULCAN_LEARN_REQUEST"),async(t,e,a)=>{let s,r,i={};try{i=JSON.parse(t)}catch(e){s=new h.default(d.default.analytics.PARAM_VALIDATION_ERR,e).setContext(`Unable to parse Learn feed data:${t}`)}i.params=i.params||{};const l={"event.context_guid":i.radarSessionGUID||o.v4()};r=this.log.context({params:i&&i.params,payload:m({"event.subcategory":d.default.analytics.sc_LEARN},l)});const u=await r.request(async()=>{if(s)throw s;if(!n.default.getUserId())throw new h.default(d.default.analytics.SIGNED_OUT);const t=this._learnLookupMap,e={requestId:i.requestId};return await t.addNewCollectionData({params:i.params,payload:l,priorityLevel:g.PriorityLevels.BackgroundRequest}),e.path=await t.getLatestPath({params:i.params,updateLastUsedId:!0,updateLastUseTime:!1}),e.path&&(e.path=e.path.replace(/\\/gi,"/")),e}).catch(t=>({requestId:i.requestId,err:t}));c.default.sendMessage(d.default.get("VULCAN_LEARN_RESPONSE"),u,e,a)}),c.default.addListener(d.default.get("VULCAN_LEARN_USAGE_MARKER"),async(t,e,a)=>{const s=this.log.context({payload:{"event.subcategory":d.default.analytics.sc_LEARN}});try{const e=JSON.parse(t);await this._learnLookupMap.getLatestPath({params:e.params,updateLastUsedId:!1,updateLastUseTime:!0}),s.context({params:e.params,payload:{"event.context_guid":e.radarSessionGUID||o.v4()}}).info(d.default.analytics.t_UPDATE,"Update last use time")}catch(t){s.error(new h.default(d.default.analytics.PARAM_VALIDATION_ERR,t),"Error parsing learn usage marker")}}),c.default.addListener(d.default.get("VULCAN_GET_USER_REQUEST"),async(t,e,a)=>{const s=this.log.context({payload:{"event.subcategory":d.default.analytics.sc_CCX_START}});await s.request(async()=>{c.default.sendMessage(d.default.get("VULCAN_GET_USER_RESPONSE"),{userId:n.default.getUserId()},e,a)})}),c.default.addListener(d.default.get("VULCAN_START_SETTINGS_REQUEST"),async(t,e,a)=>{let s=null,r=null;try{r=JSON.parse(t)}catch(r){s=new Error(`Unable to parse settings storage request from ${e}(${a}): ${t}`)}const i=this.log.context({params:r,payload:{"event.subcategory":_.default.sc_CCX_START}});await i.request(async()=>{if(s)throw s;if(!n.default.getUserId())throw new Error("Discarding start settings storage - not logged in");if(n.default.getUserId()!==r.userId)throw new Error(`Different user in request(${r.userId}) than the one logged in(${n.default.getUserId()})`);const t=`${r.productCode}_PSDK`,e=`SETTINGS_${n.default.getUserId()}`,a=d.default.get(t,e)||{};Object.keys(r.settings).forEach(t=>{a[t]?Object.assign(a[t],r.settings[t]):a[t]=r.settings[t]}),a.lastModified=(new Date).toISOString(),d.default.set(t,a,e)}).catch(t=>r=null),r&&c.default.sendMessage(d.default.get("VULCAN_START_SETTINGS_PATCH_UPDATE"),{settings:r.settings,userId:r.userId},r.productCode)}),c.default.addListener(d.default.get("VULCAN_START_SETTINGS_GET_REQUEST"),async(t,e,a)=>{let s={};const r=this.log.context({params:{productCode:e,productVersion:a},payload:{"event.subcategory":_.default.sc_CCX_START}});r.info("Start settings get Request");try{s=JSON.parse(t)}catch(s){r.error(new Error(`Unable to parse settings get request from ${e}(${a}): ${t}`))}c.default.sendMessage(d.default.get("VULCAN_START_SETTINGS_GET_RESPONSE"),{requestId:s.requestId,userId:n.default.getUserId(),settings:d.default.get(`${e}_PSDK`,`SETTINGS_${n.default.getUserId()}`)||{}},e,a)}),c.default.addListener(d.default.get("VULCAN_STOCK_REQUEST"),async(t,e,a)=>{let s,r,i={};try{i=JSON.parse(t)}catch(e){(s=new Error(d.default.analytics.PARAM_VALIDATION_ERR)).desc=`Unable to parse Stock template request:${t}`}i.stockParams=i.stockParams||{};const l={"event.context_guid":i.radarSessionGUID||o.v4()};r=this.log.context({params:i.stockParams,payload:m({"event.subcategory":d.default.analytics.sc_STOCK},l)});const u=await r.request(async()=>{if(s)throw s;if(!n.default.getUserId())throw new Error(d.default.analytics.SIGNED_OUT);const t=this._stockLookupMap,e={requestId:i.requestId};return e.path=await t.getLatestPath({params:i.stockParams,updateLastUsedId:!0,updateLastUseTime:!0}),e.path||t.addNewCollectionData({params:i.stockParams,priorityLevel:g.PriorityLevels.BackgroundRequest}),e.path&&(e.path=e.path.replace(/\\/gi,"/")),e}).catch(t=>({requestId:i.requestId,err:t}));c.default.sendMessage(d.default.get("VULCAN_STOCK_RESPONSE"),u,e,a)}),c.default.addListener(d.default.get("VULCAN_CC_PHOTO_DOWNLOAD_REQUEST"),async(t,e,a)=>{let n,l="OZ",_=d.default.analytics.sc_LR_CONTENT,g=d.default.analytics.sc_OZ;try{(n=JSON.parse(t)).source&&n.source===d.default.get("CC_SEARCH_IDENTIFIER")&&(l="CCSearch",_=d.default.analytics.sc_CC_SEARCH,g=d.default.analytics.sc_CC_SEARCH_STORAGE),n.source&&n.source===d.default.get("CC_TOUT_DOWNLOAD_IDENTIFIER")&&(l="CCXFileDownload",_=d.default.analytics.sc_CCX_FILE_DOWNLOAD,g=n.downloadSubcategory)}catch(t){return c.default.sendMessage(d.default.get("VULCAN_CC_PHOTO_DOWNLOAD_ERROR"),t.toString(),e,a),void this.log.context({payload:{"event.subcategory":d.default.analytics.sc_CC_PHOTO,"source.name":e,"source.version":a,"ccxp.mode":"download"}}).error(new h.default(t))}const E=await this.log.context({payload:{"event.subcategory":_,"source.name":e,"source.version":a,"ccxp.mode":"download"}}).request(async()=>{const t=r.join(s.tmpdir(),d.default.get("TMP_PHOTOS_DOWNLOAD_DIRECTORY")),_=t+`${n.id}-${n.filename}`,h={id:n.id,path:_.replace(/\\/g,"/")};return await i.access(_,i.constants.R_OK).catch(async t=>{this._downloadManager=this._downloadManager||new f.default(l);const s=o.v4(),{response:r}=await this.log.context({payload:{"event.subcategory":g,"event.subtype":d.default.analytics.st_API,"source.name":e,"source.version":a,"ccxp.mode":"download"}}).request(async()=>await this._downloadManager.get({url:n.url,options:{headers:{"x-api-key":n.clientId}},auth:!0,id:s})),i=r.headers.get("content-length");await p.default.writeAtomic({response:r,target:_,progress:t=>{c.default.sendMessage(d.default.get("VULCAN_CC_PHOTO_DOWNLOAD_PROGRESS"),{id:n.id,percentage:100*t/i},e,a)}})}),await u.default.deleteTempFiles(t,void 0).catch(t=>this.log.disk(`Err deleting temp files - ${t}`)),h}).catch(t=>{c.default.sendMessage(d.default.get("VULCAN_CC_PHOTO_DOWNLOAD_ERROR"),t.toString(),e,a)});E&&c.default.sendMessage(d.default.get("VULCAN_CC_PHOTO_DOWNLOAD_RESPONSE"),E,e,a)}),null===(t=this._firstMileLookupMap)||void 0===t||t.addListener("newCollection",t=>{c.default.sendMessage(d.default.get("VULCAN_PSDK_FEED_BROADCAST"),t,t.productCode,t.productVersion)}),null===(e=this._learnLookupMap)||void 0===e||e.addListener("newCollection",t=>{c.default.sendMessage(d.default.get("VULCAN_LEARN_BROADCAST"),t,t.productCode,t.productVersion)}),this.maps.forEach(t=>{const e=d.default.get("VULCAN_TYPE",t.type),a=async(a,s,r,i)=>{let o,l={};try{l=JSON.parse(a)}catch(t){o=new h.default(d.default.analytics.PARAM_VALIDATION_ERR,`Unable to parse ${e} request:${a}`)}let p=null,f=()=>{null!=p&&clearTimeout(p),p=i?setTimeout(()=>{this.log.error(new h.default("CCX Process Hung. Quitting")),_.default.flush(!0,process.exit)},d.default.get("CLIENT_REQUEST_TIMEOUT")):null};f();const E=l.params||{},y=l.analytics||{},T=this.log.context({params:E,payload:m(m({},y),{},{"event.subcategory":d.default.get("ANALYTICS_SUBCATEGORY",t.type),"ccxp.mode":"pre-fetch"})}),O=await T.request(async()=>{if(o)throw o;if(!n.default.getUserId())throw new h.default(d.default.analytics.SIGNED_OUT,d.default.analytics.SIGNED_OUT,"USER_SIGNED_OUT");let a=u.default.validateDataFields(l,d.default.get("SERVICE_REQUEST_SCHEMA"));if(Array.isArray(a))throw a[0];if(l.displayed&&await t.updateDisplayedId(l),!i)return void(l.updateLastUseTime&&await t.getLatestPath(l));const p={requestId:l.requestId},_=await t.addNewCollectionData({params:E,payload:y,priorityLevel:l.urgent?g.PriorityLevels.UrgentRequest:g.PriorityLevels.BackgroundRequest,force:m(m({type:"none"},l.force),{},{from:Date.now()}),progress:t=>{t.requestId=l.requestId,c.default.sendMessage(`ccxprocess.${e}Progress`,t,s,r),f()}});return p.path=await t.getLatestPath(m(m({},l),{},{updateLastUsedId:!0,updateLastUseTime:l.urgent?!1!==l.updateLastUseTime:l.updateLastUseTime})),p.contentId=_.id,p.expiry=t.getExpiry(_.id)||_.expiryTime,p}).catch(t=>({requestId:l.requestId,err:t instanceof Error&&!(t instanceof h.default)?{message:t.message}:t}));i&&(null!=p&&clearTimeout(p),c.default.sendMessage(`ccxprocess.${e}Response`,O,s,r))};c.default.addListener(`ccxprocess.${e}Request`,(t,e,s)=>a(t,e,s,!0)),c.default.addListener(`ccxprocess.${e}UsageMarker`,(t,e,s)=>a(t,e,s,!1)),t.addListener("newCollection",async(a,s)=>{const r=t.targetDetails(a);c.default.sendMessage(`ccxprocess.${e}Broadcast`,{params:a,path:await t.getLatestPath({params:a}),contentId:s.id},r.productCode,r.productVersion)}),d.default.get("SUPPORTS_ON_DEMAND",t.type)&&(c.default.addListener(`ccxprocess.${e}OnDemandRequest`,async(a,s,i)=>{var o,l,p,f;let E,y;try{E=JSON.parse(a)}catch(t){y=new h.default(d.default.analytics.PARAM_VALIDATION_ERR,`Unable to parse ${e} request:${a}`)}let T=null;(()=>{null!=T&&clearTimeout(T),T=setTimeout(()=>{this.log.error(new h.default("CCX Process Hung. Quitting")),_.default.flush(!0,process.exit)},d.default.get("CLIENT_REQUEST_TIMEOUT"))})();const O=(null===(o=E)||void 0===o?void 0:o.params)||{},S=(null===(l=E)||void 0===l?void 0:l.analytics)||{},A=this.log.context({params:O,payload:m(m({},S),{},{"event.subcategory":d.default.get("ANALYTICS_SUBCATEGORY",t.type),"ccxp.mode":"on-demand","ccxp.request_type":null!==(p=null===(f=E)||void 0===f?void 0:f.action)&&void 0!==p?p:"get"})}),I=await A.request(async()=>{var a,o;if(y||!E)throw y;if(!n.default.getUserId())throw new Error(d.default.analytics.SIGNED_OUT);let l=u.default.validateDataFields(E,d.default.get("ON_DEMAND_REQUEST_SCHEMA"));if(Array.isArray(l))throw l[0];const p=null!==(a=null===(o=E)||void 0===o?void 0:o.action)&&void 0!==a?a:"get",_={requestId:E.requestId};switch(p.toLowerCase()){case"get":const a=t.paramsToOnDemandId(E.params||{}),o=t=>{var a;c.default.sendMessage(`ccxprocess.${e}OnDemandProgress`,m(m({},t),{},{requestId:null===(a=E)||void 0===a?void 0:a.requestId}),s,i)};a&&t.on(a,o),_.path=r.normalize(t.getPath()+await t.getOnDemandData({params:E.params,force:E.force,updateLastUseTime:!0,priorityLevel:g.PriorityLevels.UrgentRequest}).finally(()=>{a&&t.off(a,o)})),a&&t.off(a,o);break;case"pause":await t.onDemandAbort(E.params);break;case"delete":await t.onDemandAbort(E.params),await t.clearOnDemandCollectionInfo(O,t.paramsToOnDemandId(O)),t.sync()}return _}).catch(t=>{var e;return{requestId:null===(e=E)||void 0===e?void 0:e.requestId,err:t instanceof Error&&!(t instanceof h.default)?{message:t.message}:t}});null!=T&&clearTimeout(T),c.default.sendMessage(`ccxprocess.${e}OnDemandResponse`,I,s,i)}),c.default.addListener(`ccxprocess.${e}OnDemandListRequest`,async(a,s,i)=>{var o,n;let l,p;try{l=JSON.parse(a)}catch(t){p=new h.default(d.default.analytics.PARAM_VALIDATION_ERR,`Unable to parse ${e} request:${a}`)}const _=(null===(o=l)||void 0===o?void 0:o.params)||{},f=(null===(n=l)||void 0===n?void 0:n.analytics)||{},g=this.log.context({params:_,payload:m(m({},f),{},{"event.subcategory":d.default.get("ANALYTICS_SUBCATEGORY",t.type),"ccxp.mode":"on-demand","ccxp.request_type":"list"})}),E=await g.request(async()=>{var e;if(p||!l)throw p;let a=u.default.validateDataFields(l,d.default.get("ON_DEMAND_LIST_REQUEST_SCHEMA"));if(Array.isArray(a))throw a[0];if(!l.params)throw new h.default(d.default.analytics.PARAM_VALIDATION_ERR,"Need params to get the list for");const s=t.getOnDemandCollection(l.params);let i=[];return s&&(i=Object.keys(s).map(e=>{var a;const i={key:e,state:s[e]},o=null===(a=t.cachedAsset(e))||void 0===a?void 0:a.path;return o&&(i.path=r.normalize(t.getPath()+o)),i})),{requestId:null===(e=l)||void 0===e?void 0:e.requestId,list:i}}).catch(t=>{var e;return{requestId:null===(e=l)||void 0===e?void 0:e.requestId,err:t instanceof Error&&!(t instanceof h.default)?{message:t.message}:t}});c.default.sendMessage(`ccxprocess.${e}OnDemandListResponse`,E,s,i)}))}),c.default.sendMessage(d.default.get("VULCAN_STARTUP_MESSAGE"),"","","")}}},function(t,e){t.exports=require("mkdirp")},function(t,e){t.exports=require("child_process")},function(t,e,a){"use strict";a.r(e);var s=a(0),r=a(1),i=a(39);const o=a(60);const n=new class{constructor(){var t,e,a;t=this,e="isKillSwitchEnabled",a=r.default.memoize(async t=>{const e=s.default.get("TEMP_STOCK_TEMPLATE_DOWNLOAD_LIMIT_REGISTRY_SETTING"),a=s.default.get("TEMP_CCD_CONTENT_DOWNLOAD_REGISTRY_SETTING"),n=s.default.get("TEMP_SENSEI_MODELS_CONTENT_DOWNLOAD_REGISTRY_SETTING"),c=s.default.get("TEMP_NETWORK_STATUS_REGISTRY_SETTING"),d=function(r,i){i&&(null!==i[e]&&void 0!==i[e]&&s.default.set("TEMP_DEFAULT_TEMPLATES_DOWNLOADED",i[e]),s.default.set("TEMP_CCD_CONTENT_DOWNLOAD_DISABLED",!!i[a]),s.default.set("TEMP_SENSEI_MODELS_CONTENT_DOWNLOAD_DISABLED",!!i[n]),s.default.set("TEMP_NETWORK_STATUS_DISABLED",!!i[c])),t(r,i)};if(r.default.isWindows()){const t={};let r;try{let i=null,l=null,u=null,p=null,_=await this.getRegistryByKey(o.HKLM,s.default.get("TEMP_KILL_SWITCH_REGISTRY_KEY"));if(_)for(let t=0;t<_.length;t++)_[t].name===e?i=_[t].value:_[t].name===a?l=_[t].value:_[t].name===n?u=_[t].value:_[t].name===c&&(p=_[t].value);t[e]=i,t[a]=l,t[n]=u,t[c]=p,d(r,t)}catch(e){d(r=e,t)}}else{let t,e;try{t=i.readFileSync(s.default.get("TEMP_KILL_SWITCH_PLIST_PATH"))}catch(t){e=t}d(e,t)}},{timeout:s.default.get("KILLSWITCH_MEMOIZE_TIMEOUT")}),e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a}async getRegistryByKey(t,e){const a=new o({hive:t,key:e});return new Promise(t=>{a.values(function(e,a){e?t(null):a&&a.length?t(a):t(null)})})}};e.default=n},function(t,e){t.exports=require("winreg")},function(t,e,a){"use strict";a.r(e);var s=a(6),r=a(3),i=a(0),o=a(1),n=a(5),c=a(19),d=a(2);function l(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function u(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?l(Object(a),!0).forEach(function(e){p(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function p(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}class _ extends c.a{constructor(t,e){super(t,e),p(this,"_lookupMap",void 0),this._lookupMap=e}validateData(t){return o.default.validateDataFields(t,i.default.get("LEARN_DATA_SCHEMA"))}ututAnalyticsData(t){return{"event.subcategory":i.default.analytics.sc_UTUTS,"event.subtype":i.default.analytics.st_API,"content.id":t.tutorialUUID||t.aem_id,"content.name":t.metadata&&t.metadata.descriptions&&t.metadata.descriptions.short,"content.category":t.metadata&&t.metadata.level,"content.action":t.metadata&&t.metadata.urls&&t.metadata.urls.helpx,"content.type":t.metadata&&t.metadata.learning_approach}}ututPlaylistAnalyticsData(t,e){return{"event.subcategory":i.default.analytics.sc_LCM,"event.subtype":i.default.analytics.st_API,"content.id":e,"content.name":t.description,"content.category":t.level}}get totalItems(){var t;return(null===(t=this._data)||void 0===t?void 0:t.surfaces)?Object.keys(this._data.surfaces).length:0}async syncData({priority:t,payload:e,params:a,progress:s=(()=>{}),force:r={type:"none"}}={}){var c;const l=this._data,p={started:[],complete:[]};r.depth=null!==(c=r.depth)&&void 0!==c?c:0,await this.log.time(async c=>{let _=0,f=0;await o.default.waitAll(Object.keys(l.surfaces||{}).map(async e=>{const c=l.surfaces[e].containers||[];p.started.push(e),s(p),await o.default.waitAll(c.map(async e=>{var s,c;if(e&&e.content)if(Array.isArray(null==e?void 0:null===(s=e.content)||void 0===s?void 0:s.tutorials)){const s=new n.Priority(t);s.channel=n.PriorityChannels.Learn,await o.default.waitAll(e.content.tutorials.map(async t=>{var o,n,c;if(null==t?void 0:null===(o=t.metadata)||void 0===o?void 0:null===(n=o.images)||void 0===n?void 0:null===(c=n.hero)||void 0===c?void 0:c.length){var l,p,h;const o=await this._lookupMap.fetchAsset({href:t.metadata.images.hero,analyticsData:this.ututAnalyticsData(t),priority:s,params:a,force:r,assetsDir:this.assetsDir}).catch(e=>{var a,s;return this.log.context({payload:u(u({},this.ututAnalyticsData(t)),{},{"event.url":null==t?void 0:null===(a=t.metadata)||void 0===a?void 0:null===(s=a.images)||void 0===s?void 0:s.hero})}).error(new d.default(i.default.analytics.t_FETCH,e)),{path:void 0,time:0}});t.metadata.images.heroPath=o.path,f+=null==o?void 0:o.time,_++,(null==t?void 0:null===(l=t.metadata)||void 0===l?void 0:null===(p=l.images)||void 0===p?void 0:null===(h=p.heroPath)||void 0===h?void 0:h.length)||e.content.tutorials.splice(e.content.tutorials.indexOf(t),1)}}))}else if(null==e?void 0:null===(c=e.content)||void 0===c?void 0:c.playlists){const s=new n.Priority(t);s.channel=n.PriorityChannels.Lcm,await o.default.waitAll(e.content.playlists.map(async t=>{Array.isArray(null==t?void 0:t.tutorial_ids)&&(t.tutorial_paths={},await o.default.waitAll(t.tutorial_ids.map(async e=>{const i=await this._lookupMap.downloadTutorial({params:a,id:e,priority:s,force:r,analyticsData:this.ututPlaylistAnalyticsData(t,e)});t.tutorial_paths[e]=i.path,f+=i.time,_+=i.count})))}))}})),p.complete.push(e),s(p)})),c.appendPayload(u(u({},e),{},{"event.url":"","event.count":_,"event.value":f/_}))})}async getReferencedAssets(){const t={},e=this._data;for(const a in null==e?void 0:e.surfaces)Array.isArray(null==e?void 0:e.surfaces[a].containers)&&await o.default.waitAll(e.surfaces[a].containers.map(async e=>{var a,s;Array.isArray(null==e?void 0:null===(a=e.content)||void 0===a?void 0:a.tutorials)?e.content.tutorials.forEach(e=>{if(e&&e.metadata&&e.metadata.images){const a=e.metadata.images;a.heroPath&&(t[a.heroPath]=!0)}}):Array.isArray(null==e?void 0:null===(s=e.content)||void 0===s?void 0:s.playlists)&&await o.default.waitAll(e.content.playlists.map(async e=>{await o.default.waitAll(Object.values(e.tutorial_paths||{}).map(async e=>{Object.assign(t,await this._lookupMap.getTutorialAssets(e))}))}))}));return t}}var f=a(16),h=a(9),g=a(4),E=a(14);class y extends f.default{async url(t){const e=i.default.getEnvironment(),a=new E.URL(i.default.get(`URL_${e.LABEL.toUpperCase()}`,this.type)),s=i.default.get("LEARN_SURFACE_ID",o.default.ccxVersionToString(t)),r=o.default.compareMajorMinorVersions(i.default.get("SUPPORTED_LEARN_THIRD_PARTY_START_MIN_VERSION"),t.ccxVersion||"")>-1,n={productCode:t.productCode,productLanguage:t.productLanguage,productVersion:t.productVersion,productSemver:t.productVersion,surfaceId:[s],ccxVersion:t.ccxVersion,allowThirdPartyContent:r.toString(),osVersion:o.default.getOsVersion(),platform:o.default.getOsPlatform()},c=i.default.get("LCM_SUPPORTED_PRODUCTS",this.type)||{};return c[t.productCode]&&o.default.compareMajorMinorVersions(t.productVersion,c[t.productCode])<=0&&n.surfaceId.push(i.default.get("UTUTS_SURFACE",this.type)),this.appendUrlSearchParams(a.searchParams,n),a.toString()}additionalAnalytics(t){return{"exp.surface_id":i.default.get("LEARN_SURFACE_ID",o.default.ccxVersionToString(t))}}numberOfTutorials(t,e){var a,s,r,n,c;let d=0,l=0,u=0;const p=i.default.get("LEARN_SURFACE_ID",o.default.ccxVersionToString(e));t&&t.surfaces&&t.surfaces[p]&&Array.isArray(t.surfaces[p].containers)&&t.surfaces[p].containers.forEach(t=>{t.content&&Array.isArray(t.content.tutorials)&&t.content.tutorials.length>0&&(t.content.tutorials[0].metadata&&Array.isArray(t.content.tutorials[0].metadata.platforms)&&t.content.tutorials[0].metadata.platforms.includes("in-app")?l=t.content.tutorials.length:d=t.content.tutorials.length)});const _=i.default.get("UTUTS_SURFACE",this.type);var f,h,g,E,y,m;Array.isArray(null==t?void 0:null===(a=t.surfaces)||void 0===a?void 0:null===(s=a[_])||void 0===s?void 0:null===(r=s.containers)||void 0===r?void 0:null===(n=r[0])||void 0===n?void 0:null===(c=n.content)||void 0===c?void 0:c.playlists)&&(u=(null==t?void 0:null===(f=t.surfaces)||void 0===f?void 0:null===(h=f[_])||void 0===h?void 0:null===(g=h.containers)||void 0===g?void 0:null===(E=g[0])||void 0===E?void 0:null===(y=E.content)||void 0===y?void 0:null===(m=y.playlists)||void 0===m?void 0:m.length)||0);return{web:d,app:l,ututs:u}}applyResponseAnalytics(t,e,a){const s=this.numberOfTutorials(e,a);if(t.appendPayload({"exp.response_guid":e.analyticsData&&e.analyticsData.responseGUID,"content.type":i.default.analytics.UTUTS,"content.size":`${s.web}:${s.app}:${null==s?void 0:s.ututs}`}),e.surfaces)for(let a in e.surfaces)t.addSurfaceAnalytics([{surface:a}]),Array.isArray(e.surfaces[a].containers)&&t.addSurfaceAnalytics(e.surfaces[a].containers.map(t=>t.containerAnalyticsData))}async downloadCollectionDataRaw({params:t,priority:e,id:a=h.v4(),skipAuth:s}){const r=await this.url(t),o=await this.log.context({params:t}).time(async t=>{let o={"content-type":"application/json","X-API-Key":i.default.getEnvironment().CLIENT_ID};const n=!s&&!!await g.default.getAccessToken().catch(t=>!1);n&&(o["x-gw-ims-user-id"]=g.default.getUserId());let{response:c,time:d}=await this.get({url:r,options:{method:"GET",timeout:i.default.get("SERVER_TIMEOUT"),headers:o},priority:e,auth:n,id:a});t.appendPayload({"event.value":d,"event.url":r,"env.svc.name":"Learn"});const l=Date.now(),u=await this.getResponseJson(c,r);return d+=Date.now()-l,u});for(const t in o.surfaces)Array.isArray(o.surfaces[t].containers)&&o.surfaces[t].containers.forEach(t=>{t.data&&(t.content=JSON.parse(t.data))});return o}}var m={ANALYTICS_SUBCATEGORY:"Learn",LOOKUP_COLLECTION_FILE_VERSION:3,SUPPORTED_PRODUCTS:{AEFT:"16.0",DRWV:"19.0",FLPR:"20.0",IDSN:"14.0",ILST:"23.0",PHXS:"20.0",PPRO:"13.0",SPRK:"31.0"},PARAMETERS_SCHEMA:{id:"learn_parameters",type:"object",properties:{productCode:{type:"string"},productVersion:{type:"string"},productLanguage:{type:"string"}},required:["productCode","productVersion","productLanguage"]},LABEL:"LEARN",VULCAN_TYPE:"Tutorial",NON_IDEMPOTENT_IMAGES:!0,PRIORITY_CHANNEL:n.PriorityChannels.Learn,DEFAULT_URLS_ENABLED:!1,MINOR_VERSION_SHOULD_UPDATE_CONTENT:!0,LCM_SUPPORTED_PRODUCTS:{PHXS:"22.0"},UTUTS_SURFACE:"LCM_LEARN_PANEL",SUPPORTS_ON_DEMAND:!0},T=a(18),O=a(13);function S(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function A(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?S(Object(a),!0).forEach(function(e){I(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):S(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function I(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}a.d(e,"default",function(){return C});class C extends T.a{constructor(){super(m),this._downloadManager=new y(this.type)}_createCollectionData(t){return new _(t,this)}_checkValidity(t,e){const{web:a}=this._downloadManager.numberOfTutorials(t.data,e);if(0===a)throw new d.default(i.default.analytics.MISSING_DATA,"No valid web tutorials")}async upgrade(t){try{if(1===t.version){for(const e in t.versionInfo)for(const a in t.versionInfo[e])for(const s in t.versionInfo[e][a]){const r=t.versionInfo[e][a][s],i=this.getMinorVersion(e,a,s,t);i&&(delete t.versionInfo[e][a][s],t.versionInfo[e][a][i]=r)}return t.version=i.default.get("LOOKUP_MAP_FILE_VERSION",this._type),t}}catch(t){console.error("Error performing lookupmap upgrade: ",t)}return null}isRequestPoisoned(t){const e=o.default.ccxVersionToString(t),a=i.default.get("SUPPORTED_PRODUCTS",this.type)||{};if("V1"===e){const e=i.default.get("LCM_SUPPORTED_PRODUCTS",this.type)||{};return!(t.productCode&&t.productVersion&&e[t.productCode]&&o.default.compareMajorMinorVersions(e[t.productCode],t.productVersion)<=0)}return"V2"===e&&!i.default.get("TIER_1_LOCALES").includes(t.productLanguage)||(!("V2_8"!==e&&"V3_1"!==e&&"V4_0"!==e||!t||"DRWV"!==t.productCode)||(!!(t.productCode&&a[t.productCode]&&o.default.compareMajorMinorVersions(a[t.productCode],t.productVersion)<0)||!!(o.default.isWindows()&&o.default.compareMajorMinorVersions(i.default.get("EARLIEST_SUPPORTED_WINDOWS_VERSION_UXP"),o.default.getOsVersion())<0&&i.default.get("UNSUPPORTED_WINDOWS_UXP_APPS").includes(t.productCode))))}getTutorialUrl(t,e="en_US"){const a=new E.URL(i.default.getEnvironment().UTUTS_SERVICE);return a.searchParams.set("api_key",i.default.getEnvironment().CLIENT_ID),a.searchParams.set("aem_id",t),a.searchParams.set("locale",e),a.searchParams.set("inline_surface","in_app_panel:v2"),a.searchParams.set("status","live"),a.toString()}async downloadTutorial({params:t,id:e,priority:a,force:i={type:"none"},analyticsData:c}){let l=0,u=0;const p=A(A({},t),{},{filePrefix:"LCM"}),_=new n.Priority(a);_.channel=n.PriorityChannels.Lcm;const f=this.getTutorialUrl(e,null==t?void 0:t.productLanguage),h=await this.fetchAsset({href:f,analyticsData:c,priority:_,force:i,params:p,assetsDir:this.assetsDir});l+=h.time,u++;let g=h.path;if(g){const t=`${this.getPath()}/${g}`,e=await s.readJSON(t).catch(t=>{this.log.error(new d.default("filesystem",t))});Array.isArray(null==e?void 0:e.tutorials)&&await o.default.waitAll(e.tutorials.map(async a=>{var s,o,n,d;if(null==a?void 0:null===(s=a.metadata)||void 0===s?void 0:null===(o=s.images)||void 0===o?void 0:o.hero){const t=await this.fetchAsset({href:a.metadata.images.hero,analyticsData:c,priority:_,force:A(A({},i),{},{depth:i.depth-1}),params:p,assetsDir:this.assetsDir});a.metadata.images.heroPath=t.path,l+=t.time,u++}if(null==a?void 0:null===(n=a.metadata)||void 0===n?void 0:null===(d=n.images)||void 0===d?void 0:d.thumbnail){const t=await this.fetchAsset({href:a.metadata.images.thumbnail,analyticsData:c,priority:_,force:A(A({},i),{},{depth:i.depth-1}),params:p,assetsDir:this.assetsDir});a.metadata.images.thumbnailPath=t.path,l+=t.time,u++}const h=await O.default.writeJsonAtomic(r.dirname(t)+"/",r.basename(t),e,!0);h&&h!==t&&(g=r.basename(r.dirname(h))+"/"+r.basename(t),this.cachedAsset(f).path=g,await this.save())}))}return{path:g,time:l,count:u}}async updateParams(t){return(await super.updateParams(t)).map(t=>{const e=i.default.get("ACTIVE_VERSIONS").find(e=>{const a=(i.default.get("FIRST_MILE_PREFETCH_CLIENTS",e)||{})[t.productCode];return 1===o.default.compareMajorMinorVersions(t.productVersion,a)});return t.ccxVersion=t.ccxVersion||i.default.get("START_VERSION",e),t.platform=o.default.getOsPlatform(),t.osVersion=o.default.getOsVersion(),t})}async _fetchOnDemandContent(t){const{params:e,force:a,priority:s}=t;if(e.url)return await super._fetchOnDemandContent(t);if(!e.id)throw new d.default(i.default.analytics.DATA_VALIDATION_ERR,"Cannot add on demand model without id");let{path:r}=await this.downloadTutorial({id:e.id,priority:s,params:e,force:a,analyticsData:{"content.id":e.id}});return r}getOnDemandAssetPath(t){var e,a,s,r,i,o;return t.url?null===(e=this._data)||void 0===e?void 0:null===(a=e.assetMetadata)||void 0===a?void 0:null===(s=a[t.url])||void 0===s?void 0:s.path:null===(r=this._data)||void 0===r?void 0:null===(i=r.assetMetadata)||void 0===i?void 0:null===(o=i[this.getTutorialUrl(t.id,t.productLanguage)])||void 0===o?void 0:o.path}async _getOnDemandAssetList(){var t;const e={},a=Object.values((null===(t=this._data)||void 0===t?void 0:t.onDemandMetadata)||{});for(const t of a){var s,r,i,o;if(t.params.id)Object.assign(e,await this.getTutorialAssets(null===(s=this._data)||void 0===s?void 0:null===(r=s.assetMetadata[this.getTutorialUrl(t.params.id||"")])||void 0===r?void 0:r.path));else e[(null===(i=this._data)||void 0===i?void 0:null===(o=i.assetMetadata[t.params.url||""])||void 0===o?void 0:o.path)||""]=!0}return e}async getTutorialAssets(t){var e;if(!t)return{};const a={};a[t]=!0;const r=await s.readJSON(`${this.getPath()}/${t}`).catch(t=>{this.log.error(new d.default("filesystem",t))});return null==r||null===(e=r.tutorials)||void 0===e||e.forEach(t=>{var e,s,r,i;(null===(e=t.metadata)||void 0===e?void 0:null===(s=e.images)||void 0===s?void 0:s.heroPath)&&(a[t.metadata.images.heroPath]=!0),(null===(r=t.metadata)||void 0===r?void 0:null===(i=r.images)||void 0===i?void 0:i.thumbnailPath)&&(a[t.metadata.images.thumbnailPath]=!0)}),a}}},function(t,e,a){"use strict";a.r(e);var s=a(5);var r={LABEL:"CCD",ANALYTICS_SUBCATEGORY:"CCD",VULCAN_TYPE:"CCD",LOG_PREFIX:"CCD",LOOKUP_MAP_FILE_VERSION:2,SUPPORTED_PRODUCTS:{ACCC:"5.0"},SURFACE_V2_VERSION:"5.4.0",PRIORITY_CHANNEL:s.PriorityChannels.CcdPrimary,SURFACE_PRIORITY:{ACCC_APPS_CATALOG:200,CCD_APPS_CATALOG:200,ACCC_CATEGORIES_BANNERS:300,CCD_ALL_APPS_BANNERS:400,ACCC_ALL_APPS_BANNERS:400,CCD_APP_SKELETON:500,ACCC_APP_SKELETON:500,CCD_USER_FEEDBACK:100,CCD_PMP:0},AEM_SURFACES:["CCD_ALL_APPS_BANNERS","CCD_APPS_CATALOG","CCD_APP_SKELETON","CCD_PMP","CCD_USER_FEEDBACK"],SECONDARY_SURFACES:["ACCC_ALL_APPS_BANNERS","CCD_ALL_APPS_BANNERS"],TERTIARY_SURFACES:["ACCC_APPS_CATALOG","ACCC_CATEGORIES_BANNERS","CCD_APPS_CATALOG"],QUARTERNARY_SURFACES:["CCD_USER_FEEDBACK","CCD_PMP"],SUPPORTED_LOCALES:["cs_CZ","da_DK","de_DE","en_US","es_ES","es_MX","fi_FI","fr_FR","fr_CA","it_IT","ja_JP","ko_KR","nb_NO","nl_NL","pl_PL","pt_BR","ru_RU","sv_SE","tr_TR","zh_CN","zh_TW"],DEFAULT_URLS_ENABLED:!1,MINOR_VERSION_SHOULD_UPDATE_CONTENT:!0},i=a(9),o=a(16),n=a(4),c=a(0);class d extends o.default{async url(t){return t.productSemver=t.productVersion,super.url(t)}async downloadCollectionDataRaw({params:t,priority:e,id:a=i.v4(),skipAuth:s}){if(c.default.get("TEMP_CCD_CONTENT_DOWNLOAD_DISABLED")){const t=new Date;return t.setDate(t.getDate()+14),{expirationDTS:t.toISOString(),surfaces:{}}}const r=await this.url(t),o=await this.log.context({params:t}).time(async t=>{let{response:i,time:o}=await this.get({url:r,options:{method:"GET",timeout:c.default.get("SERVER_TIMEOUT"),headers:{"content-type":"application/json","x-gw-ims-user-id":n.default.getUserId(),"X-API-Key":c.default.getEnvironment().CLIENT_ID}},priority:e,auth:!s&&!!await n.default.getAccessToken().catch(t=>!1),id:a});t.appendPayload({"event.value":o,"event.url":r,"env.svc.name":"Learn"});const d=Date.now(),l=await this.getResponseJson(i,r);return o+=Date.now()-d,l});return o.analyticsData&&(o.analyticsData.requestId=a),o}}var l=a(19),u=a(21),p=a(1);function _(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function f(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?_(Object(a),!0).forEach(function(e){h(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):_(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function h(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}class g extends l.a{constructor(t,e){super(t,e),h(this,"dataManager",void 0),this.dataManager=new u.a(e.type,this._lookupMap.diskLock)}async syncDataPromises({analyticsParams:t,payload:e,surface:a,card:s,priority:r,params:i,force:o,started:n}){await this.log.context({payload:e,surfaceAnalytics:[f({surface:a},t)]}).time(async t=>{let{count:e,totalTime:c}=await this.dataManager.downloadData({modeID:a,card:s,lookupMap:this._lookupMap,priority:r,params:i,started:n,force:o});t.appendPayload({"event.url":"","event.count":e,"event.value":c/e})})}async syncData({priority:t,payload:e,params:a,progress:r=(()=>{}),force:i={type:"none"}}={}){if(!this._data)return;const o={started:[],complete:[]};let n=[];Object.keys(this._data.surfaces).forEach(d=>{n.push(p.default.waitAll(this._data.surfaces[d].containers.map(async n=>{const l=new s.Priority(t);l.value+=c.default.get("SURFACE_PRIORITY",this._lookupMap.type)[d]||0,c.default.get("SECONDARY_SURFACES",this._lookupMap.type).includes(d)&&(l.channel=s.PriorityChannels.CcdSecondary),c.default.get("TERTIARY_SURFACES",this._lookupMap.type).includes(d)&&(l.channel=s.PriorityChannels.CcdTertiary),c.default.get("QUARTERNARY_SURFACES",this._lookupMap.type).includes(d)&&(l.channel=s.PriorityChannels.CcdQuarternary),await this.syncDataPromises({analyticsParams:n.containerAnalyticsData,payload:e,surface:d,card:n,priority:l,params:a,force:i,started(){o.started.includes(d)||(o.started.push(d),r(Object.assign({},o)))}})})).then(()=>{o.started.includes(d)||o.started.push(d),o.complete.push(d),r(Object.assign({},o))}))}),await p.default.waitAll(n)}get totalItems(){return this._data&&this._data.surfaces?Object.keys(this._data.surfaces):0}async getReferencedAssets(){const t={};return this._data&&this._data.surfaces&&await p.default.waitAll(Object.keys(this._data.surfaces).map(async e=>{await p.default.waitAll(this._data.surfaces[e].containers.map(async a=>{const s=await this.dataManager.getReferencedAssets(e,a);Object.assign(t,s)}))})),t}}var E=a(18);a.d(e,"default",function(){return y});class y extends E.a{constructor(t){super(r),this._downloadManager=new d(this.type)}_createCollectionData(t){return new g(t,this)}_getLookupKeys(t,e){const a=[e||n.default.getUserId()];return a.push(t.productLanguage),a}validateParams(t){}async uninstall(){}isRequestPoisoned(t){return!1}generateId(t){return`${t.productLanguage}-${i.v4()}`.trim()}async updateParams(t){var e;const a=null===(e=n.default.getUserInfo())||void 0===e?void 0:e.countryCode;return(await super.updateParams(t)).map(t=>{delete t.productCode;let e=1===p.default.compareMajorMinorVersions(t.productVersion,c.default.get("SURFACE_V2_VERSION",this.type))?["ACCC_ALL_APPS_BANNERS","ACCC_CATEGORIES_BANNERS","ACCC_APPS_CATALOG","ACCC_APP_SKELETON"]:c.default.get("AEM_SURFACES",this.type);const s=Object.assign({surfaceId:t.surfaceId,productLanguage:t.productLanguage,productVersion:t.productVersion,osVersion:p.default.getOsVersion(),platform:""},a?{countryCode:a}:{},t);return s.surfaceId=e,s.platform=p.default.getOsPlatform(),s})}sanitizeParams(t){return t.productLanguage=p.default.sanitizeLocale(t.productLanguage,c.default.get("SUPPORTED_LOCALES",this.type)),t}targetDetails(t){return{productCode:"ACCC"}}isValidDataForParams({id:t,params:e}){const a=this._data.metadata[t];return!(a&&a.params&&a.params.countryCode&&e.countryCode&&a.params.countryCode!==e.countryCode)}async addNewCollectionData(t){var e,a,s;if(!t.params){const t=new Error(c.default.analytics.DATA_VALIDATION_ERR);throw this.log.error(t,"No parameters to add the collection of."),t}t.params=(await this.updateParams([t.params]))[0];const r=await this.paramsToId(t.params),i=null===(e=this._data)||void 0===e?void 0:e.metadata[r];if(i){var o,n;const e=Array.from((null==i?void 0:null===(o=i.params)||void 0===o?void 0:o.surfaceId)||[]).sort(),a=Array.from((null==t?void 0:null===(n=t.params)||void 0===n?void 0:n.surfaceId)||[]).sort();if(JSON.stringify(e)!==JSON.stringify(a)&&t&&t.params){const e=this._getCollectionInfo(t.params);e&&(delete e.latestId,await this.save())}}return(null===(a=t.params)||void 0===a?void 0:null===(s=a.surfaceId)||void 0===s?void 0:s.includes("ACCC_ALL_APPS_BANNERS"))&&(t.progress=(()=>{})),super.addNewCollectionData(t)}}},function(t,e,a){"use strict";a.r(e);var s=a(0),r=a(18),i=a(1),o=a(19),n=a(5);function c(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function d(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?c(Object(a),!0).forEach(function(e){l(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):c(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function l(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}class u extends o.a{constructor(t,e){super(t,e),l(this,"_lookupMap",void 0),this._lookupMap=e}get totalItems(){var t;return Object.values((null===(t=this._data)||void 0===t?void 0:t.surfaces)||{}).map(t=>{var e;return(null===(e=t.containers)||void 0===e?void 0:e.map(t=>{var e,a;try{t.content=t.content||JSON.parse((null==t?void 0:t.data)||"{}")}catch(t){}return(null===(e=t.content)||void 0===e?void 0:null===(a=e.models)||void 0===a?void 0:a.length)||0}).reduce((t,e)=>t+e,0))||0}).reduce((t,e)=>t+e,0)||0}async syncData({priority:t,payload:e,params:a,progress:s=(()=>{})}){if(!this._data||!this._data)return;let r={count:0,time:0};const o={started:[],complete:[]};let c=Promise.resolve();await this._lookupMap.modelLock.write(async()=>{c=this.log.time(async c=>{const l=this._data;(null==l?void 0:l.surfaces)&&await i.default.waitAll(Object.values(l.surfaces).map(async l=>{var u;await i.default.waitAll((null===(u=l.containers)||void 0===u?void 0:u.map(async e=>{var c,d;e.content=e.content||JSON.parse((null==e?void 0:e.data)||"{}"),await i.default.waitAll((null===(c=e.content)||void 0===c?void 0:null===(d=c.models)||void 0===d?void 0:d.map(async e=>{if(e.id&&e.prefetch){var i;o.started.push(e.id),s(o);const c=new n.Priority(t);c.value=c.value+(null!==(i=e.priority)&&void 0!==i?i:0)/100;let{path:d,time:l}=await this._lookupMap.downloadModel(e,c,a);e.path=d,r.count++,r.time+=l,o.complete.push(e.id),await this.save(),s(o)}}))||[])}))||[]),c.appendPayload(d(d({},e),{},{"event.count":r.count,"event.value":r.time/r.count}))}))}),await i.default.setTimeoutAsync(10)}),await c}async getReferencedAssets(){const t={},e=this._data;return(null==e?void 0:e.surfaces)&&await i.default.waitAll(Object.values(e.surfaces).map(async e=>{var a;await i.default.waitAll((null==e?void 0:null===(a=e.containers)||void 0===a?void 0:a.map(async e=>{var a,s;await i.default.waitAll((null==e?void 0:null===(a=e.content)||void 0===a?void 0:null===(s=a.models)||void 0===s?void 0:s.map(async e=>{Object.assign(t,await this._lookupMap.getModelAssets(e.path))}))||[])}))||[])})),t}}var p=a(16),_=a(14);class f extends p.default{async downloadCollectionDataRaw(t){if(s.default.get("TEMP_SENSEI_MODELS_CONTENT_DOWNLOAD_DISABLED")){const t=new Date;return t.setDate(t.getDate()+14),{expirationDTS:t.toISOString(),surfaces:{}}}return await super.downloadCollectionDataRaw(t)}async url(t){const e=new _.URL(await super.url(t));return e.searchParams.set("productSemver",t.productVersion||"0"),e.searchParams.set("platform",i.default.isWindows()?"Win":"Mac"),e.searchParams.set("osVersion",i.default.getOsVersion()),e.toString()}}var h=a(4);var g={ANALYTICS_SUBCATEGORY:"SenseiModels",LOOKUP_MAP_FILE_VERSION:1,LOOKUP_COLLECTION_FILE_VERSION:1,SUPPORTED_PRODUCTS:{PHXS:"22.0"},PARAMETERS_SCHEMA:{id:"sensei_models_parameters",type:"object",properties:{productCode:{type:"string"},productVersion:{type:"string"},surfaceId:{type:"array",items:{type:"string"}}},required:["productCode","productVersion"]},LOG_PREFIX:"SenseiModels",DIR:"senseiModels/",LABEL:"SENSEI_MODELS",PRIORITY_CHANNEL:n.PriorityChannels.SenseiModels,VULCAN_TYPE:"SenseiModels",DEFAULT_URLS_ENABLED:!0,DEFAULT_DATA_EXPIRATION:864e5,DEFAULT_URL_WIN:"https://cc-cdn.adobe.com/content/neural-filters/sensei/win-models.json",DEFAULT_URL_MAC:"https://cc-cdn.adobe.com/content/neural-filters/sensei/mac-models.json",MINOR_VERSION_SHOULD_UPDATE_CONTENT:!1,MODEL_URL_PRODUCTION:"https://senseimds.adobe.io/compositemodels/",MODEL_URL_STAGING:"https://senseimds-stage.adobe.io/compositemodels/",ASSET_MINIMUM_PARTIAL_SIZE:1048576,ASSET_MAX_SOCKETS:16,NON_IDEMPOTENT_IMAGES:!0,SUPPORTS_ON_DEMAND:!0,MAXIMUM_PARALLEL_MODEL_DOWNLOADS:2},E=a(9),y=a(13),m=a(3),T=a(6),O=a(2);function S(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function A(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?S(Object(a),!0).forEach(function(e){I(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):S(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function I(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}a.d(e,"default",function(){return C});class C extends r.a{constructor(){super(g),I(this,"modelLock",void 0),I(this,"downloadModel",void 0),this.downloadModel=i.default.memoize(this._downloadModel,{refresher:t=>"pending"!==t.state,resolver:t=>t.id,destructor:(t,e)=>"pending"!==e.state}),this._downloadManager=new f("SENSEI_MODELS"),this.modelLock=new n.default(s.default.get("MAXIMUM_PARALLEL_MODEL_DOWNLOADS",this.type))}_createCollectionData(t){return new u(t,this)}generateId(t){return`${t.productCode}-${t.productVersion}-${t.filePrefix?t.filePrefix+"-":""}-${E.v4()}`.trim()}sanitizeParams(t){const e=!!t.productLanguage,a=super.sanitizeParams(t);return e||delete a.productLanguage,a}async updateParams(t){return(await super.updateParams(t)).map(t=>(delete t.productLanguage,delete t.countryCode,Object.assign({surfaceId:t.surfaceId||["sensei_model"]},t)))}_getLookupKeys(t,e){const a=[e||h.default.getUserId()||""];return a.push(t.productCode,(t.productVersion||"").match(/\d*(\.\d+)?/)[0]),a}getModelUrl(t){let e=s.default.get("MODEL_URL_"+s.default.getEnvironment().LABEL.toUpperCase(),this.type);return e+=t,(e=new _.URL(e)).searchParams.set("runtime","coreml"),e.toString()}async _downloadModel(t,e,a,r){if(!t.id)throw new O.default(s.default.analytics.DATA_VALIDATION_ERR,"Cannot add on demand model without id");(r=r||{type:"none"}).type=r.type||"none",r.depth=r.depth||0;let o=0;const n="Asset-"+t.id,c=t.type||"coreml";let d=this.getModelUrl(t.id);const l=this.cachedAsset(d);if((null==l?void 0:l.path)&&("always"!==r.type||r.depth<1)){var u,p,_,f;const t=await T.readJson(`${this.getPath()}/${l.path}`).catch(()=>void 0);if((null==t?void 0:null===(u=t.targets)||void 0===u?void 0:null===(p=u[c])||void 0===p?void 0:p.folder)&&await T.pathExists(`${this.getPath()}/${null==t?void 0:null===(_=t.targets)||void 0===_?void 0:null===(f=_[c])||void 0===f?void 0:f.folder}`))return{time:0,path:l.path}}return await this.modelLock.read(async()=>{const r=await this.fetchAsset({href:d,assetsDir:this.assetsDir,force:{type:"always",depth:3},priority:e,params:A(A({},a),{},{filePrefix:t.id}),auth:!0,headers:{"x-api-key":s.default.getEnvironment().CLIENT_ID},progressKey:n});o+=r.time;const c=`${this.getPath()}/${r.path}`,l=await T.readJson(c);return await i.default.waitAll(Object.keys((null==l?void 0:l.targets)||{}).map(async s=>{var i,d;const u=null==l?void 0:null===(i=l.targets)||void 0===i?void 0:null===(d=i[s])||void 0===d?void 0:d.cdnUri;if(u){const i=t.id+"-"+s,d=await this.fetchAsset({key:i,href:u,assetsDir:this.assetsDir,priority:e,force:{type:"always",depth:3},params:a,progressKey:n});o+=d.time;const p=m.basename(d.path,".bin"),_=`${this.assetsDir}/${p}`;await T.mkdirp(_),await T.emptyDir(_),await y.default.unzip(m.join(_,"../",m.basename(d.path)),_),l.targets[s].folder=m.dirname(d.path)+"/"+p,this.cachedAsset(i).path=l.targets[s].folder,await T.remove(this.assetsDir+m.basename(d.path));const f=await y.default.writeJsonAtomic(m.dirname(c),m.basename(c),l,!0),h=r.path;r.path=m.basename(m.dirname(f))+"/"+m.basename(f),h!==r.path&&this.cachedAsset(u)&&(this.cachedAsset(u).path=r.path,await this.save())}})),{time:o,path:r.path}},e)}async defaultCollectionData({params:t,desiredId:e}){const a=i.default.isWindows()?s.default.get("DEFAULT_URL_WIN",this.type):s.default.get("DEFAULT_URL_MAC",this.type),r=await this.downloadManager.get({url:a}),o=await r.response.json(),n=this._createCollectionData(e),c={surfaces:{sensei_model:{containers:[{containerId:1,containerLabel:"1",dataType:"application/json",data:JSON.stringify(o),containerAnalyticsData:{variationId:"dummy",actionBlockId:"dummy",campaignId:0,containerId:"1",controlGroupId:"",treatmentId:"dummy"},content:o}],surfaceAnalyticsData:{surfaceId:"sensei_model"}}},expirationDTS:new Date(Date.now()+s.default.get("DEFAULT_DATA_EXPIRATION",this.type)).toISOString(),analyticsData:{responseGUID:"dummy",requestId:"dummy"},_ccx:{version:1}};return n.setData(c),n}async _fetchOnDemandContent({params:t,force:e,priority:a}){if(!t.id)throw new O.default(s.default.analytics.DATA_VALIDATION_ERR,"Cannot add on demand model without id");this.modelLock.prioritize(a);let{path:r}=await this.downloadModel({id:t.id},a,t,e);return r}getOnDemandAssetPath(t){var e,a,s;return t.id?null===(e=this._data)||void 0===e?void 0:null===(a=e.assetMetadata)||void 0===a?void 0:null===(s=a[this.getModelUrl(t.id)])||void 0===s?void 0:s.path:void 0}async _getOnDemandAssetList(){var t;const e={},a=Object.values((null===(t=this._data)||void 0===t?void 0:t.onDemandMetadata)||{});for(const t of a){var s,r;const a=null===(s=this._data)||void 0===s?void 0:null===(r=s.assetMetadata[this.getModelUrl(t.params.id||"")])||void 0===r?void 0:r.path;Object.assign(e,await this.getModelAssets(a))}return e}async getModelAssets(t){const e={};if(!t)return e;e[t]=!0;let a=await T.readJson(this.assetsDir+"/../"+t).catch(()=>{});return Object.keys((null==a?void 0:a.targets)||{}).forEach(t=>{var s,r;(null==a?void 0:null===(s=a.targets)||void 0===s?void 0:null===(r=s[t])||void 0===r?void 0:r.folder)&&(e[a.targets[t].folder]=!0)}),e}}},function(t,e,a){"use strict";a.r(e);var s=a(18),r=a(0),i=a(1),o=a(19);function n(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function c(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?n(Object(a),!0).forEach(function(e){d(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):n(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function d(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}class l extends o.a{async downloadAsset({asset:t,link:e,priority:a,analytics:s,params:r}){const i=t&&t[e];if(!t||!i||0===i.length)throw new Error("Invalid data");const{path:o,time:n}=await this._lookupMap.fetchAsset({href:i.toString(),assetsDir:this.assetsDir,priority:a,params:r});s&&s.count&&s.time&&(s.time+=n,s.count++),t[e]=o}validateData(t){return i.default.validateDataFields(t,r.default.get("STOCK_TEMPLATES_DATA_SCHEMA"))}get totalItems(){return this._data&&this._data.templates&&this._data.templates.length||0}async syncData({priority:t,payload:e,params:a,progress:s=(()=>{})}){if(!this._data||!this._data.templates)return;let r={count:0,time:0};const o=[],n={started:0,complete:0};this._data.templates.forEach(e=>{n.started++,s(n);let i=0;async function c(){2===++i&&(n.complete++,s(n))}e.thumbnail_url&&0!==e.thumbnail_url.length&&e.thumbnail_url.startsWith("http")&&o.push(this.downloadAsset({asset:e,link:"thumbnail_url",priority:t,analytics:r,params:a}).then(c)),e.previews&&0!==e.previews.length&&e.previews.forEach(e=>{e&&e.url&&e.url.startsWith("http")&&o.push(this.downloadAsset({asset:e,link:"url",priority:t,analytics:r,params:a}).then(c))})}),await this.log.time(async t=>{t.appendPayload(c(c({},e),{},{"event.count":r.count,"event.value":r.time/r.count})),await i.default.waitAll(o)})}async getReferencedAssets(){const t={};return this._data&&this._data.templates&&this._data.templates.forEach(e=>{e&&e.thumbnail_url&&(t[e.thumbnail_url]=!0),e&&e.previews&&e.previews.forEach(e=>{e&&e.url&&(t[e.url]=!0)})}),t}}var u=a(9),p=a(14),_=a(16),f=a(4);class h extends _.default{async url(t){const e=r.default.getEnvironment();let a=Math.min(r.default.get("TEMP_STOCK_TEMPLATE_DOWNLOAD_LIMIT"),r.default.get("TEMP_DEFAULT_TEMPLATES_DOWNLOADED",this.type));isNaN(a)&&(a=100);let s=new p.URL(r.default.get(`URL_${e.LABEL.toUpperCase()}`,this.type));const i={product:t.productCode,locale:t.productLanguage,country_code:t.countryCode,"search_parameters[limit]":`${a}`};return this.appendUrlSearchParams(s.searchParams,i),s.toString()}async downloadCollectionDataRaw({params:t,priority:e,id:a=u.v4()}){if(0===r.default.get("TEMP_STOCK_TEMPLATE_DOWNLOAD_LIMIT")){const t=new Date;return t.setDate(t.getDate()+14),{expirationDTS:t.toISOString(),templates:[]}}const s=await this.url(t),{response:i}=await this.get({url:s,options:{timeout:r.default.get("SERVER_TIMEOUT"),headers:{"X-API-Key":r.default.getEnvironment().CLIENT_ID,"X-Product":`${t.productCode}/${t.productVersion}`,"Content-Type":"application/json"}},priority:e,id:a,auth:!!await f.default.getAccessToken().catch(t=>!1)}),o=await this.getResponseJson(i,s);if("number"==typeof o.expirationDTS){const t=new Date(1e3*o.expirationDTS);o.expirationDTS=t.toISOString()}return o}}var g={ANALYTICS_SUBCATEGORY:"Stock",LOOKUP_MAP_FILE_VERSION:3,LOOKUP_COLLECTION_FILE_VERSION:1,SUPPORTED_PRODUCTS:{IDSN:"12.0",ILST:"21.0",PHXS:"18.0"},PARAMETERS_SCHEMA:{id:"stock_parameters",type:"object",properties:{productCode:{type:"string"},productVersion:{type:"string"},productLanguage:{type:"string"},countryCode:{type:"string"}},required:["productCode","productVersion","productLanguage","countryCode"]},LOG_PREFIX:"Stock",URL_STAGING:"https://stock-stage.adobe.io/Rest/Media/1/Search/Templates",URL_PRODUCTION:"https://stock.adobe.io/Rest/Media/1/Search/Templates",DIR:"stock/",LABEL:"STOCK",PRIORITY_CHANNEL:a(5).PriorityChannels.Stock,ANONYMOUS_RETRY_DISABLED:!0,DEFAULT_URLS_ENABLED:!1,MINOR_VERSION_SHOULD_UPDATE_CONTENT:!1,TEMP_DEFAULT_TEMPLATES_DOWNLOADED:100},E=a(8);a.d(e,"default",function(){return y});class y extends s.a{constructor(){super(g),this._downloadManager=new h("STOCK")}_createCollectionData(t){return new l(t,this)}async uninstall(t){const e=await E.default.getInstalledApps();if(!t.productCode||!e[t.productCode])return super.uninstall(t)}_getLookupKeys(t,e){const a=[e||f.default.getUserId()||""];return a.push(t.productCode,t.productLanguage),a}}},function(t,e,a){"use strict";a.r(e);var s=a(0),r=a(18),i=a(1),o=a(19),n=a(21);function c(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function d(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?c(Object(a),!0).forEach(function(e){l(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):c(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function l(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}class u extends o.a{constructor(t,e){super(t,e),l(this,"cardDataManager",void 0),this.cardDataManager=new n.a(e.type,this._lookupMap.diskLock)}validateData(t,e){let a;if(a=i.default.validateDataFields(t,s.default.get("CARDS_DATA_SCHEMA")[e],[s.default.get("CARDS_CONTROL_SCHEMA")]))return a;let r=[];return t.cardControl&&t.cardControl.forEach(e=>{const o=s.default.get("CARD_DATA_SCHEMA")[e.modeID];if(!o)return null;e.cardOrder.forEach(e=>{const s=t.cards[e];s&&(a=i.default.validateDataFields(s,o))&&(r=r.concat(a))})}),r.length>0?r:null}async upgrade(t,e){return"V3_0"===e&&t&&t.cardControl?(this.log.disk(`Invalidating Home Data: ${this._fileName}`),null):t.version===s.default.get("LOOKUP_COLLECTION_FILE_VERSION",this._lookupMap.type)?t:t&&2===t.version?(t.version=s.default.get("LOOKUP_COLLECTION_FILE_VERSION",this._lookupMap.type),t):(this.log.disk(`Unsupported format, downloading new content: ${this._fileName}`),null)}async syncDataPromises({analyticsParams:t,payload:e,surface:a,card:s,priority:r,params:i,started:o,force:n}){await this.log.context({payload:e,surfaceAnalytics:[d({surface:a},t)]}).time(async t=>{let{count:e,totalTime:c}=await this.cardDataManager.downloadData({modeID:a,card:s,lookupMap:this._lookupMap,priority:r,bundle:!0,params:i,started:o,force:n});t.appendPayload({"event.url":"","event.count":e,"event.value":c/(e||1)})})}get totalItems(){return this._data&&this._data.surfaces?Object.keys(this._data.surfaces):this._data&&this._data.cardControl?this._data.cardControl.map(t=>t.modeID):0}async syncData({priority:t,payload:e,params:a,progress:s,force:r}){if(!this._data)return;const o={started:[],complete:[]};let n=[];if(this._data.surfaces)Object.keys(this._data.surfaces).forEach(c=>{n.push(i.default.waitAll(this._data.surfaces[c].containers.filter(t=>"URL"===t.dataType).map(async i=>{await this.syncDataPromises({analyticsParams:i.containerAnalyticsData,payload:e,surface:c,card:i,priority:t,params:a,force:r,started(){o.started.includes(c)||(o.started.push(c),s(Object.assign({},o)))}})})).then(()=>{o.started.includes(c)||o.started.push(c),o.complete.push(c),s(Object.assign({},o))}))});else{if(!this._data.cardControl)return;this._data.cardControl.forEach(c=>{n.push(i.default.waitAll(c.cardOrder.map(async(i,n)=>{const d=this._data.cards[i];d&&await this.syncDataPromises({analyticsParams:c.containerAnalyticsParams&&c.containerAnalyticsParams[n],payload:e,surface:c.modeID,card:d,priority:t,params:a,force:r,started(){o.started.includes(c.modeID)||(o.started.push(c.modeID),s(Object.assign({},o)))}})})).then(()=>{o.started.includes(c.modeID)||o.started.push(c.modeID),o.complete.push(c.modeID),s(Object.assign({},o))}))})}await i.default.waitAll(n)}hasValidCards(){const t=s.default.get("ACTIVE_VERSIONS"),e=s.default.get("SUPPORTED_ACTIVE_VERSIONS"),a=t.slice(-1*e),r=i.default.ccxVersionToString(this._data);if(!a.includes(r))return!0;const o=s.default.get("HOME_SURFACE_ID",r);return["V1","V2","V2_5"].includes(r)?!!this._data.cardControl.find(t=>t.modeID===o):!!Object.keys(this._data.surfaces).includes(o)}async getReferencedAssets(){const t={};return this._data&&this._data.surfaces?await i.default.waitAll(Object.keys(this._data.surfaces).map(async e=>{await i.default.waitAll(this._data.surfaces[e].containers.map(async a=>{const s=await this.cardDataManager.getReferencedAssets(e,a);Object.assign(t,s)}))})):this._data&&this._data.cardControl&&await i.default.waitAll(this._data.cardControl.map(async e=>{await i.default.waitAll(e.cardOrder.map(async a=>{const s=this._data.cards[a];if(s){const a=await this.cardDataManager.getReferencedAssets(e.modeID,s);Object.assign(t,a)}}))})),t}}var p=a(10),_=a(2),f=a(9),h=a(5);var g={ANALYTICS_SUBCATEGORY:"Sophia",LOOKUP_MAP_FILE_VERSION:6,LOOKUP_COLLECTION_FILE_VERSION:3,ASSET_MAX_SOCKETS:4,ASSET_MINIMUM_PARTIAL_SIZE:65536,SUPPORTED_PRODUCTS:{AEFT:"15.0",DRWV:"18.0",FLPR:"20.0",IDSN:"13.0",ILST:"22.0",MUSE:"2018.0",PHXS:"19.0",PPRO:"12.0",SPRK:"31.0"},PARAMETERS_SCHEMA:{id:"psdk_parameters",type:"object",properties:{productCode:{type:"string"},productVersion:{type:"string"},productLanguage:{type:"string"}},required:["productCode","productVersion","productLanguage"]},LOG_PREFIX:"FirstMile",LABEL:"FIRST_MILE",DIR:"data/",VULCAN_TYPE:"FirstMile",PRIORITY_CHANNEL:h.PriorityChannels.FirstMileLatest,DEFAULT_DATA_EXPIRATION:864e5,DEFAULT_URLS_ENABLED:!0,DEFAULT_URLS:{V2_5:{PHXS:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/953/2drOpU2WQ0s4qG6KacAgmk/{locale}.json",PPRO:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/62/3JrN0dcjvNeCc1oEZPABh9/{locale}.json",AEFT:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/687/50WW9E93Dvfv7Otfe3B2UO/{locale}.json",ILST:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/832/7pCFzXfA6QAaKI6MsicKO2/{locale}.json",IDSN:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/619/1dyQrULwM8wCi4oiaY0gUy/{locale}.json",DRWV:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/709/4gK0NuqSF2G4YwYc6MoSO/{locale}.json"},V2_8:{PHXS:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/169/45a57xm7FMMg2CHHSsI5T/{locale}.json",PPRO:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/508/XFd1SlnnXACOaGHvHrkzR/{locale}.json",AEFT:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/53/66SsgxKgPwafhzfZhaH73y/{locale}.json",ILST:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/959/3QlaTwccpuG2gM4WwJu2O5/{locale}.json",IDSN:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/71/3fF2Ay5mQhhH3ruR2k7fU8/{locale}.json"},V3_0:{PHXS:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/953/2drOpU2WQ0s4qG6KacAgmk/{locale}.json",ILST:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/832/7pCFzXfA6QAaKI6MsicKO2/{locale}.json"},V3_1:{PHXS:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/169/45a57xm7FMMg2CHHSsI5T/{locale}.json",PPRO:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/508/XFd1SlnnXACOaGHvHrkzR/{locale}.json",AEFT:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/53/66SsgxKgPwafhzfZhaH73y/{locale}.json",ILST:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/959/3QlaTwccpuG2gM4WwJu2O5/{locale}.json",IDSN:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/71/3fF2Ay5mQhhH3ruR2k7fU8/{locale}.json",SPRK:"https://cvs.adobe.com/content/dam/cvs/firstmile/V2/634/hs2oiIlx8QNVYkYXaNJrs/{locale}.json"},V4_0:{PHXS:"https://odin.adobe.com/content/dam/ccfirstmile/PHSP/{locale}/experienceHomeMx19/Ps-Home-Max-2020-Photo-editing.cfm.gql.json",PPRO:"https://odin.adobe.com/content/dam/ccfirstmile/PPRO/{locale}/experienceHomeMx19/Pr-NUJ-M3-2020-Social-video.cfm.gql.json",AEFT:"https://odin.adobe.com/content/dam/ccfirstmile/AEFT/{locale}/experienceHomeMx19/Ae-NUJ-M3-Home-2020-Social.cfm.gql.json",ILST:"https://odin.adobe.com/content/dam/ccfirstmile/ILST/{locale}/experienceHomeMx19/Ai-MAX-2020-Home-Individual-Enterprise-AEM.cfm.gql.json",IDSN:"https://odin.adobe.com/content/dam/ccfirstmile/IDSN/{locale}/experienceHomeMx19/Id-MAX-2020-Home-Individual-Enterprise-AEM.cfm.gql.json"}},MINOR_VERSION_SHOULD_UPDATE_CONTENT:!0};a.d(e,"default",function(){return y});const E=a(55);class y extends r.a{constructor(){super(g),this._downloadManager=new E(this.type)}generateId(t){return`${t.productCode}-${t.productVersion}-${t.productLanguage}-${f.v4()}`.trim()}priority(t){let{params:e}=t;const a=super.priority(t),r=i.default.ccxVersionToString(e);return a.value+=s.default.get("priority",r),"V1"!==r&&"V2"!==r||(a.channel=h.PriorityChannels.Deprecated),"V2_5"!==r&&"V3_0"!==r||(a.channel=h.PriorityChannels.FirstMileOld),a}_createCollectionData(t){return new u(t,this)}_getLookupKeys(t,e=null){const a=super._getLookupKeys(t,e),s=i.default.ccxVersionToString(t);return a.splice(1,0,s),a}async upgrade(t){try{if(5===t.version){for(const e in t.versionInfo)for(const a in t.versionInfo[e])for(const s in t.versionInfo[e][a])for(const r in t.versionInfo[e][a][s]){const i=t.versionInfo[e][a][s][r],o=this.getMinorVersion(e,s,r,t);o&&(delete t.versionInfo[e][a][s][r],t.versionInfo[e][a][s][o]=i)}return t.version=s.default.get("LOOKUP_MAP_FILE_VERSION",this._type),t}}catch(t){console.error("Error performing lookupmap upgrade: ",t)}return null}_checkValidity(t,e){if(!t||!t.hasValidCards||!t.hasValidCards())throw new _.default(p.default.MISSING_DATA,"Empty Sophia Cards")}async forceRefresh(t){const e=s.default.get("ACTIVE_VERSIONS").map(e=>[e,...Object.values(t)]).map(t=>this.getIdsByKeys(t)).reduce((t,e)=>[...t,...e],[]).filter((t,e,a)=>a.indexOf(t)===e);await Promise.all(e.map(async t=>await this.expireOne(t)))}isRequestPoisoned(t){const e=i.default.ccxVersionToString(t),a=s.default.get("SUPPORTED_PRODUCTS",this.type)||{};return"V1"===e||("V2"===e&&!s.default.get("TIER_1_LOCALES").includes(t.productLanguage)||(!("V2_8"!==e&&"V3_1"!==e&&"V4_0"!==e||!t||"DRWV"!==t.productCode)||(!!(t.productCode&&a[t.productCode]&&i.default.compareMajorMinorVersions(a[t.productCode],t.productVersion)<0)||!!(i.default.isWindows()&&i.default.compareMajorMinorVersions(s.default.get("EARLIEST_SUPPORTED_WINDOWS_VERSION_UXP"),i.default.getOsVersion())<0&&s.default.get("UNSUPPORTED_WINDOWS_UXP_APPS").includes(t.productCode)))))}async updateParams(t){const e=await super.updateParams(t);return e.forEach(t=>{const e=s.default.get("ACTIVE_VERSIONS").find(e=>{const a=s.default.get("FIRST_MILE_PREFETCH_CLIENTS",e)[t.productCode];return 1===i.default.compareMajorMinorVersions(t.productVersion,a)});t.ccxVersion=t.ccxVersion||s.default.get("START_VERSION",e),t.platform=i.default.getOsPlatform(),t.osVersion=i.default.getOsVersion()}),e}async defaultCollectionData({params:t,desiredId:e}){const a=i.default.ccxVersionToString(t);if(["V2_5","V2_8","V3_0","V3_1","V4_0"].includes(a)){const r=this._createCollectionData(e),i=s.default.get("DEFAULT_URLS",this.type)[a][t.productCode],o=i&&i.replace("{locale}",t.productLanguage);if(!o)return;let n={ccxVersion:"2.7.4.99",cards:[{startDTS:(new Date).toISOString(),endDTS:(new Date).toISOString(),contentURL:o}],cardControl:[{modeID:"CCX_Start_2.5_Home",cardOrder:[0],containerAnalyticsParams:[{variationId:"dummy",actionBlockId:"dummy",campaignId:0,containerId:"1",controlGroupId:"",treatmentId:"dummy"}]}],analyticsParams:{responseGUID:"dummy",requestId:"dummy"},expirationDTS:new Date(Date.now()+s.default.get("DEFAULT_DATA_EXPIRATION",this.type)).toISOString(),_ccx:{isDefault:!0,version:s.default.get("LOOKUP_COLLECTION_FILE_VERSION",this.type)}};return"V2_8"===a&&(n={ccxVersion:"2.8.0.99",_ccx:{isDefault:!0,version:s.default.get("LOOKUP_COLLECTION_FILE_VERSION",this.type)},surfaces:{"CCX_Start_3.1_Home":{containers:[{dataType:"URL",data:o,containerAnalyticsData:{variationId:"dummy",actionBlockId:"dummy",campaignId:0,containerId:"1",controlGroupId:"",treatmentId:"dummy"}}]}},analyticsData:{responseGUID:"dummy",requestId:"dummy"},expirationDTS:new Date(Date.now()+s.default.get("DEFAULT_DATA_EXPIRATION",this.type)).toISOString()}),"V3_1"===a&&(n={ccxVersion:"3.1.0.99",_ccx:{isDefault:!0,version:s.default.get("LOOKUP_COLLECTION_FILE_VERSION",this.type)},surfaces:{"CCX_Start_3.1_Home":{containers:[{dataType:"URL",data:o,containerAnalyticsData:{variationId:"dummy",actionBlockId:"dummy",campaignId:0,containerId:"1",controlGroupId:"",treatmentId:"dummy"}}]}},analyticsData:{responseGUID:"dummy",requestId:"dummy"},expirationDTS:new Date(Date.now()+s.default.get("DEFAULT_DATA_EXPIRATION",this.type)).toISOString()}),"V4_0"===a&&(n={ccxVersion:"4.1.0.0",_ccx:{isDefault:!0,version:s.default.get("LOOKUP_COLLECTION_FILE_VERSION",this.type)},surfaces:{"CCX_Start_4.0_Home":{containers:[{dataType:"URL",data:o,containerAnalyticsData:{variationId:"dummy",actionBlockId:"dummy",campaignId:0,containerId:"1",controlGroupId:"",treatmentId:"dummy"}}]}},analyticsData:{responseGUID:"dummy",requestId:"dummy"},expirationDTS:new Date(Date.now()+s.default.get("DEFAULT_DATA_EXPIRATION",this.type)).toISOString()}),"V3_0"===a&&(n={ccxVersion:"3.0.1.99",_ccx:{isDefault:!0,version:s.default.get("LOOKUP_COLLECTION_FILE_VERSION",this.type)},surfaces:{"CCX_Start_3.0_Home":{containers:[{dataType:"URL",data:o,containerAnalyticsData:{variationId:"dummy",actionBlockId:"dummy",campaignId:0,containerId:"1",controlGroupId:"",treatmentId:"dummy"}}]}},analyticsData:{responseGUID:"dummy",requestId:"dummy"},expirationDTS:new Date(Date.now()+s.default.get("DEFAULT_DATA_EXPIRATION",this.type)).toISOString()}),r.setData(n,a),r}}}},function(t,e,a){"use strict";a.r(e);var s=a(5);var r={LABEL:"DISCOVER_PANEL",ANALYTICS_SUBCATEGORY:"DiscoverPanel",VULCAN_TYPE:"DiscoverPanel",LOG_PREFIX:"DiscoverPanel",LOOKUP_MAP_FILE_VERSION:1,ACTIVE_VERSIONS:["V1"],SUPPORTED_PRODUCTS:{PHXS:"22.4"},PARAMETERS_SCHEMA:{id:"discover_panel_parameters",type:"object",properties:{productCode:{type:"string"},productVersion:{type:"string"},productLanguage:{type:"string"}},required:["productCode","productVersion","productLanguage"]},V1:{SURFACES:["Discover_Panel"],PREFETCH_CLIENTS:{PHXS:"99.0"},REQUIRED_SURFACES:["Discover_Panel"]},PRIORITY_CHANNEL:s.PriorityChannels.DiscoverPanel,SURFACE_PRIORITY:{Discover_Panel:100},DEFAULT_URLS_ENABLED:!1,MINOR_VERSION_SHOULD_UPDATE_CONTENT:!1,SOPHIA_VERBOSE_FLAG_ENABLED:!0},i=a(16),o=a(19),n=a(21),c=a(1),d=a(0);function l(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,s)}return a}function u(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?l(Object(a),!0).forEach(function(e){p(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function p(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}class _ extends o.a{constructor(t,e){super(t,e),p(this,"dataManager",void 0),this.dataManager=new n.a(e.type,this._lookupMap.diskLock)}async syncDataPromises({analyticsParams:t,payload:e,surface:a,card:s,priority:r,params:i,force:o,started:n}){await this.log.context({payload:e,surfaceAnalytics:[u({surface:a},t)]}).time(async t=>{let{count:e,totalTime:c}=await this.dataManager.downloadData({modeID:a,card:s,lookupMap:this._lookupMap,priority:r,params:i,started:n,force:o});t.appendPayload({"event.url":"","event.count":e,"event.value":c/e})})}async syncData({priority:t,payload:e,params:a,progress:r=(()=>{}),force:i={type:"none"}}={}){if(!this._data)return;const o={started:[],complete:[]};let n=[];Object.keys(this._data.surfaces).forEach(l=>{n.push(c.default.waitAll((this._data.surfaces[l].containers||[]).map(async n=>{const c=new s.Priority(t);c.value+=d.default.get("SURFACE_PRIORITY",this._lookupMap.type)[l]||0,await this.syncDataPromises({analyticsParams:n.containerAnalyticsData,payload:e,surface:l,card:n,priority:c,params:a,force:i,started(){o.started.includes(l)||(o.started.push(l),r(Object.assign({},o)))}})})).then(()=>{o.started.includes(l)||o.started.push(l),o.complete.push(l),r(Object.assign({},o))}))}),await c.default.waitAll(n)}get totalItems(){return this._data&&this._data.surfaces?Object.keys(this._data.surfaces):0}async getReferencedAssets(){const t={};return this._data&&this._data.surfaces&&await c.default.waitAll(Object.keys(this._data.surfaces).map(async e=>{await c.default.waitAll((this._data.surfaces[e].containers||[]).map(async a=>{const s=await this.dataManager.getReferencedAssets(e,a);Object.assign(t,s)}))})),t}hasValidCards(t){const e=c.default.getClientContentVersion(t,this._lookupMap.type),a=d.default.get(e,this._lookupMap.type).REQUIRED_SURFACES;let s=!1;return a.forEach(t=>{this._data.surfaces&&this._data.surfaces[t]&&!this._data.surfaces[t].failedContainers||(s=!0)}),!s}}var f=a(2),h=a(18),g=a(10);a.d(e,"default",function(){return E});class E extends h.a{constructor(t){super(r),this._downloadManager=new i.default(this.type)}_createCollectionData(t){return new _(t,this)}async updateParams(t){const e=await super.updateParams(t);return e.forEach(t=>{const e=c.default.getClientContentVersion(t,this.type)||"V1";t.surfaceId=d.default.get(e,this.type).SURFACES,t.productSemver=t.productSemver||t.productVersion,t.osVersion=c.default.getOsVersion(),t.platform=c.default.getOsPlatform()}),e}_checkValidity(t,e){if(!t||!t.hasValidCards||!t.hasValidCards(e))throw new f.default(g.default.MISSING_DATA,"Failed Sophia Container")}}}]);