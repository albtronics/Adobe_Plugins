module.exports=function(t){var e={};function a(i){if(e[i])return e[i].exports;var s=e[i]={i:i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,a),s.l=!0,s.exports}return a.m=t,a.c=e,a.d=function(t,e,i){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)a.d(i,s,function(e){return t[e]}.bind(null,s));return i},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="",a(a.s=4)}([function(t,e){t.exports=require("node-fetch")},function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.isCompressed=e.setHeader=void 0;const i=a(0);e.setHeader=function(t,e,a){a?t.headers?t.headers instanceof i.Headers?t.headers.set(e,a):t.headers instanceof Array?t.headers.push([e,a]):t.headers[e]=a:t.headers={[e]:a}:t.headers instanceof i.Headers?t.headers.delete(e):t.headers instanceof Array?t.headers=t.headers.filter(t=>t[0]!==e):t.headers&&delete t.headers[e]},e.isCompressed=function(t,e){return!(!1===t.compress||!e.headers.get("Content-Encoding")||"identity"===e.headers.get("Content-Encoding").toLowerCase())}},function(t,e){t.exports=require("events")},function(t,e,a){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.Partial=void 0;const s=a(2),r=i(a(6)),n=a(0),o=a(1),d=i(a(0));class l extends s.EventEmitter{constructor(){super(...arguments),this.aborted=!1,this.offset=0,this._updatedAt=new Date,this._options={}}get range(){return this._range}get requestRange(){return this._requestRange}get pendingRange(){return{start:Math.max(this.offset,this.range.start),end:this.range.end}}trim(t){t>this.requestRange.end?t=this.requestRange.end:t<this.requestRange.start&&(t=this.requestRange.start),this._range.end=t}get response(){return this._response}fetch(t,e={},a){if(this.response)return Promise.reject(new Error("Already called. Create a new object"));if((e=Object.assign({},e)).headers=Object.assign({},e.headers||{}),this.controller=new r.default,e.signal){if(e.signal.aborted)return Promise.reject(new n.AbortError("This operation was aborted.!!"));e.signal.addEventListener("abort",()=>{this.abort()})}let i=null;if(e.timeout&&(i=setTimeout(this.controller.abort.bind(this.controller),e.timeout)),e.highWaterMark=e.highWaterMark||524288,e.signal=this.controller.signal,a){const t=`bytes=${a.start}-${a.end}`;o.setHeader(e,"Range",t),this._requestRange=a,this._range=a}return this._options=e,this._fetchPromise=d.default(t,e).then(t=>(this._requestRange||(this._requestRange={start:0,end:parseInt(t.headers.get("content-length"),10)},this._range=this._requestRange),this._response=t,t)).finally(()=>clearTimeout(i))}abort(){this.aborted=!0,this.clearLatencyTimeout(),this.controller.abort(),this.listenerCount("error")&&this.emit("error",new n.AbortError("The operation was aborted.!!"))}get fetchPromise(){return this._fetchPromise}get updatedAt(){return this._updatedAt}clearLatencyTimeout(){clearTimeout(this.latencyTimeout),this.latencyTimeout=void 0}async download(){var t,e,a;try{await this._fetchPromise}catch(t){return void this.emit("error",t)}(null===(t=this._options.signal)||void 0===t?void 0:t.aborted)&&this.abort();const i=(null===(a=null===(e=this._options)||void 0===e?void 0:e.parallel)||void 0===a?void 0:a.maxLatency)||500,s=()=>{this.emit("latency",i)};this.latencyTimeout=setTimeout(s,i);const r=o.isCompressed(this._options,this._response);if(this.response&&this.controller)return this.offset=this._range.start,this._response.body.once("error",t=>{this.aborted||(this.emit("error",t),this.clearLatencyTimeout())}).on("data",t=>{if(!this.aborted){if(this.clearLatencyTimeout(),this._updatedAt=new Date,!r&&t.length+this.offset-1>this._range.end){this.aborted=!0,this.controller.abort();const e=this._range.end-this.offset+1;return e>0&&this.emit("data",t.subarray(0,e),this.offset),this.offset=this._range.end,void this.emit("end")}this.emit("data",t,this.offset),this.offset+=t.length,this.latencyTimeout=setTimeout(s,i)}}).on("end",()=>{this.aborted||(this.clearLatencyTimeout(),this.emit("end"))}),this;this.emit("Error",new Error("Call the fetch API first"))}}e.Partial=l},function(t,e,a){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.AbortError=e.load=void 0;const s=a(0);Object.defineProperty(e,"AbortError",{enumerable:!0,get:function(){return s.AbortError}});const r=i(a(5)),n=a(7),o=a(3),d=a(1),l=(t,e)=>new Promise((a,i)=>{let s=0,r=0,n=Promise.resolve(),o=!1;const d=process.hrtime();t.on("data",(a,l)=>{if(!t.isCompressed&&t.size>0){const h=t.metadata;delete h.init.agent,delete h.init.signal;const c=process.hrtime(d);h.timestamp=1e9*c[0]+c[1];const u=JSON.stringify(h);if(u.length>10240)return void i(new Error("Too much metadata. Save failed"));let f=Buffer.from(u);const m=o;o=!o;let p=0;m?(p=r,r=u.length):(p=s,s=u.length),u.length<p&&(f=Buffer.concat([f,Buffer.alloc(p-u.length+1," ")])),n=n.then(()=>e.write(a,0,a.length,l)).then(()=>e.write(f,0,f.length,t.size+(m?10240:0))).catch(i)}else n=n.then(()=>e.write(a,0,a.length,l)).catch(i)}),t.on("end",async()=>{await n,t.size>0&&!t.isCompressed&&await e.truncate(t.size).catch(()=>{}),await e.close().catch(i),a()}),t.on("error",async t=>{await n,await e.close().catch(()=>{}),i(t)})});e.default=async function(t,e){e=e||{};const a=new o.Partial,i=await a.fetch(t,e);let s=void 0,h=new r.default;if(e.parallel){let s=void 0,r=void 0;Object.assign(i,{buffer:()=>r=r||new Promise((r,n)=>{i.file=async()=>{throw"Please use the buffer/text/json objects to get contents."},h.on("data",(t,e)=>{h.isCompressed||0===h.size?s=s?Buffer.concat([s,t]):t:(s=null!=s?s:Buffer.allocUnsafe(h.size),t.copy(s,e))}),h.on("error",n),h.on("end",()=>r(s)),h.download(t,e,a)}),async text(){var t;return null===(t=await this.buffer())||void 0===t?void 0:t.toString()},async json(){return JSON.parse(await this.text())}})}return i.emitter=h,i.file=async function(r){return this.buffer=async()=>{throw new Error("The download is being saved to the file "+r)},s=null!=s?s:(async()=>{const s=await n.promises.open(r,"w+",420),o=parseInt(a.response.headers.get("Content-Length"),10);if(!d.isCompressed(e,i)&&o>0){const t=Buffer.alloc(20480," ");await s.write(t,0,t.length,o)}const c=l(h,s);return h.download(t,e,a),await c,r})()},i},e.load=async function(t){const e=await n.promises.open(t,"r+",420);try{const a=(await e.stat()).size;let i={},s={};const n=Buffer.allocUnsafe(10240);await e.read(n,0,10240,a-20480);let o=n.toString("utf-8");try{i=JSON.parse(o)}catch(t){}await e.read(n,0,10240,a-10240),o=n.toString("utf-8");try{s=JSON.parse(o)}catch(t){}let d={};if(i.timestamp)d=i,s.timestamp&&s.timestamp>i.timestamp&&(d=s);else{if(!s.timestamp)throw"Could not load file. Metadata absent or invalid";d=s}let h,c=new r.default;return{get size(){return a-20480},get url(){return d.url},get init(){return d.init},get emitter(){return c},get headers(){return c.headers()},resume:(i,s)=>h=null!=h?h:(async()=>{const r=l(c,e);return c.resume(d,a-20480,i,s),await r,t})()}}catch(t){throw await e.close().catch(t=>{}),t}}},function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=a(2),s=a(3),r=a(1),n=a(0);class o extends i.EventEmitter{constructor(){super(...arguments),this.contentLength=0,this.partials=[],this._metadata={},this.isCompressed=!1,this._done=0,this.downloadMetadata={endCounter:0,connections:0,minimumSplitPartialSize:2097152,maxLatencyRetries:5}}get metadata(){const t=Object.assign({},this._metadata,{partials:this.partials.map(t=>t.pendingRange)});return t.init=Object.assign({},t.init),t}get size(){return this.contentLength}download(t,e,a){var i,n;const o=a.response;e=e||{},o.headers.get("eTag")?r.setHeader(e,"If-Match",o.headers.get("eTag")):o.headers.get("Date")?r.setHeader(e,"If-Unmodified-Since",o.headers.get("Date")):o.headers.get("Last-Modified")&&r.setHeader(e,"If-Unmodified-Since",o.headers.get("Last-Modified"));const d="HEAD"===e.method,l=parseInt(o.headers.get("Content-Length"),10)||0;this.contentLength=l,this._metadata.init=Object.assign({},e),d&&(this._metadata.init.method="GET"),this._metadata.acceptRanges=o.headers.get("Accept-Ranges"),this._metadata.url=t;const h=(null===(i=null==e?void 0:e.parallel)||void 0===i?void 0:i.minimumPartialSize)||2097152;let c=Math.min((null===(n=null==e?void 0:e.parallel)||void 0===n?void 0:n.maxSockets)||1,1024);0!=l&&"bytes"==o.headers.get("Accept-Ranges")||(c=1),r.isCompressed(e,a.response)&&(c=1,this.isCompressed=!0);const u=Math.min(l/h,c),f=Math.ceil(l/u);let m=0;for(;m<l;){const e=Math.min(m+f-1,l-1),i=d||0!==m?new s.Partial:a;0!==m||d?i.fetch(t,this._metadata.init,{start:m,end:e}):i.trim(e),this.partials.push(i),m=e+1}return 0===l&&d?((a=new s.Partial).fetch(t,this._metadata.init),this.partials.push(a)):0===l&&this.partials.push(a),this.downloadInternal(),this}resume(t,e,a,i){if(this._metadata=t,this._metadata.url=null!=a?a:this._metadata.url,this.contentLength=e,this._metadata.init=Object.assign({},this._metadata.init,i||{}),!this._metadata.partials)throw"No partials present. Nothing to download.";"bytes"!=this._metadata.acceptRanges&&(this._metadata.partials=[{start:0,end:e-1}]),this.metadata.partials=this.metadata.partials.filter(t=>t.start<=t.end);for(const t of this._metadata.partials){const e=new s.Partial;e.fetch(this._metadata.url,this._metadata.init,t),this.partials.push(e)}return this.downloadInternal(),this}get done(){return this._done}abort(t){this.emit("error",t);for(const t of this.partials)t.removeAllListeners(),t.addListener("error",()=>{}),t.abort()}headers(){var t,e,a;return null!==(t=this._headers)&&void 0!==t?t:null===(a=null===(e=this.partials[0])||void 0===e?void 0:e.response)||void 0===a?void 0:a.headers}switchToSingleMode(){r.setHeader(this._metadata.init,"If-Match",void 0),r.setHeader(this._metadata.init,"If-Unmodified-Since",void 0);let t=this.partials[0];t&&t.requestRange.end===this.contentLength?t.trim(this.size-1):(t=new s.Partial,t.fetch(this.metadata.url,this.metadata.init),this.downloadPartial(t));for(const e of this.partials)e!==t&&(e.removeAllListeners(),e.addListener("error",()=>{}),e.abort());this.downloadMetadata.endCounter=0,this.downloadMetadata.connections=1,this.partials=[t]}downloadPartial(t){var e;t.once("latency",()=>{var e,a,i;if(this._metadata.pendingLatencyRetries=this._metadata.pendingLatencyRetries||0,this._metadata.pendingLatencyRetries++,this._metadata.pendingLatencyRetries>=this.downloadMetadata.maxLatencyRetries){if(!1===(null===(i=null===(a=null===(e=this.metadata)||void 0===e?void 0:e.init)||void 0===a?void 0:a.parallel)||void 0===i?void 0:i.exitOnLatency))return;return void this.abort(new Error("Parallel Fetch: Server Hung. We are done with latency waits"))}const r=new s.Partial;r.fetch(this.metadata.url,this.metadata.init,t.pendingRange),this.downloadPartial(r),this.partials[this.partials.indexOf(t)]=r,t.removeAllListeners(),t.addListener("error",()=>{}),t.abort()}),(null===(e=t.requestRange)||void 0===e?void 0:e.start)&&t.fetchPromise.then(t=>t.ok?206===t.status&&t.headers.get("Content-Range")?void 0:process.nextTick(()=>this.switchToSingleMode()):412===t.status?process.nextTick(()=>this.switchToSingleMode()):this.abort(new Error("Failed to get an inner partial with status code "+t.status))).catch(()=>{}),t.on("error",t=>{this.abort(t)}).on("data",(e,a)=>{var i,s;this._headers=null!==(i=this._headers)&&void 0!==i?i:t.response.headers,0===this._done&&(this._done=this.size?this.size-this.partials.map(t=>t.range.end-t.range.start).reduce((t,e)=>t+e):null===(s=this.partials[0])||void 0===s?void 0:s.range.start),this._done+=e.length,this.emit("data",e,a);const r={done:this.done};this.size&&(r.total=this.size),this.emit("progress",r)}).on("end",()=>{const e=this.partials.map(t=>({c:t.pendingRange.end-t.pendingRange.start,p:t})).reduce((t,e)=>t.c>e.c?t:e);if(e.c>this.downloadMetadata.minimumSplitPartialSize){const a=Math.ceil(e.c/2)+e.p.pendingRange.start,i=e.p.pendingRange.end,r=new s.Partial;r.fetch(this.metadata.url,this.metadata.init,{start:a,end:i}),this.downloadPartial(r),this.partials[this.partials.indexOf(t)]=r,t.removeAllListeners(),e.p.trim(a-1)}else this.partials=this.partials.filter(e=>e!==t),++this.downloadMetadata.endCounter===this.downloadMetadata.connections&&this.emit("end")}),t.download()}downloadInternal(){var t,e,a,i,s,r,o,d,l;if(null===(e=null===(t=this.metadata.init)||void 0===t?void 0:t.signal)||void 0===e?void 0:e.aborted)this.abort(new n.AbortError("This operation was aborted.!!"));else{this._done=0,this.downloadMetadata.connections=this.partials.length,this.downloadMetadata.minimumSplitPartialSize=2*((null===(i=null===(a=this.metadata.init)||void 0===a?void 0:a.parallel)||void 0===i?void 0:i.minimumPartialSize)||2097152),this.downloadMetadata.maxLatencyRetries=(null===(r=null===(s=this.metadata.init)||void 0===s?void 0:s.parallel)||void 0===r?void 0:r.maxLatencyRetries)||5,this._headers=null!==(o=this._headers)&&void 0!==o?o:null===(l=null===(d=this.partials[0])||void 0===d?void 0:d.response)||void 0===l?void 0:l.headers;for(const t of this.partials)this.downloadPartial(t)}}}e.default=o},function(t,e){t.exports=require("abort-controller")},function(t,e){t.exports=require("fs")}]);
//# sourceMappingURL=index.js.map